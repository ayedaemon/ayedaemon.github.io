<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Eudyptula Task 6 | Connected</title>
<meta name=keywords content="Eudyptula,linux"><meta name=description content="Task 6 for Eudyptula challenge"><meta name=author content="ayedaemon"><link rel=canonical href=https://ayedaemon.github.io/post/2022/09/eudyptula-task-6/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://ayedaemon.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ayedaemon.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ayedaemon.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ayedaemon.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ayedaemon.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Eudyptula Task 6"><meta property="og:description" content="Task 6 for Eudyptula challenge"><meta property="og:type" content="article"><meta property="og:url" content="https://ayedaemon.github.io/post/2022/09/eudyptula-task-6/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-09-18T13:57:01+05:30"><meta property="article:modified_time" content="2023-11-07T00:11:41+05:30"><meta property="og:site_name" content="Connected"><meta property="og:see_also" content="https://ayedaemon.github.io/post/2023/05/eudyptula-task-7/"><meta property="og:see_also" content="https://ayedaemon.github.io/post/2022/06/eudyptula-task-5/"><meta property="og:see_also" content="https://ayedaemon.github.io/post/2022/06/eudyptula-task-4/"><meta property="og:see_also" content="https://ayedaemon.github.io/post/2022/06/eudyptula-task-3/"><meta property="og:see_also" content="https://ayedaemon.github.io/post/2022/06/eudyptula-task-2/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Eudyptula Task 6"><meta name=twitter:description content="Task 6 for Eudyptula challenge"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ayedaemon.github.io/post/"},{"@type":"ListItem","position":2,"name":"Eudyptula Task 6","item":"https://ayedaemon.github.io/post/2022/09/eudyptula-task-6/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Eudyptula Task 6","name":"Eudyptula Task 6","description":"Task 6 for Eudyptula challenge","keywords":["Eudyptula","linux"],"articleBody":"This is Task 06 of the Eudyptula Challenge ------------------------------------------ Nice job with the module loading macros, those are tricky, but a very valuable skill to know about, especially when running across them in real kernel code. Speaking of real kernel code, let's write some! The task this time is this: - Take the kernel module you wrote for task 01, and modify it to be a misc char device driver. The misc interface is a very simple way to be able to create a character device, without having to worry about all of the sysfs and character device registration mess. And what a mess it is, so stick to the simple interfaces wherever possible. - The misc device should be created with a dynamic minor number, no need running off and trying to reserve a real minor number for your test module, that would be crazy. - The misc device should implement the read and write functions. - The misc device node should show up in /dev/eudyptula. - When the character device node is read from, your assigned id is returned to the caller. - When the character device node is written to, the data sent to the kernel needs to be checked. If it matches your assigned id, then return a correct write return value. If the value does not match your assigned id, return the \"invalid value\" error value. - The misc device should be registered when your module is loaded, and unregistered when it is unloaded. - Provide some \"proof\" this all works properly. Device drivers?? When a user adds a new part to a computer system, such a printer, the computer doesnâ€™t immediately understand how to connect with it and identify it. This requires some sort of translator that can mediate between the component and our operating system/Computer. These translators are called device drivers. The operating system and other software are typically instructed on how to interface with another piece of hardware by device drivers, which are typically extremely small pieces of software.\nFor example, In some laptops there is a dedicated CAPSLOCK LED, which toggles to indicate the state of the key itself. It seems like a really easy and straightforward concept. A key and a led are there; when the key is pressed, the led toggles; when the key is pressed again, the led toggles once more. However, There is lot more going on than what meets the eye.\nWhen the CAPSLOCK key is pressed, userspace application that connects with the relevant mediator/translator and transmits the message to it. The translator then manages this message, analyses it, and then executes some operations on the associated hardware device (LED).\nâ”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”Œ â”‚ â”‚ â”‚ â”” â”€ â”Œ â”‚ â”‚ â”‚ â”” â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ D â”€ â”€ â”€ â”€ â”€ â”€ e â”€ â”€ â”Œ â”‚ â”” â”€ P â”€ â”€ â”€ v â”€ â”€ â”€ â”€ â”€ r â”€ â”€ â”€ i â”€ â”€ â”€ â”€ â”€ o â”€ â”€ â”€ c â”€ â”€ â”€ â”€ â”€ g â”€ â”€ â”€ e â”€ â”€ â”€ L â”€ â”€ r â”¬ â”‚ â”‚ â”¼ â”‚ â”‚ â–¼ â”¬ â”‚ â”‚ â”¼ â”‚ â–¼ E â”€ â”€ a â”€ â”€ â”€ D â”€ â”€ â”€ D â”€ â”€ m â”€ â”€ â”€ r â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ i â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ v â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ e â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ r â”€ â”€ â” â”‚ â”˜ â”€ â”€ â”€ â”€ â”€ â”€ â” â”‚ â”‚ â”‚ â”˜ â”€ â”€ â”€ â”€ â”€ â” â”‚ â”‚ â”‚ â”˜ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ U â”€ â”€ H S â”€ K â”€ A E E R R R D S N W P E A A L R C E E Now we know what are device drivers and how do they fit in the bigger picture. But thatâ€™s not all!\nIn linux, these device drivers are usually implemented as kernel modules, that provides an interface between the actual hardare device and the userspace â€œfilesâ€. On the basis of speed, volume and way of organizing the data to be transfered from userspace to the device and vice versa, device drivers are categorized under 2 types. (Note:- There is one more type of device called network device, but for this article itâ€™s better to not start discussing about those)\nCharacter devices (Slow and manages small amount of data; used for keyboards, mouse, etc) Block devices (Fast and can manage bulk data with ease and efficiency; used mainly for storage devices) A typical linux ls -l command gives us a lot of information about the kind of device each file is.\nls -l /dev ## Output (snipped) # lrwxrwxrwx 1 root root 3 Sep 16 19:56 cdrom -\u003e sr0 # brw-rw---- 1 root disk 8,0 Sep 16 19:56 sda # brw-rw---- 1 root disk 8,1 Sep 16 19:56 sda1 # brw-rw---- 1 root disk 8,2 Sep 16 19:56 sda2 # brw-rw----+ 1 root optical 11,0 Sep 16 19:56 sr0 # crw--w---- 1 root tty 4,0 Sep 16 19:56 tty0 # crw-rw-rw- 1 root root 1,5 Sep 16 19:56 zero First character of each line from the above output gives the type of the file it is, for example:\nl indicates that the file is a link file. b is the indicator for block device. c is for the character device. Another important thing this gives out are unique identifiers associated with each device. These identifiers consists of two comma separated numbers - major number and minor number.\nMajor number tells about the driver associated with the device. In the output above, sda, sda1 and sda2 all are managed by driver 8. The kernel uses the major number at open time to dispatch execution to the appropriate driver. While the minor number is used by driver (specified by major number) to differentiate among multiple devices handled by the driver.\nIf you wish to read more about this, here is a good article about major and minor numbers.1\nAt this point we can take a guess that these numbers are not random numbers, but they have a meaning to it. Here 2 is the official registry of allocated devices numbers which we will have to keep in mind before writing a device driver.\nWhat is a misc char device driver?? Well, itâ€™s quite clear, isnâ€™t it? A Misc driver is a driver that is used for miscellaneous devices. ğŸ¤­ğŸ¤­\nThey mostly behave like a char drivers, but they are unique in that we donâ€™t need to worry about all the complicated number registration issues. We can simply write our driver module and assign it a static minor number or ask kernel to provide a dynamic minor number. All the misc devices have common major number 10. And just like char device, it supports all the file operation calls like open, read, write, close and IOCTL.\nThis is quite useful when we want to write a basic driver for a simple functionality and save ourselves from the mess of allocating and registering a major number.\nYour first misc char device driver In linux kernel source, struct miscdevice is defined in linux/miscdevice.h file\nstruct miscdevice { int minor; const char *name; const struct file_operations *fops; struct list_head list; struct device *parent; struct device *this_device; const struct attribute_group **groups; const char *nodename; umode_t mode; }; For this task, we will need only 3 members of the above struct.\nint minor: To allocate the minor number, either static or dynamic. const char *name: To give the name to the device. const struct file_operations *fops : To allow custom file operations like read and write. This will allow us to write a basic module that will work as misc device driver that can be loaded and unloaded from the kernel. Create a file with name misc_char_device_driver.c and paste the below code in that.\n#include #include #include #include // message formatting - optional #define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt // Device name #define MISC_DEVICE_NAME \"eudyptula\" // Misc Device structure static struct miscdevice my_misc_device = { .minor = MISC_DYNAMIC_MINOR, .name = MISC_DEVICE_NAME, }; // Entry point static int hello_world_init(void) { int ret = misc_register(\u0026my_misc_device); pr_info(\"Hello from module; Return %d\\n\", ret); if (ret \u003c 0) return -EFAULT; return 0; } // Exit point static void hello_world_exit(void) { misc_deregister(\u0026my_misc_device); pr_info(\"Exiting from module\\n\"); } module_init(hello_world_init); module_exit(hello_world_exit); MODULE_LICENSE(\"GPL\"); MODULE_AUTHOR(\"ayedaemon\"); MODULE_DESCRIPTION(\"Eudyptula task6\"); Compile and load module using below Makefile\nKDIR := /lib/modules/$(shell uname -r)/build all: clean build install build: $(MAKE) -C $(KDIR) M=$(PWD) modules clean: uninstall $(MAKE) -C $(KDIR) M=$(PWD) clean install: - sudo insmod misc_char_device_driver.ko sudo lsmod | grep misc_char_device_driver uninstall: - sudo rmmod misc_char_device_driver After compiling the above module and loading it, this will give me a character device in the /dev/ directory.\ncrw------- 1 root root 10, 122 Sep 17 13:21 /dev/eudyptula We can see that the file is a character type because of the initial c indicator. Also the major number is 10, which is the common major number for all misc devices. The minor number in our case is random but if you want feel free to allocate a static one.\nWhen loading and unloading this module, itâ€™ll also create some logs because of the pr_info function calls. These logs can be viewed via dmesg | grep misc_char_device_driver command.\n[17543.585039] misc_char_device_driver: Hello from module; Return 0 [17583.624421] misc_char_device_driver: Exiting from module Adding file operations to driver Now we have a working character device that just exists but it does not support any file operations at this point. We can add the required file operations using the const struct file_operations *fops member of struct miscdevice. In linux kernel, struct file_operations is defined at linux/fs.h file. There are many file operations that are supported but we only need read and write for now.\nOur new code will look something like this\n// SPDX-License-Identifier: GPL-2.0+ #include #include #include #include #include // message formatting #define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt // Device name #define MISC_DEVICE_NAME \"eudyptula\" // Custom read operation static ssize_t misc_read(struct file *filp, char __user *buff, size_t cnt, loff_t *offt) { pr_info(\"Read operation performed\\n\"); return cnt; } // Custom write operation static ssize_t misc_write(struct file *filp, const char __user *buff, size_t cnt, loff_t *offt) { pr_info(\"Write operation performed\\n\"); return cnt; } // Operations structure const struct file_operations misc_fops = { .read = misc_read, .write = misc_write, }; // Misc Device structure static struct miscdevice my_misc_device = { .minor = MISC_DYNAMIC_MINOR, .name = MISC_DEVICE_NAME, .fops = \u0026misc_fops, }; // Entry point static int hello_world_init(void) { int ret = misc_register(\u0026my_misc_device); pr_info(\"Hello from module; Return %d\\n\", ret); if (ret \u003c 0) return -EFAULT; return 0; } // Exit point static void hello_world_exit(void) { misc_deregister(\u0026my_misc_device); pr_info(\"Exiting from module\\n\"); } module_init(hello_world_init); module_exit(hello_world_exit); MODULE_LICENSE(\"GPL\"); MODULE_AUTHOR(\"ayedaemon\"); MODULE_DESCRIPTION(\"Eudyptula task6\"); After compiling the above module and loading it, this will provide additional functionality of read and write on the device. This can be tested by reading and writing to the /dev/eudyptula device now.\n## Read operation dd if=/dev/eudyptula of=/dev/null count=1 ## Output in `dmesg` # [23375.547714] misc_char_device_driver: Read operation performed ## Write operation dd if=/dev/zero of=/dev/eudyptula count=1 ## Output in `dmesg` # [23353.947901] misc_char_device_driver: Write operation performed Userspace \u003câ€“[data]â€“\u003e kernel module Now itâ€™s time for the ultimate move, we have a misc character device driver that supports read and write operations to it, but it actually doesnâ€™t send any data from kernel to userland and vice-versa. This is because there is no shared memory where we can simply pass the variables or pointers to the location and do whatever we intend to do it.\nThings are a bit different when have to transfer data between a kernel layer and userspace. Complete explaination is out of the scope for this article, but the short version is that the transfer is done with the help of 2 buffers, one on the kernel and other on the userspace. The userspace programs fill data in their buffer and address to that buffer is passed to the kernel. The kernel then uses that buffer to copy data to itâ€™s own buffer and with that we are done. Here is a stackoverflow thread on the same topic.\nBut we need not to worry about all this complexity, for us itâ€™ll be as hard as calling the copy_from_user() 3 and copy_to_user() 4 function from our kernel module.\nWith this, our new read and write functions will look something like below:-\n// Custom read operation static ssize_t misc_read(struct file *filp, char __user *buff, size_t cnt, loff_t *offt) { char *my_id = \"ayedaemon\\n\"; int my_id_len = strlen(my_id)+1; pr_info(\"[begin] offt=%ld\\n\", *offt); if (*offt != 0) return 0; if ((cnt \u003c my_id_len) || // Check the size (copy_to_user(buff, my_id, my_id_len))) // Copy to buffer return -EINVAL; *offt += cnt; pr_info(\"[ end ] offt=%ld\\n\", *offt); return cnt; } // Custom write operation static ssize_t misc_write(struct file *filp, const char __user *buff, size_t cnt, loff_t *offt) { char *my_id = \"ayedaemon\"; int my_id_len = strlen(my_id); char temp[my_id_len+1]; // size = 10; including the null byte if ((cnt != my_id_len+1) || // Check input size (mainly to prevent overflows) (copy_from_user(temp, buff, my_id_len)) || // Copy 9 bytes from userland (strncmp(temp, my_id, my_id_len))) // finally, compare 9 bytes return -EINVAL; else return cnt; } In the above code, read function first checks the size of the buffer and then copies the my_id value to userspace buffer. And in write function, we check input size, then copies the data from userspace to temp buffer and then compares the data to be same. There are other things in the code but those are for extra checks, just to make sure the module does not crash.\nWe can now test the code with our makefile and everything should be as we are expecting it to be.\n## Read the value from device cat /dev/eudyptula ## Output # ayedaemon #-=-=-=-=-=-=-=-=-=-=-=-=-=-= ## Write \"ayedaemon\" to the device echo \"ayedaemon\" \u003e /dev/eudyptula ## Output - No output #-=-=-=-=-=-=-=-=-=-=-=-=-=-= ## Write anything apart from \"ayedaemon\" echo \"something\" \u003e /dev/eudyptula ## Output - Gives error # bash: echo: write error: Invalid argument Now we have achieved the goal of this task, letâ€™s check the formatting of the code so that it follows the proper coding conventions that linux kernels developers have set.\n./linux/scripts/checkpatch.pl -f misc_char_device_driver.c ## Output # total: 0 errors, 0 warnings, 99 lines checked # misc_char_device_driver.c has no obvious style problems and is ready for submission. Conclusion There are mainly 2 types of device drivers - character and block. But there are also network device drivers which are completely different from the ones we discussed here. This article tries to provide basic introduction to misc character devices and details about how to write your own driver. All the code can be found in the github repo here 5 for you to playaround.\nhttps://www.oreilly.com/library/view/linux-device-drivers/0596000081/ch03s02.htmlÂ â†©ï¸\nhttps://www.kernel.org/doc/html/latest/admin-guide/devices.htmlÂ â†©ï¸\nhttps://www.kernel.org/doc/htmldocs/kernel-api/API---copy-from-user.htmlÂ â†©ï¸\nhttps://www.kernel.org/doc/htmldocs/kernel-api/API---copy-to-user.htmlÂ â†©ï¸\nhttps://github.com/ayedaemon/eudyptulaÂ â†©ï¸\n","wordCount":"2534","inLanguage":"en","datePublished":"2022-09-18T13:57:01+05:30","dateModified":"2023-11-07T00:11:41+05:30","author":[{"@type":"Person","name":"ayedaemon"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://ayedaemon.github.io/post/2022/09/eudyptula-task-6/"},"publisher":{"@type":"Organization","name":"Connected","logo":{"@type":"ImageObject","url":"https://ayedaemon.github.io/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://ayedaemon.github.io/ accesskey=h title="Connected (Alt + H)">Connected</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://ayedaemon.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://ayedaemon.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://ayedaemon.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://ayedaemon.github.io/series/ title=Series><span>Series</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ayedaemon.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://ayedaemon.github.io/post/>Posts</a></div><h1 class=post-title>Eudyptula Task 6</h1><div class=post-description>Task 6 for Eudyptula challenge</div><div class=post-meta><span title='2022-09-18 13:57:01 +0530 +0530'>September 18, 2022</span>&nbsp;Â·&nbsp;12 min&nbsp;Â·&nbsp;2534 words&nbsp;Â·&nbsp;ayedaemon&nbsp;|&nbsp;<a href=https://github.com/ayedaemon/ayedaemon.github.io/tree/main/content/post/2022/09/eudyptula-task-6.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#device-drivers>Device drivers??</a></li><li><a href=#what-is-a-misc-char-device-driver>What is a misc char device driver??</a></li><li><a href=#conclusion>Conclusion</a></li></ul></li></ul></nav></div></details></div><div class=post-content><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>This is Task 06 of the Eudyptula Challenge
</span></span><span class=line><span class=cl>------------------------------------------
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Nice job with the module loading macros, those are tricky, but a very
</span></span><span class=line><span class=cl>valuable skill to know about, especially when running across them in
</span></span><span class=line><span class=cl>real kernel code.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Speaking of real kernel code, let&#39;s write some!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>The task this time is this:
</span></span><span class=line><span class=cl>  - Take the kernel module you wrote for task 01, and modify it to be a
</span></span><span class=line><span class=cl>    misc char device driver.  The misc interface is a very simple way to
</span></span><span class=line><span class=cl>    be able to create a character device, without having to worry about
</span></span><span class=line><span class=cl>    all of the sysfs and character device registration mess.  And what a
</span></span><span class=line><span class=cl>    mess it is, so stick to the simple interfaces wherever possible.
</span></span><span class=line><span class=cl>  - The misc device should be created with a dynamic minor number, no
</span></span><span class=line><span class=cl>    need running off and trying to reserve a real minor number for your
</span></span><span class=line><span class=cl>    test module, that would be crazy.
</span></span><span class=line><span class=cl>  - The misc device should implement the read and write functions.
</span></span><span class=line><span class=cl>  - The misc device node should show up in /dev/eudyptula.
</span></span><span class=line><span class=cl>  - When the character device node is read from, your assigned id is
</span></span><span class=line><span class=cl>    returned to the caller.
</span></span><span class=line><span class=cl>  - When the character device node is written to, the data sent to the
</span></span><span class=line><span class=cl>    kernel needs to be checked.  If it matches your assigned id, then
</span></span><span class=line><span class=cl>    return a correct write return value.  If the value does not match
</span></span><span class=line><span class=cl>    your assigned id, return the &#34;invalid value&#34; error value.
</span></span><span class=line><span class=cl>  - The misc device should be registered when your module is loaded, and
</span></span><span class=line><span class=cl>    unregistered when it is unloaded.
</span></span><span class=line><span class=cl>  - Provide some &#34;proof&#34; this all works properly.
</span></span></code></pre></div><h3 id=device-drivers>Device drivers??<a hidden class=anchor aria-hidden=true href=#device-drivers>#</a></h3><p>When a user adds a new part to a computer system, such a printer, the computer doesn&rsquo;t immediately understand how to connect with it and identify it. This requires some sort of translator that can mediate between the component and our operating system/Computer. These translators are called <strong>device drivers</strong>. The operating system and other software are typically instructed on how to interface with another piece of hardware by device drivers, which are typically extremely small pieces of software.</p><p>For example, In some laptops there is a dedicated <em>CAPSLOCK</em> LED, which toggles to indicate the state of the key itself. It seems like a really easy and straightforward concept. A key and a led are there; when the key is pressed, the led toggles; when the key is pressed again, the led toggles once more. However, There is lot more going on than what meets the eye.</p><p>When the <em>CAPSLOCK</em> key is pressed, userspace application that connects with the relevant mediator/translator and transmits the message to it. The translator then manages this message, analyses it, and then executes some operations on the associated hardware device (LED).</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 432 377"><g transform="translate(8,16)"><text text-anchor="middle" x="24" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="24" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="32" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="32" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="40" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="40" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="48" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="48" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="56" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="56" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="64" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="64" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="72" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="72" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="80" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="80" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="88" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="88" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="96" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="96" y="180" fill="currentcolor" style="font-size:1em">â”Œ</text><text text-anchor="middle" x="96" y="196" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="96" y="212" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="96" y="228" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="96" y="244" fill="currentcolor" style="font-size:1em">â””</text><text text-anchor="middle" x="96" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="104" y="20" fill="currentcolor" style="font-size:1em">â”Œ</text><text text-anchor="middle" x="104" y="36" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="104" y="52" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="104" y="68" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="104" y="84" fill="currentcolor" style="font-size:1em">â””</text><text text-anchor="middle" x="104" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="104" y="180" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="104" y="244" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="104" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="112" y="20" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="112" y="84" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="112" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="112" y="180" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="112" y="244" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="112" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="120" y="20" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="120" y="84" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="120" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="120" y="180" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="120" y="212" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="120" y="244" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="120" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="128" y="20" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="128" y="84" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="128" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="128" y="180" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="128" y="212" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="128" y="244" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="128" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="128" y="324" fill="currentcolor" style="font-size:1em">â”Œ</text><text text-anchor="middle" x="128" y="340" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="128" y="356" fill="currentcolor" style="font-size:1em">â””</text><text text-anchor="middle" x="136" y="20" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="136" y="52" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="136" y="84" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="136" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="136" y="180" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="136" y="212" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="136" y="244" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="136" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="136" y="324" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="136" y="356" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="144" y="20" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="144" y="52" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="144" y="84" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="144" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="144" y="180" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="144" y="212" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="144" y="244" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="144" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="144" y="324" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="144" y="356" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="152" y="20" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="152" y="52" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="152" y="84" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="152" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="152" y="180" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="152" y="212" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="152" y="244" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="152" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="152" y="324" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="152" y="356" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="160" y="20" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="160" y="52" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="160" y="84" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="160" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="160" y="180" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="160" y="212" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="160" y="244" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="160" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="160" y="324" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="160" y="340" fill="currentcolor" style="font-size:1em">L</text><text text-anchor="middle" x="160" y="356" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="168" y="20" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="168" y="52" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="168" y="84" fill="currentcolor" style="font-size:1em">â”¬</text><text text-anchor="middle" x="168" y="100" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="168" y="116" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="168" y="132" fill="currentcolor" style="font-size:1em">â”¼</text><text text-anchor="middle" x="168" y="148" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="168" y="164" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="168" y="180" fill="currentcolor" style="font-size:1em">â–¼</text><text text-anchor="middle" x="168" y="244" fill="currentcolor" style="font-size:1em">â”¬</text><text text-anchor="middle" x="168" y="260" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="168" y="276" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="168" y="292" fill="currentcolor" style="font-size:1em">â”¼</text><text text-anchor="middle" x="168" y="308" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="168" y="324" fill="currentcolor" style="font-size:1em">â–¼</text><text text-anchor="middle" x="168" y="340" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="168" y="356" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="176" y="20" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="176" y="52" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="176" y="84" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="176" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="176" y="180" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="176" y="212" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="176" y="244" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="176" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="176" y="324" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="176" y="340" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="176" y="356" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="184" y="20" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="184" y="52" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="184" y="84" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="184" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="184" y="180" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="184" y="212" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="184" y="244" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="184" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="184" y="324" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="184" y="356" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="192" y="20" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="192" y="84" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="192" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="192" y="180" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="192" y="212" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="192" y="244" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="192" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="192" y="324" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="192" y="356" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="200" y="20" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="200" y="84" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="200" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="200" y="180" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="200" y="212" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="200" y="244" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="200" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="200" y="324" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="200" y="356" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="208" y="20" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="208" y="84" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="208" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="208" y="180" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="208" y="212" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="208" y="244" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="208" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="208" y="324" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="208" y="356" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="216" y="20" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="216" y="84" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="216" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="216" y="180" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="216" y="212" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="216" y="244" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="216" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="216" y="324" fill="currentcolor" style="font-size:1em">â”</text><text text-anchor="middle" x="216" y="340" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="216" y="356" fill="currentcolor" style="font-size:1em">â”˜</text><text text-anchor="middle" x="224" y="20" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="224" y="84" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="224" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="224" y="180" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="224" y="244" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="224" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="232" y="20" fill="currentcolor" style="font-size:1em">â”</text><text text-anchor="middle" x="232" y="36" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="232" y="52" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="232" y="68" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="232" y="84" fill="currentcolor" style="font-size:1em">â”˜</text><text text-anchor="middle" x="232" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="232" y="180" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="232" y="244" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="232" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="240" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="240" y="180" fill="currentcolor" style="font-size:1em">â”</text><text text-anchor="middle" x="240" y="196" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="240" y="212" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="240" y="228" fill="currentcolor" style="font-size:1em">â”‚</text><text text-anchor="middle" x="240" y="244" fill="currentcolor" style="font-size:1em">â”˜</text><text text-anchor="middle" x="240" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="248" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="248" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="256" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="256" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="264" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="264" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="272" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="272" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="280" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="280" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="288" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="288" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="296" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="296" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="304" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="304" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="312" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="312" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="320" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="320" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="328" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="328" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="336" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="336" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="344" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="344" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="352" y="52" fill="currentcolor" style="font-size:1em">U</text><text text-anchor="middle" x="352" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="352" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="352" y="340" fill="currentcolor" style="font-size:1em">H</text><text text-anchor="middle" x="360" y="52" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="360" y="132" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="360" y="212" fill="currentcolor" style="font-size:1em">K</text><text text-anchor="middle" x="360" y="292" fill="currentcolor" style="font-size:1em">â”€</text><text text-anchor="middle" x="360" y="340" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="368" y="52" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="368" y="212" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="368" y="340" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="376" y="52" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="376" y="212" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="376" y="340" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="384" y="52" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="384" y="212" fill="currentcolor" style="font-size:1em">N</text><text text-anchor="middle" x="384" y="340" fill="currentcolor" style="font-size:1em">W</text><text text-anchor="middle" x="392" y="52" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="392" y="212" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="392" y="340" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="400" y="52" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="400" y="212" fill="currentcolor" style="font-size:1em">L</text><text text-anchor="middle" x="400" y="340" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="408" y="52" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="408" y="340" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="416" y="52" fill="currentcolor" style="font-size:1em">E</text></g></svg></div><p>Now we know what are device drivers and how do they fit in the bigger picture. But that&rsquo;s not all!</p><p>In linux, these device drivers are usually implemented as kernel modules, that provides an interface between the actual hardare device and the userspace &ldquo;<a href=https://www.kernel.org/doc/html/latest/filesystems/vfs.html>files</a>&rdquo;. On the basis of speed, volume and way of organizing the data to be transfered from userspace to the device and vice versa, device drivers are categorized under 2 types. <em>(Note:- There is one more type of device called network device, but for this article it&rsquo;s better to not start discussing about those)</em></p><ol><li>Character devices (Slow and manages small amount of data; used for keyboards, mouse, etc)</li><li>Block devices (Fast and can manage bulk data with ease and efficiency; used mainly for storage devices)</li></ol><p>A typical linux <code>ls -l</code> command gives us a lot of information about the kind of device each file is.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ls -l /dev
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Output (snipped)</span>
</span></span><span class=line><span class=cl><span class=c1># lrwxrwxrwx  1 root root          3    Sep 16 19:56 cdrom -&gt; sr0</span>
</span></span><span class=line><span class=cl><span class=c1># brw-rw----  1 root disk        8,0    Sep 16 19:56 sda</span>
</span></span><span class=line><span class=cl><span class=c1># brw-rw----  1 root disk        8,1    Sep 16 19:56 sda1</span>
</span></span><span class=line><span class=cl><span class=c1># brw-rw----  1 root disk        8,2    Sep 16 19:56 sda2</span>
</span></span><span class=line><span class=cl><span class=c1># brw-rw----+ 1 root optical    11,0    Sep 16 19:56 sr0</span>
</span></span><span class=line><span class=cl><span class=c1># crw--w----  1 root tty         4,0    Sep 16 19:56 tty0</span>
</span></span><span class=line><span class=cl><span class=c1># crw-rw-rw-  1 root root        1,5    Sep 16 19:56 zero</span>
</span></span></code></pre></div><p>First character of each line from the above output gives the type of the file it is, for example:</p><ul><li><code>l</code> indicates that the file is a link file.</li><li><code>b</code> is the indicator for block device.</li><li><code>c</code> is for the character device.</li></ul><p>Another important thing this gives out are unique identifiers associated with each device. These identifiers consists of <strong>two comma separated numbers</strong> - <code>major number</code> and <code>minor number</code>.</p><p>Major number tells about the driver associated with the device. In the output above, <code>sda</code>, <code>sda1</code> and <code>sda2</code> all are managed by driver <code>8</code>. The kernel uses the major number at open time to dispatch execution to the appropriate driver. While the minor number is used by driver (specified by major number) to differentiate among multiple devices handled by the driver.</p><p>If you wish to read more about this, here is a <a href=https://www.oreilly.com/library/view/linux-device-drivers/0596000081/ch03s02.html>good article about major and minor numbers.</a><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>At this point we can take a guess that these numbers are not random numbers, but they have a meaning to it. <a href=https://www.kernel.org/doc/html/latest/admin-guide/devices.html>Here</a> <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> is the official registry of allocated devices numbers which we will have to keep in mind before writing a device driver.</p><h3 id=what-is-a-misc-char-device-driver>What is a misc char device driver??<a hidden class=anchor aria-hidden=true href=#what-is-a-misc-char-device-driver>#</a></h3><p>Well, it&rsquo;s quite clear, isn&rsquo;t it? A Misc driver is a driver that is used for miscellaneous devices. ğŸ¤­ğŸ¤­</p><p>They mostly behave like a char drivers, but they are unique in that we don&rsquo;t need to worry about all the complicated number registration issues. We can simply write our driver module and assign it a static minor number or ask kernel to provide a dynamic minor number. All the misc devices have common major number <code>10</code>. And just like char device, it supports all the file operation calls like open, read, write, close and IOCTL.</p><p>This is quite useful when we want to write a basic driver for a simple functionality and save ourselves from the mess of allocating and registering a major number.</p><h4 id=your-first-misc-char-device-driver>Your first misc char device driver<a hidden class=anchor aria-hidden=true href=#your-first-misc-char-device-driver>#</a></h4><p>In linux kernel source, <code>struct miscdevice</code> is defined in <a href=https://elixir.bootlin.com/linux/latest/source/include/linux/miscdevice.h#L79><code>linux/miscdevice.h</code> file</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>miscdevice</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>minor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=k>struct</span> <span class=n>file_operations</span> <span class=o>*</span><span class=n>fops</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>list_head</span> <span class=n>list</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>device</span> <span class=o>*</span><span class=n>parent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>device</span> <span class=o>*</span><span class=n>this_device</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=k>struct</span> <span class=n>attribute_group</span> <span class=o>**</span><span class=n>groups</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>nodename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>umode_t</span> <span class=n>mode</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>For this task, we will need only 3 members of the above struct.</p><ol><li><code>int minor</code>: To allocate the minor number, either static or dynamic.</li><li><code>const char *name</code>: To give the name to the device.</li><li><code>const struct file_operations *fops</code> : To allow custom file operations like read and write.</li></ol><p>This will allow us to write a basic module that will work as misc device driver that can be loaded and unloaded from the kernel. Create a file with name <code>misc_char_device_driver.c</code> and paste the below code in that.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/miscdevice.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/module.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/init.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/kernel.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// message formatting - optional
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define pr_fmt(fmt) KBUILD_MODNAME &#34;: &#34; fmt
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// Device name
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define MISC_DEVICE_NAME &#34;eudyptula&#34;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Misc Device structure
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=k>struct</span> <span class=n>miscdevice</span> <span class=n>my_misc_device</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=n>minor</span> <span class=o>=</span> <span class=n>MISC_DYNAMIC_MINOR</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>MISC_DEVICE_NAME</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Entry point
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>int</span> <span class=nf>hello_world_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>ret</span> <span class=o>=</span> <span class=nf>misc_register</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_misc_device</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>pr_info</span><span class=p>(</span><span class=s>&#34;Hello from module; Return %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=o>-</span><span class=n>EFAULT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Exit point
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>void</span> <span class=nf>hello_world_exit</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>misc_deregister</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_misc_device</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>pr_info</span><span class=p>(</span><span class=s>&#34;Exiting from module</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>module_init</span><span class=p>(</span><span class=n>hello_world_init</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>module_exit</span><span class=p>(</span><span class=n>hello_world_exit</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>MODULE_LICENSE</span><span class=p>(</span><span class=s>&#34;GPL&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>MODULE_AUTHOR</span><span class=p>(</span><span class=s>&#34;ayedaemon&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>MODULE_DESCRIPTION</span><span class=p>(</span><span class=s>&#34;Eudyptula task6&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>Compile and load module using below <code>Makefile</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>KDIR</span> <span class=o>:=</span> /lib/modules/<span class=k>$(</span>shell uname -r<span class=k>)</span>/build
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> <span class=n>clean</span> <span class=n>build</span> <span class=n>install</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>build</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>$(</span>MAKE<span class=k>)</span> -C <span class=k>$(</span>KDIR<span class=k>)</span> <span class=nv>M</span><span class=o>=</span><span class=k>$(</span>PWD<span class=k>)</span> modules
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span> <span class=n>uninstall</span>
</span></span><span class=line><span class=cl>    <span class=k>$(</span>MAKE<span class=k>)</span> -C <span class=k>$(</span>KDIR<span class=k>)</span> <span class=nv>M</span><span class=o>=</span><span class=k>$(</span>PWD<span class=k>)</span> clean
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>install</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    - sudo insmod misc_char_device_driver.ko
</span></span><span class=line><span class=cl>    sudo lsmod <span class=p>|</span> grep misc_char_device_driver
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>uninstall</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    - sudo rmmod misc_char_device_driver
</span></span></code></pre></div><p>After compiling the above module and loading it, this will give me a character device in the <code>/dev/</code> directory.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>crw------- 1 root root 10, 122 Sep 17 13:21 /dev/eudyptula
</span></span></code></pre></div><p><img loading=lazy src=https://media.giphy.com/media/o75ajIFH0QnQC3nCeD/giphy.gif#center alt></p><p>We can see that the file is a character type because of the initial <code>c</code> indicator. Also the major number is <code>10</code>, which is the common major number for all misc devices. The minor number in our case is random but if you want feel free to allocate a static one.</p><p>When loading and unloading this module, it&rsquo;ll also create some logs because of the <code>pr_info</code> function calls. These logs can be viewed via <code>dmesg | grep misc_char_device_driver</code> command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>[17543.585039] misc_char_device_driver: Hello from module; Return 0
</span></span><span class=line><span class=cl>[17583.624421] misc_char_device_driver: Exiting from module
</span></span></code></pre></div><h4 id=adding-file-operations-to-driver>Adding file operations to driver<a hidden class=anchor aria-hidden=true href=#adding-file-operations-to-driver>#</a></h4><p>Now we have a working character device that just exists but it does not support any file operations at this point. We can add the required file operations using the <code>const struct file_operations *fops</code> member of <code>struct miscdevice</code>. In linux kernel, <code>struct file_operations</code> is defined at <a href=https://elixir.bootlin.com/linux/latest/source/include/linux/fs.h#L1964><code>linux/fs.h</code> file</a>. There are many file operations that are supported but we only need <code>read</code> and <code>write</code> for now.</p><p>Our new code will look something like this</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: GPL-2.0+
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/miscdevice.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/fs.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/module.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/init.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/kernel.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// message formatting
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define pr_fmt(fmt) KBUILD_MODNAME &#34;: &#34; fmt
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// Device name
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define MISC_DEVICE_NAME &#34;eudyptula&#34;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Custom read operation
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>ssize_t</span> <span class=nf>misc_read</span><span class=p>(</span><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>filp</span><span class=p>,</span> <span class=kt>char</span> <span class=n>__user</span> <span class=o>*</span><span class=n>buff</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>cnt</span><span class=p>,</span> <span class=kt>loff_t</span> <span class=o>*</span><span class=n>offt</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>pr_info</span><span class=p>(</span><span class=s>&#34;Read operation performed</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Custom write operation
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>ssize_t</span> <span class=nf>misc_write</span><span class=p>(</span><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>filp</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=n>__user</span> <span class=o>*</span><span class=n>buff</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>cnt</span><span class=p>,</span> <span class=kt>loff_t</span> <span class=o>*</span><span class=n>offt</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>pr_info</span><span class=p>(</span><span class=s>&#34;Write operation performed</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Operations structure
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span> <span class=k>struct</span> <span class=n>file_operations</span> <span class=n>misc_fops</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>read</span> <span class=o>=</span> <span class=n>misc_read</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>write</span> <span class=o>=</span> <span class=n>misc_write</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Misc Device structure
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=k>struct</span> <span class=n>miscdevice</span> <span class=n>my_misc_device</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>minor</span> <span class=o>=</span> <span class=n>MISC_DYNAMIC_MINOR</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>MISC_DEVICE_NAME</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>fops</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>misc_fops</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Entry point
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>int</span> <span class=nf>hello_world_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>ret</span> <span class=o>=</span> <span class=nf>misc_register</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_misc_device</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>pr_info</span><span class=p>(</span><span class=s>&#34;Hello from module; Return %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=o>-</span><span class=n>EFAULT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Exit point
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>void</span> <span class=nf>hello_world_exit</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>misc_deregister</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_misc_device</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>pr_info</span><span class=p>(</span><span class=s>&#34;Exiting from module</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>module_init</span><span class=p>(</span><span class=n>hello_world_init</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>module_exit</span><span class=p>(</span><span class=n>hello_world_exit</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>MODULE_LICENSE</span><span class=p>(</span><span class=s>&#34;GPL&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>MODULE_AUTHOR</span><span class=p>(</span><span class=s>&#34;ayedaemon&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>MODULE_DESCRIPTION</span><span class=p>(</span><span class=s>&#34;Eudyptula task6&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>After compiling the above module and loading it, this will provide additional functionality of read and write on the device. This can be tested by reading and writing to the <code>/dev/eudyptula</code> device now.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## Read operation</span>
</span></span><span class=line><span class=cl>dd <span class=k>if</span><span class=o>=</span>/dev/eudyptula <span class=nv>of</span><span class=o>=</span>/dev/null <span class=nv>count</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Output in `dmesg`</span>
</span></span><span class=line><span class=cl><span class=c1># [23375.547714] misc_char_device_driver: Read operation performed</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Write operation</span>
</span></span><span class=line><span class=cl>dd <span class=k>if</span><span class=o>=</span>/dev/zero <span class=nv>of</span><span class=o>=</span>/dev/eudyptula <span class=nv>count</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Output in `dmesg`</span>
</span></span><span class=line><span class=cl><span class=c1># [23353.947901] misc_char_device_driver: Write operation performed</span>
</span></span></code></pre></div><h4 id=userspace---data---kernel-module>Userspace &lt;&ndash;[data]&ndash;> kernel module<a hidden class=anchor aria-hidden=true href=#userspace---data---kernel-module>#</a></h4><p>Now it&rsquo;s time for the ultimate move, we have a misc character device driver that supports read and write operations to it, but it actually doesn&rsquo;t send any data from kernel to userland and vice-versa. This is because there is no shared memory where we can simply pass the variables or pointers to the location and do whatever we intend to do it.</p><p>Things are a bit different when have to transfer data between a kernel layer and userspace. Complete explaination is out of the scope for this article, but the short version is that the transfer is done with the help of 2 buffers, one on the kernel and other on the userspace. The userspace programs fill data in their buffer and address to that buffer is passed to the kernel. The kernel then uses that buffer to copy data to it&rsquo;s own buffer and with that we are done. <a href=https://stackoverflow.com/questions/8265657/how-does-copy-from-user-from-the-linux-kernel-work-internally>Here is a stackoverflow thread</a> on the same topic.</p><p><img loading=lazy src=https://media.giphy.com/media/fd1TSJqq3b4GI/giphy.gif#center alt></p><p>But we need not to worry about all this complexity, for us it&rsquo;ll be as hard as calling the <a href=https://www.kernel.org/doc/htmldocs/kernel-api/API---copy-from-user.html><code>copy_from_user()</code></a> <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> and <a href=https://www.kernel.org/doc/htmldocs/kernel-api/API---copy-to-user.html><code>copy_to_user()</code></a> <sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> function from our kernel module.</p><p>With this, our new <code>read</code> and <code>write</code> functions will look something like below:-</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Custom read operation
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>ssize_t</span> <span class=nf>misc_read</span><span class=p>(</span><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>filp</span><span class=p>,</span> <span class=kt>char</span> <span class=n>__user</span> <span class=o>*</span><span class=n>buff</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>cnt</span><span class=p>,</span> <span class=kt>loff_t</span> <span class=o>*</span><span class=n>offt</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>my_id</span> <span class=o>=</span> <span class=s>&#34;ayedaemon</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>my_id_len</span> <span class=o>=</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>my_id</span><span class=p>)</span><span class=o>+</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>pr_info</span><span class=p>(</span><span class=s>&#34;[begin] offt=%ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=o>*</span><span class=n>offt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=n>offt</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>((</span><span class=n>cnt</span> <span class=o>&lt;</span> <span class=n>my_id_len</span><span class=p>)</span> <span class=o>||</span>                        <span class=c1>// Check the size
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>(</span><span class=nf>copy_to_user</span><span class=p>(</span><span class=n>buff</span><span class=p>,</span> <span class=n>my_id</span><span class=p>,</span> <span class=n>my_id_len</span><span class=p>)))</span>       <span class=c1>// Copy to buffer
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=o>-</span><span class=n>EINVAL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>offt</span> <span class=o>+=</span> <span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>pr_info</span><span class=p>(</span><span class=s>&#34;[ end ] offt=%ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=o>*</span><span class=n>offt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Custom write operation
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>ssize_t</span> <span class=nf>misc_write</span><span class=p>(</span><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>filp</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=n>__user</span> <span class=o>*</span><span class=n>buff</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>cnt</span><span class=p>,</span> <span class=kt>loff_t</span> <span class=o>*</span><span class=n>offt</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>my_id</span> <span class=o>=</span> <span class=s>&#34;ayedaemon&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>my_id_len</span> <span class=o>=</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>my_id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>temp</span><span class=p>[</span><span class=n>my_id_len</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span> <span class=c1>// size = 10; including the null byte
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>((</span><span class=n>cnt</span> <span class=o>!=</span> <span class=n>my_id_len</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span> <span class=o>||</span>                                 <span class=c1>// Check input size (mainly to prevent overflows)
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>(</span><span class=nf>copy_from_user</span><span class=p>(</span><span class=n>temp</span><span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=n>my_id_len</span><span class=p>))</span> <span class=o>||</span>              <span class=c1>// Copy 9 bytes from userland
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>(</span><span class=nf>strncmp</span><span class=p>(</span><span class=n>temp</span><span class=p>,</span> <span class=n>my_id</span><span class=p>,</span> <span class=n>my_id_len</span><span class=p>)))</span>                      <span class=c1>// finally, compare 9 bytes
</span></span></span><span class=line><span class=cl><span class=c1></span>	  <span class=k>return</span> <span class=o>-</span><span class=n>EINVAL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span>
</span></span><span class=line><span class=cl>	  <span class=k>return</span> <span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In the above code, <code>read</code> function first checks the size of the buffer and then copies the <code>my_id</code> value to userspace buffer. And in <code>write</code> function, we check input size, then copies the data from userspace to <code>temp</code> buffer and then compares the data to be same. There are other things in the code but those are for extra checks, just to make sure the module does not crash.</p><p>We can now test the code with our makefile and everything should be as we are expecting it to be.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## Read the value from device</span>
</span></span><span class=line><span class=cl>cat /dev/eudyptula
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Output</span>
</span></span><span class=line><span class=cl><span class=c1># ayedaemon</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Write &#34;ayedaemon&#34; to the device</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;ayedaemon&#34;</span> &gt; /dev/eudyptula
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Output - No output</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Write anything apart from &#34;ayedaemon&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;something&#34;</span> &gt; /dev/eudyptula
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Output - Gives error</span>
</span></span><span class=line><span class=cl><span class=c1># bash: echo: write error: Invalid argument</span>
</span></span></code></pre></div><p><img loading=lazy src=https://media.giphy.com/media/hZj44bR9FVI3K/giphy.gif#center alt></p><p>Now we have achieved the goal of this task, let&rsquo;s check the formatting of the code so that it follows the proper coding conventions that linux kernels developers have set.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./linux/scripts/checkpatch.pl -f misc_char_device_driver.c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Output</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># total: 0 errors, 0 warnings, 99 lines checked</span>
</span></span><span class=line><span class=cl><span class=c1># misc_char_device_driver.c has no obvious style problems and is ready for submission.</span>
</span></span></code></pre></div><h3 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h3><p>There are mainly 2 types of device drivers - character and block. But there are also network device drivers which are completely different from the ones we discussed here. This article tries to provide basic introduction to misc character devices and details about how to write your own driver. All the code can be found in the <a href=https://github.com/ayedaemon/eudyptula>github repo here</a> <sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup> for you to playaround.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://www.oreilly.com/library/view/linux-device-drivers/0596000081/ch03s02.html>https://www.oreilly.com/library/view/linux-device-drivers/0596000081/ch03s02.html</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://www.kernel.org/doc/html/latest/admin-guide/devices.html>https://www.kernel.org/doc/html/latest/admin-guide/devices.html</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://www.kernel.org/doc/htmldocs/kernel-api/API---copy-from-user.html>https://www.kernel.org/doc/htmldocs/kernel-api/API---copy-from-user.html</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://www.kernel.org/doc/htmldocs/kernel-api/API---copy-to-user.html>https://www.kernel.org/doc/htmldocs/kernel-api/API---copy-to-user.html</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=https://github.com/ayedaemon/eudyptula>https://github.com/ayedaemon/eudyptula</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://ayedaemon.github.io/tags/eudyptula/>Eudyptula</a></li><li><a href=https://ayedaemon.github.io/tags/linux/>Linux</a></li></ul><nav class=paginav><a class=prev href=https://ayedaemon.github.io/post/2022/09/intro-to-re/><span class=title>Â« Next</span><br><span>Intro to Re: C : part-1</span>
</a><a class=next href=https://ayedaemon.github.io/post/2022/08/analyzing-simple-powershell-malware/><span class=title>Prev Â»</span><br><span>Analyzing Simple Powershell Malware</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://ayedaemon.github.io/>Connected</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>