<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Recording system events with auditd | Connected</title>
<meta name=keywords content="linux,security,audit"><meta name=description content="auditing linux systems with auditd"><meta name=author content="ayedaemon"><link rel=canonical href=https://ayedaemon.github.io/post/2022/12/recording_system_events_with_auditd/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://ayedaemon.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ayedaemon.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ayedaemon.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ayedaemon.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ayedaemon.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Recording system events with auditd"><meta property="og:description" content="auditing linux systems with auditd"><meta property="og:type" content="article"><meta property="og:url" content="https://ayedaemon.github.io/post/2022/12/recording_system_events_with_auditd/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-12-11T21:15:13+05:30"><meta property="article:modified_time" content="2024-04-02T17:19:43+05:30"><meta name=twitter:card content="summary"><meta name=twitter:title content="Recording system events with auditd"><meta name=twitter:description content="auditing linux systems with auditd"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ayedaemon.github.io/post/"},{"@type":"ListItem","position":2,"name":"Recording system events with auditd","item":"https://ayedaemon.github.io/post/2022/12/recording_system_events_with_auditd/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Recording system events with auditd","name":"Recording system events with auditd","description":"auditing linux systems with auditd","keywords":["linux","security","audit"],"articleBody":"Audits are critical for system administrators to detect security violations and track security-relevant information on their systems. Anyone concerned about the security, stability, and proper operation of their Linux servers should conduct an audit.\nHow to do auditing in linux One simple way is to use the history command to observe the shell’s history, but this has many limitations. One of them is that this command is only applicable to the current user. You can still get around this by reading the .bash_history file in each user’s home directory (given you have permissions to do so).\nAudit framework in kernel. The Linux audit framework is a better option. Because it operates at the kernel level, it has a lot of visibility over almost everything. The Linux kernel sends significant events to user-space (auditd) so that they can be recorded in a file. This file can then be analysed on the host system or sent to a remote location for storage and analysis.\nUser-space auditd The majority of Linux distributions come with auditd preinstalled, which begins and stops with the system (as a systemd service file). Using below command, you may determine whether the kernel was built using the audit options.\ngrep -i audit /boot/config-`uname -r` On my system, it gives me below output (indicating kernel was built with auditing feature)\nCONFIG_AUDIT_ARCH=y CONFIG_AUDIT=y CONFIG_AUDITSYSCALL=y CONFIG_AUDIT_WATCH=y CONFIG_AUDIT_TREE=y CONFIG_NETFILTER_XT_TARGET_AUDIT=m CONFIG_IMA_AUDIT=y CONFIG_KVM_MMU_AUDIT=y Second thing you would want to check if the kernel thread process responsible for sending data to user-space is running. Check that with the ps command.\nsudo ps -aux | grep -i kauditd This gives me below output (indicating that the thread is running)\nroot 103 0.0 0.0 0 0 ? S 11:39 0:00 [kauditd] Final thing is to check the user-space service responsible to get the data from kauditd. To obtain definitive indications on systemd systems, use the commands listed below.\nsystemctl is-active auditd ## Returns: active/inactive systemctl is-enabled auditd ## Returns: enabled/disabled (Note: Feel free to check the source code at kernel/audit.c. 1)\nConfiguring auditd Auditd decides what to log and what not to log using a set of rules. These rules can be found in the /etc/audit/rules.d/ folder. Auditd reads files from this folder on startup and generates the /etc/audit/audit.rules file automatically. (This file should not be edited by hand.)\nauditd comes with a configuration file too. This file helps in changing the behaviour of the userspace auditd daemon. Default file on my system looks like below.\n# sudo cat -n /etc/audit/auditd.conf 1\t# 2\t# This file controls the configuration of the audit daemon 3\t# 4\t5\tlocal_events = yes 6\twrite_logs = yes 7\tlog_file = /var/log/audit/audit.log 8\tlog_group = root 9\tlog_format = RAW 10\tflush = INCREMENTAL_ASYNC 11\tfreq = 50 12\tmax_log_file = 8 13\tnum_logs = 5 14\tpriority_boost = 4 15\tdisp_qos = lossy 16\tdispatcher = /sbin/audispd 17\tname_format = NONE 18\t##name = mydomain 19\tmax_log_file_action = ROTATE 20\tspace_left = 75 21\tspace_left_action = SYSLOG 22\tverify_email = yes 23\taction_mail_acct = root 24\tadmin_space_left = 50 25\tadmin_space_left_action = SUSPEND 26\tdisk_full_action = SUSPEND 27\tdisk_error_action = SUSPEND 28\tuse_libwrap = yes 29\t##tcp_listen_port = 60 30\ttcp_listen_queue = 5 31\ttcp_max_per_addr = 1 32\t##tcp_client_ports = 1024-65535 33\ttcp_client_max_idle = 0 34\tenable_krb5 = no 35\tkrb5_principal = auditd 36\t##krb5_key_file = /etc/audit/audit.key 37\tdistribute_network = no Some of these options are easy to understand, like:\nlog_file : Tells the location of the audit log file. max_log_file : Defines the size of the log file in MB. If the size is reached, max_log_file_action is triggered. space_left : Triggers the space_left_action when the limit is reached. To include additional information in audit logs you need to change log format from RAW to ENRICHED. FLUSH = INCREMENTAL_ASYNC will write the logs async instead of writing them on every write. While some of them needs more detailed explaination. In any case, always refer the man pages –\u003e man (5) auditd.conf 2. There you will find all the possible options and their supporting values to tune auditd as per your requirements.\nAfter making changes to auditd.conf, restart the service to pick up new changes from config. My centos 7 machine did not allow me to manually restart the service using systemctl but it worked just fine with service auditd restart. If you figure out why this happens, please let me know!\nInspecting audit logs We can see where the auditd logs are stored from the config file above. So we can always look through the log files and use the good old grep command to find what we’re looking for.\nBut that is not the intended method. The audit package includes a number of helper commands to assist the sysadmin/analyst in quickly determining information from logs.\nBelow are all the binary executable files provided by the audit package….\n## COMMAND: rpm -ql audit | grep bin /sbin/audispd /sbin/auditctl /sbin/auditd /sbin/augenrules /sbin/aureport /sbin/ausearch /sbin/autrace /usr/bin/aulast /usr/bin/aulastlog /usr/bin/ausyscall /usr/bin/auvirt Let’s start with ausearch for now. This program parses the audit log files and gives the information based on passed keywords.\nThere are a lot of options for this tool.. I’ll mention few which I use most often.\n-i – Interpret the logs. Translates numeric value in names. If you want to get raw logs, use -r. use -x to search based on executable name. If you know the event ID then search with -a. To search with message type, use -m. You can get the message type list by passing nothing or a wrong message type with the argument/flag. Use -k to search for specific key in log. You can configure your own key in the logs config. These keys helps to corelate the logs with the rules. If you just want to get a report of everything that was logged, you can use aureport program which gives you a proper summary in a tabular form.\n## COMMAND: sudo aureport Summary Report ====================== Range of time in logs: 01/01/1970 00:00:00.000 - 12/10/2022 16:24:29.088 Selected time for report: 01/01/1970 00:00:00 - 12/10/2022 16:24:29.088 Number of changes in configuration: 2 Number of changes to accounts, groups, or roles: 0 Number of logins: 0 Number of failed logins: 0 Number of authentications: 0 Number of failed authentications: 0 Number of users: 3 Number of terminals: 4 Number of host names: 1 Number of executables: 3 Number of commands: 1 Number of files: 0 Number of AVC's: 0 Number of MAC events: 0 Number of failed syscalls: 0 Number of anomaly events: 0 Number of responses to anomaly events: 0 Number of crypto events: 0 Number of integrity events: 0 Number of virt events: 0 Number of keys: 0 Number of process IDs: 42 Number of events: 240 Writing custom audit rules auditd also allows us to write our own rules. These rules will be read and applied when the service is restarted… or if you invoke augenrules --load.\nFor auditing, there are only three types of rules that can be defined:\nWatches on the file system (watches the changes related to filesystem or on a particular path)\nsyscalls (checks if a specific syscall was executed and with what context)\ncontrol rules (these are used to modify the kernel configuration of linux audit)\nThat’s all. This was all we needed to know before we started writing our first simple rule.\n-w /etc/ The above rule will watch for all kinds of changes in /etc/ folder… that means any (r)ead, (w)rite, (e)xecute or (a)ttribute change operations will be logged.\nLet’s write the above rule in a new file: /etc/audit/rules.d/myrules.rules… And check if it is picked up by auditd already. (I know it will not be picked, but it won’t hurt to check)\n# sudo auditctl -l No rules Now, let’s restart the service and try that again.\n# service auditd restart # sudo auditctl -l -w /etc -p rwxa auditd has now loaded the rule, as expected. But there’s more to it than just what we put in the file. It makes no difference, however, because it is implicitly adding -p rwxa to indicate that all of these operations should be monitored.\nThe files still contain what we added… but the kernel has fully expanded rules.\n# sudo cat /etc/audit/rules.d/myrules.rules -w /etc/ # sudo cat /etc/audit/audit.rules ## This file is automatically generated from /etc/audit/rules.d -D -b 8192 -f 1 -w /etc/ With this rule in the kernel, all the operations made to /etc path will be recorded. To make things easy, think of all the watch rules as just fancy wrappers for syscall rules. Above rule can be written as below, and will still work the same.\n-a exit,always -F dir=/etc -F perm=rwxa Remove the previous rule and add the above rule to the same file. Restart the service again for the changes to take effect.\n$ sudo cat /etc/audit/audit.rules ## This file is automatically generated from /etc/audit/rules.d -D -b 8192 -f 1 -a exit,always -F dir=/etc -F perm=rwxa Auto-generated event is what we wrote in the file. Let’s take a look what it looks like from kernel point of view.\n$ sudo auditctl -l -w /etc -p rwxa Told you, its practically the same. Now let’s understand all the options in the new rule we wrote (obviously for better clarity on how it is same).\n-a exit,always -F dir=/etc -F perm=rwxa -a : append rule to end of the list exit,always : always log when exiting a syscall. -F : build a rule based on (F)ield values dir=/etc: full path of directory to watch; watches recursively to whole subtrees. perm=rwxa: permission changes/access to monitor. According to man 8 auditctl, if a field rule is given and no syscall is specified, it will default to all syscalls. That means the above rule will work for all of the syscalls.\nSo far so good. Now what about control rules?? ..Or let’s say configure rules as they help in configuring the behaviour of auditd itself.\nThese rules help in configuring/controling the behaviour of auditd. Read the man page for better and complete explanation. But I’ll walk you through the ones we have already seen…. in the /etc/audit/audit.rules file.\n-D -b 8192 -f 1 -D deletes all the previous rules from kernel rules list. This should be always on the top If you want to give someone a hard time, just put that in the end.(please don’t do it on production machines, it won’t be funny)\n-b sets the size for audit buffer. If you don’t know what you are doing, leave it to the default.\n-f sets the failure mode that let’s the kernel decide how to handle failures and critical errors. 0 is silent. Default is 1 (printk). Super secured environment should be using 2 (panic).\nPre-packaged audit rules Most of the times, we don’t really need to write our own audit rules, we can just use what other people have already worked upon. You can always find them with the help of your favorite search engine…but there are few already pre-packaged with audit and are already on your system (if you have installed the package)\n$ rpm -ql audit | grep '/usr/share/.*\\.rules$' /usr/share/doc/audit-2.8.5/rules/10-base-config.rules /usr/share/doc/audit-2.8.5/rules/10-no-audit.rules /usr/share/doc/audit-2.8.5/rules/11-loginuid.rules /usr/share/doc/audit-2.8.5/rules/12-cont-fail.rules /usr/share/doc/audit-2.8.5/rules/12-ignore-error.rules /usr/share/doc/audit-2.8.5/rules/20-dont-audit.rules /usr/share/doc/audit-2.8.5/rules/21-no32bit.rules /usr/share/doc/audit-2.8.5/rules/22-ignore-chrony.rules /usr/share/doc/audit-2.8.5/rules/23-ignore-filesystems.rules /usr/share/doc/audit-2.8.5/rules/30-nispom.rules /usr/share/doc/audit-2.8.5/rules/30-ospp-v42.rules /usr/share/doc/audit-2.8.5/rules/30-pci-dss-v31.rules /usr/share/doc/audit-2.8.5/rules/30-stig.rules /usr/share/doc/audit-2.8.5/rules/31-privileged.rules /usr/share/doc/audit-2.8.5/rules/32-power-abuse.rules /usr/share/doc/audit-2.8.5/rules/40-local.rules /usr/share/doc/audit-2.8.5/rules/41-containers.rules /usr/share/doc/audit-2.8.5/rules/42-injection.rules /usr/share/doc/audit-2.8.5/rules/43-module-load.rules /usr/share/doc/audit-2.8.5/rules/70-einval.rules /usr/share/doc/audit-2.8.5/rules/71-networking.rules /usr/share/doc/audit-2.8.5/rules/99-finalize.rules ( NOTE: The numbers in the filenames play a very important role. For auditd, the first rule found wins. So if there are 2 contradictory rules, the first one found will be applied and the second one will have no effect.)\nYou can copy these rules, or just the ones you want to monitor, to /etc/audit/rules.d/ folder and restart the service to pick up the new rules. Or you can use augenrules --load to load them without restarting the service.\nHardening the audit First step to harden the audit will be to ensude auditd’s configuration is immutable. This can be done with -e 2 control rule. Enabling this will prevent further changes in auditd’s configurations. This being said, it is very obvious that this should be the last rule in the list.\nNext step would be to store the logs into a centralized secure location. Auditd comes with a dispatcher program (auditspd) that can work with auditsp-remote plugin. This program too comes with it’s own configuration file, which can be found at /etc/audisp/audisp-remote.conf.\nThis package was not already installed on my system so I installed it with sudo yum install -y audispd-plugins. Once this is installed, auditsp-remote.conf will be there witing for you to edit.\nThere are a few configuration changes you’ll need to make to ensure that logs are sent to the remote server. The overall concept is to collect logs using auditd, then use a plugin to send logs to a central server while also disabling local logging of the same logs. This way, we won’t have logs on the local system (saving disk space), and we can aggregate logs from multiple servers for analysis.\nLet’s start it with one change at a time. First one will be to enable the remote logging plugin. To do that, we can make changes to /etc/audisp/plugins.d/au-remote.conf.\n## CHANGE active status to yes active=yes Then let our audit dispatcher know about the remote server where we want to dispatch the logs. This change will be made to /etc/audisp/audisp-remote.conf\n## Remote server name/IP and the port remote_server = 192.168.56.10 port = 60 As a dirty trick, I’ve started netcat on port 60 to listen to the incoming data from the host.\nLast thing is to disable the local logging for auditd. For that, make changes to /etc/audit/auditd.conf.\n## CHANGE write logs to no write_logs = no With this done, you have everything configured and ready to test. Now restart the auditd service and you’ll start getting logs in netcat screen on remote system.\nWrap-up In this article, you learnt about how to do better auditing of your linux environment, with the help of auditd. You also learnt about how to write your own rules or get pre-packaged rules to generate specific audit logs… and ways to get required reports with the help of ausearch and aureport programs.\nThis article is not intended to be a complete guide for auditing. It’s whole purpose is to get you started with the idea of auditing and using the audit package utilities.\nIf you want to learn more about it, I suggest you to play around and read RedHat’s documentation on system auditing 3. And if you are stuck, use your favorite search engine or… RTFM.\nhttps://elixir.bootlin.com/linux/latest/source/kernel/audit.c ↩︎\nhttps://www.man7.org/linux/man-pages/man5/auditd.conf.5.html ↩︎\nhttps://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/chap-system_auditing ↩︎\n","wordCount":"2419","inLanguage":"en","datePublished":"2022-12-11T21:15:13+05:30","dateModified":"2024-04-02T17:19:43+05:30","author":[{"@type":"Person","name":"ayedaemon"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://ayedaemon.github.io/post/2022/12/recording_system_events_with_auditd/"},"publisher":{"@type":"Organization","name":"Connected","logo":{"@type":"ImageObject","url":"https://ayedaemon.github.io/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://ayedaemon.github.io/ accesskey=h title="Connected (Alt + H)">Connected</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://ayedaemon.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://ayedaemon.github.io/series/ title=Series><span>Series</span></a></li><li><a href=https://ayedaemon.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://ayedaemon.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Recording system events with auditd</h1><div class=post-description>auditing linux systems with auditd</div><div class=post-meta><span title='2022-12-11 21:15:13 +0530 +0530'>December 11, 2022</span>&nbsp;·&nbsp;12 min&nbsp;·&nbsp;2419 words&nbsp;·&nbsp;ayedaemon&nbsp;|&nbsp;<a href=https://github.com/ayedaemon/ayedaemon.github.io/tree/main/content/post/2022/12/recording_system_events_with_auditd.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#how-to-do-auditing-in-linux aria-label="How to do auditing in linux">How to do auditing in linux</a><ul><li><a href=#audit-framework-in-kernel aria-label="Audit framework in kernel.">Audit framework in kernel.</a></li></ul></li><li><a href=#user-space-auditd aria-label="User-space auditd">User-space auditd</a><ul><li><a href=#configuring-auditd aria-label="Configuring auditd">Configuring auditd</a></li><li><a href=#inspecting-audit-logs aria-label="Inspecting audit logs">Inspecting audit logs</a></li><li><a href=#writing-custom-audit-rules aria-label="Writing custom audit rules">Writing custom audit rules</a></li><li><a href=#pre-packaged-audit-rules aria-label="Pre-packaged audit rules">Pre-packaged audit rules</a></li><li><a href=#hardening-the-audit aria-label="Hardening the audit">Hardening the audit</a></li></ul></li><li><a href=#wrap-up aria-label=Wrap-up>Wrap-up</a></li></ul></div></details></div><div class=post-content><p>Audits are critical for system administrators to detect security violations and track security-relevant information on their systems.
Anyone concerned about the security, stability, and proper operation of their Linux servers should conduct an audit.</p><h2 id=how-to-do-auditing-in-linux>How to do auditing in linux<a hidden class=anchor aria-hidden=true href=#how-to-do-auditing-in-linux>#</a></h2><p>One simple way is to use the <code>history</code> command to observe the shell&rsquo;s history, but this has many limitations. One of them is that this command is only applicable to the current user. You can still get around this by reading the <code>.bash_history</code> file in each user&rsquo;s home directory (given you have permissions to do so).</p><h3 id=audit-framework-in-kernel>Audit framework in kernel.<a hidden class=anchor aria-hidden=true href=#audit-framework-in-kernel>#</a></h3><p>The Linux audit framework is a better option.
Because it operates at the kernel level, it has a lot of visibility over almost everything. The Linux kernel sends significant events to user-space (<code>auditd</code>) so that they can be recorded in a file. This file can then be analysed on the host system or sent to a remote location for storage and analysis.</p><h2 id=user-space-auditd>User-space auditd<a hidden class=anchor aria-hidden=true href=#user-space-auditd>#</a></h2><p>The majority of Linux distributions come with <code>auditd</code> preinstalled, which begins and stops with the system (as a systemd service file). Using below command, you may determine whether the kernel was built using the audit options.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>grep -i audit /boot/config-`uname -r`
</span></span></code></pre></div><p>On my system, it gives me below output (indicating kernel was built with auditing feature)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CONFIG_AUDIT_ARCH=y
</span></span><span class=line><span class=cl>CONFIG_AUDIT=y
</span></span><span class=line><span class=cl>CONFIG_AUDITSYSCALL=y
</span></span><span class=line><span class=cl>CONFIG_AUDIT_WATCH=y
</span></span><span class=line><span class=cl>CONFIG_AUDIT_TREE=y
</span></span><span class=line><span class=cl>CONFIG_NETFILTER_XT_TARGET_AUDIT=m
</span></span><span class=line><span class=cl>CONFIG_IMA_AUDIT=y
</span></span><span class=line><span class=cl>CONFIG_KVM_MMU_AUDIT=y
</span></span></code></pre></div><p>Second thing you would want to check if the kernel thread process responsible for sending data to user-space is running. Check that with the <code>ps</code> command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo ps -aux | grep -i kauditd
</span></span></code></pre></div><p>This gives me below output (indicating that the thread is running)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root       103  0.0  0.0      0     0 ?        S    11:39   0:00 [kauditd]
</span></span></code></pre></div><p>Final thing is to check the user-space service responsible to get the data from <code>kauditd</code>. To obtain definitive indications on systemd systems, use the commands listed below.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>systemctl is-active auditd          ## Returns: active/inactive
</span></span><span class=line><span class=cl>systemctl is-enabled auditd         ## Returns: enabled/disabled
</span></span></code></pre></div><p><em>(<strong>Note</strong>: Feel free to check the source code at <a href=https://elixir.bootlin.com/linux/latest/source/kernel/audit.c><code>kernel/audit.c</code></a>. <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>)</em></p><h3 id=configuring-auditd>Configuring auditd<a hidden class=anchor aria-hidden=true href=#configuring-auditd>#</a></h3><p><code>Auditd</code> decides what to log and what not to log using a set of rules. These rules can be found in the <code>/etc/audit/rules.d/</code> folder. Auditd reads files from this folder on startup and generates the <code>/etc/audit/audit.rules</code> file automatically. <strong>(This file should not be edited by hand.)</strong></p><p><code>auditd</code> comes with a configuration file too. This file helps in changing the behaviour of the userspace <code>auditd</code> daemon. Default file on my system looks like below.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=c1># sudo cat -n /etc/audit/auditd.conf</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     <span class=mi>1</span>	<span class=c1>#</span>
</span></span><span class=line><span class=cl>     <span class=mi>2</span>	<span class=c1># This file controls the configuration of the audit daemon</span>
</span></span><span class=line><span class=cl>     <span class=mi>3</span>	<span class=c1>#</span>
</span></span><span class=line><span class=cl>     <span class=mi>4</span>	
</span></span><span class=line><span class=cl>     <span class=mi>5</span>	<span class=n>local_events</span> <span class=o>=</span> <span class=n>yes</span>
</span></span><span class=line><span class=cl>     <span class=mi>6</span>	<span class=n>write_logs</span> <span class=o>=</span> <span class=n>yes</span>
</span></span><span class=line><span class=cl>     <span class=mi>7</span>	<span class=n>log_file</span> <span class=o>=</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=nb>log</span><span class=o>/</span><span class=n>audit</span><span class=o>/</span><span class=n>audit</span><span class=o>.</span><span class=n>log</span>
</span></span><span class=line><span class=cl>     <span class=mi>8</span>	<span class=n>log_group</span> <span class=o>=</span> <span class=n>root</span>
</span></span><span class=line><span class=cl>     <span class=mi>9</span>	<span class=n>log_format</span> <span class=o>=</span> <span class=n>RAW</span>
</span></span><span class=line><span class=cl>    <span class=mi>10</span>	<span class=n>flush</span> <span class=o>=</span> <span class=n>INCREMENTAL_ASYNC</span>
</span></span><span class=line><span class=cl>    <span class=mi>11</span>	<span class=n>freq</span> <span class=o>=</span> <span class=mi>50</span>
</span></span><span class=line><span class=cl>    <span class=mi>12</span>	<span class=n>max_log_file</span> <span class=o>=</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl>    <span class=mi>13</span>	<span class=n>num_logs</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    <span class=mi>14</span>	<span class=n>priority_boost</span> <span class=o>=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=mi>15</span>	<span class=n>disp_qos</span> <span class=o>=</span> <span class=n>lossy</span>
</span></span><span class=line><span class=cl>    <span class=mi>16</span>	<span class=n>dispatcher</span> <span class=o>=</span> <span class=o>/</span><span class=n>sbin</span><span class=o>/</span><span class=n>audispd</span>
</span></span><span class=line><span class=cl>    <span class=mi>17</span>	<span class=n>name_format</span> <span class=o>=</span> <span class=n>NONE</span>
</span></span><span class=line><span class=cl>    <span class=mi>18</span>	<span class=c1>##name = mydomain</span>
</span></span><span class=line><span class=cl>    <span class=mi>19</span>	<span class=n>max_log_file_action</span> <span class=o>=</span> <span class=n>ROTATE</span>
</span></span><span class=line><span class=cl>    <span class=mi>20</span>	<span class=n>space_left</span> <span class=o>=</span> <span class=mi>75</span>
</span></span><span class=line><span class=cl>    <span class=mi>21</span>	<span class=n>space_left_action</span> <span class=o>=</span> <span class=n>SYSLOG</span>
</span></span><span class=line><span class=cl>    <span class=mi>22</span>	<span class=n>verify_email</span> <span class=o>=</span> <span class=n>yes</span>
</span></span><span class=line><span class=cl>    <span class=mi>23</span>	<span class=n>action_mail_acct</span> <span class=o>=</span> <span class=n>root</span>
</span></span><span class=line><span class=cl>    <span class=mi>24</span>	<span class=n>admin_space_left</span> <span class=o>=</span> <span class=mi>50</span>
</span></span><span class=line><span class=cl>    <span class=mi>25</span>	<span class=n>admin_space_left_action</span> <span class=o>=</span> <span class=n>SUSPEND</span>
</span></span><span class=line><span class=cl>    <span class=mi>26</span>	<span class=n>disk_full_action</span> <span class=o>=</span> <span class=n>SUSPEND</span>
</span></span><span class=line><span class=cl>    <span class=mi>27</span>	<span class=n>disk_error_action</span> <span class=o>=</span> <span class=n>SUSPEND</span>
</span></span><span class=line><span class=cl>    <span class=mi>28</span>	<span class=n>use_libwrap</span> <span class=o>=</span> <span class=n>yes</span>
</span></span><span class=line><span class=cl>    <span class=mi>29</span>	<span class=c1>##tcp_listen_port = 60</span>
</span></span><span class=line><span class=cl>    <span class=mi>30</span>	<span class=n>tcp_listen_queue</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    <span class=mi>31</span>	<span class=n>tcp_max_per_addr</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=mi>32</span>	<span class=c1>##tcp_client_ports = 1024-65535</span>
</span></span><span class=line><span class=cl>    <span class=mi>33</span>	<span class=n>tcp_client_max_idle</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=mi>34</span>	<span class=n>enable_krb5</span> <span class=o>=</span> <span class=n>no</span>
</span></span><span class=line><span class=cl>    <span class=mi>35</span>	<span class=n>krb5_principal</span> <span class=o>=</span> <span class=n>auditd</span>
</span></span><span class=line><span class=cl>    <span class=mi>36</span>	<span class=c1>##krb5_key_file = /etc/audit/audit.key</span>
</span></span><span class=line><span class=cl>    <span class=mi>37</span>	<span class=n>distribute_network</span> <span class=o>=</span> <span class=n>no</span>
</span></span></code></pre></div><p>Some of these options are easy to understand, like:</p><ul><li><strong>log_file</strong> : Tells the location of the audit log file.</li><li><strong>max_log_file</strong> : Defines the size of the log file in MB. If the size is reached, <strong>max_log_file_action</strong> is triggered.</li><li><strong>space_left</strong> : Triggers the <strong>space_left_action</strong> when the limit is reached.</li><li>To include additional information in audit logs you need to change <code>log format</code> from <strong>RAW</strong> to <code>ENRICHED</code>.</li><li><code>FLUSH = INCREMENTAL_ASYNC</code> will write the logs async instead of writing them on every write.</li></ul><p>While some of them needs more detailed explaination. In any case, always refer the man pages &ndash;> <a href=https://www.man7.org/linux/man-pages/man5/auditd.conf.5.html><code>man (5) auditd.conf</code></a> <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. There you will find all the possible options and their supporting values to tune auditd as per your requirements.</p><p>After making changes to <code>auditd.conf</code>, restart the service to pick up new changes from config. My <code>centos 7</code> machine did not allow me to manually restart the service using <code>systemctl</code> but it worked just fine with <code>service auditd restart</code>. If you figure out why this happens, please let me know!</p><h3 id=inspecting-audit-logs>Inspecting audit logs<a hidden class=anchor aria-hidden=true href=#inspecting-audit-logs>#</a></h3><p>We can see where the <code>auditd</code> logs are stored from the config file above. So we can always look through the log files and use the good old <code>grep</code> command to find what we&rsquo;re looking for.</p><p>But that is not the intended method. The <code>audit</code> package includes a number of helper commands to assist the sysadmin/analyst in quickly determining information from logs.</p><p>Below are all the binary executable files provided by the <code>audit</code> package&mldr;.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>## COMMAND:   rpm -ql audit | grep bin
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/sbin/audispd
</span></span><span class=line><span class=cl>/sbin/auditctl
</span></span><span class=line><span class=cl>/sbin/auditd
</span></span><span class=line><span class=cl>/sbin/augenrules
</span></span><span class=line><span class=cl>/sbin/aureport
</span></span><span class=line><span class=cl>/sbin/ausearch
</span></span><span class=line><span class=cl>/sbin/autrace
</span></span><span class=line><span class=cl>/usr/bin/aulast
</span></span><span class=line><span class=cl>/usr/bin/aulastlog
</span></span><span class=line><span class=cl>/usr/bin/ausyscall
</span></span><span class=line><span class=cl>/usr/bin/auvirt
</span></span></code></pre></div><p>Let&rsquo;s start with <code>ausearch</code> for now. This program parses the audit log files and gives the information based on passed keywords.</p><p>There are a lot of options for this tool.. I&rsquo;ll mention few which I use most often.</p><ul><li><strong><code>-i</code></strong> &ndash; Interpret the logs. Translates numeric value in names.</li><li>If you want to get raw logs, use <strong><code>-r</code></strong>.</li><li>use <strong><code>-x</code></strong> to search based on executable name.</li><li>If you know the event ID then search with <strong><code>-a</code></strong>.</li><li>To search with message type, use <strong><code>-m</code></strong>. You can get the message type list by passing nothing or a wrong message type with the argument/flag.</li><li>Use <strong><code>-k</code></strong> to search for specific key in log. You can configure your own key in the logs config. These keys helps to corelate the logs with the rules.</li></ul><p>If you just want to get a report of everything that was logged, you can use <code>aureport</code> program which gives you a proper summary in a tabular form.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>## COMMAND:   sudo aureport
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Summary Report
</span></span><span class=line><span class=cl>======================
</span></span><span class=line><span class=cl>Range of time in logs: 01/01/1970 00:00:00.000 - 12/10/2022 16:24:29.088
</span></span><span class=line><span class=cl>Selected time for report: 01/01/1970 00:00:00 - 12/10/2022 16:24:29.088
</span></span><span class=line><span class=cl>Number of changes in configuration: 2
</span></span><span class=line><span class=cl>Number of changes to accounts, groups, or roles: 0
</span></span><span class=line><span class=cl>Number of logins: 0
</span></span><span class=line><span class=cl>Number of failed logins: 0
</span></span><span class=line><span class=cl>Number of authentications: 0
</span></span><span class=line><span class=cl>Number of failed authentications: 0
</span></span><span class=line><span class=cl>Number of users: 3
</span></span><span class=line><span class=cl>Number of terminals: 4
</span></span><span class=line><span class=cl>Number of host names: 1
</span></span><span class=line><span class=cl>Number of executables: 3
</span></span><span class=line><span class=cl>Number of commands: 1
</span></span><span class=line><span class=cl>Number of files: 0
</span></span><span class=line><span class=cl>Number of AVC&#39;s: 0
</span></span><span class=line><span class=cl>Number of MAC events: 0
</span></span><span class=line><span class=cl>Number of failed syscalls: 0
</span></span><span class=line><span class=cl>Number of anomaly events: 0
</span></span><span class=line><span class=cl>Number of responses to anomaly events: 0
</span></span><span class=line><span class=cl>Number of crypto events: 0
</span></span><span class=line><span class=cl>Number of integrity events: 0
</span></span><span class=line><span class=cl>Number of virt events: 0
</span></span><span class=line><span class=cl>Number of keys: 0
</span></span><span class=line><span class=cl>Number of process IDs: 42
</span></span><span class=line><span class=cl>Number of events: 240
</span></span></code></pre></div><h3 id=writing-custom-audit-rules>Writing custom audit rules<a hidden class=anchor aria-hidden=true href=#writing-custom-audit-rules>#</a></h3><p><code>auditd</code> also allows us to write our own rules. These rules will be read and applied when the service is restarted&mldr; or if you invoke <code>augenrules --load</code>.</p><p>For auditing, there are only three types of rules that can be defined:</p><ol><li><p>Watches on the file system (watches the changes related to filesystem or on a particular path)</p></li><li><p>syscalls (checks if a specific syscall was executed and with what context)</p></li><li><p>control rules (these are used to modify the kernel configuration of linux audit)</p></li></ol><p>That&rsquo;s all. This was all we needed to know before we started writing our first simple rule.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>-w /etc/
</span></span></code></pre></div><p>The above rule will watch for all kinds of changes in <code>/etc/</code> folder&mldr; that means any (r)ead, (w)rite, (e)xecute or (a)ttribute change operations will be logged.</p><p>Let&rsquo;s write the above rule in a new file: <code>/etc/audit/rules.d/myrules.rules</code>&mldr; And check if it is picked up by auditd already. (I know it will not be picked, but it won&rsquo;t hurt to check)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># sudo auditctl -l
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>No rules
</span></span></code></pre></div><p>Now, let&rsquo;s restart the service and try that again.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># service auditd restart
</span></span><span class=line><span class=cl># sudo auditctl -l
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-w /etc -p rwxa
</span></span></code></pre></div><p><code>auditd</code> has now loaded the rule, as expected. But there&rsquo;s more to it than just what we put in the file. It makes no difference, however, because it is implicitly adding <code>-p rwxa</code> to indicate that all of these operations should be monitored.</p><p>The files still contain what we added&mldr; but the kernel has fully expanded rules.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># sudo cat /etc/audit/rules.d/myrules.rules
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-w /etc/
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># sudo cat /etc/audit/audit.rules
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>## This file is automatically generated from /etc/audit/rules.d
</span></span><span class=line><span class=cl>-D
</span></span><span class=line><span class=cl>-b 8192
</span></span><span class=line><span class=cl>-f 1
</span></span><span class=line><span class=cl>-w /etc/
</span></span></code></pre></div><p>With this rule in the kernel, all the operations made to <code>/etc</code> path will be recorded. To make things easy, think of all the <strong>watch</strong> rules as just fancy wrappers for syscall rules. Above rule can be written as below, and will still work the same.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>-a exit,always  -F dir=/etc -F perm=rwxa
</span></span></code></pre></div><p>Remove the previous rule and add the above rule to the same file. Restart the service again for the changes to take effect.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo cat /etc/audit/audit.rules
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## This file is automatically generated from /etc/audit/rules.d</span>
</span></span><span class=line><span class=cl>-D
</span></span><span class=line><span class=cl>-b <span class=m>8192</span>
</span></span><span class=line><span class=cl>-f <span class=m>1</span>
</span></span><span class=line><span class=cl>-a exit,always  -F <span class=nv>dir</span><span class=o>=</span>/etc -F <span class=nv>perm</span><span class=o>=</span>rwxa
</span></span></code></pre></div><p>Auto-generated event is what we wrote in the file. Let&rsquo;s take a look what it looks like from kernel point of view.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ sudo auditctl -l
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-w /etc -p rwxa
</span></span></code></pre></div><p>Told you, its practically the same. Now let&rsquo;s understand all the options in the new rule we wrote (obviously for better clarity on how it is same).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>-a exit,always  -F dir=/etc -F perm=rwxa
</span></span></code></pre></div><ul><li><code>-a</code> : append rule to end of the list</li><li><code>exit,always</code> : always log when exiting a syscall.</li><li><code>-F</code> : build a rule based on (F)ield values</li><li><code>dir=/etc</code>: full path of directory to watch; watches recursively to whole subtrees.</li><li><code>perm=rwxa</code>: permission changes/access to monitor.</li></ul><p>According to <code>man 8 auditctl</code>, <strong>if a field rule is given and no syscall is specified, it will default to all syscalls.</strong> That means the above rule will work for all of the syscalls.</p><p>So far so good. Now what about control rules?? ..Or let&rsquo;s say <em>configure</em> rules as they help in configuring the behaviour of auditd itself.</p><p>These rules help in configuring/controling the behaviour of auditd. Read the man page for better and complete explanation. But I&rsquo;ll walk you through the ones we have already seen&mldr;. in the <code>/etc/audit/audit.rules</code> file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>-D
</span></span><span class=line><span class=cl>-b 8192
</span></span><span class=line><span class=cl>-f 1
</span></span></code></pre></div><ul><li><p><code>-D</code> deletes all the previous rules from kernel rules list. This should be always on the top If you want to give someone a hard time, just put that in the end.(<strong>please don&rsquo;t do it on production machines, it won&rsquo;t be funny</strong>)</p></li><li><p><code>-b</code> sets the size for audit buffer. If you don&rsquo;t know what you are doing, leave it to the default.</p></li><li><p><code>-f</code> sets the failure mode that let&rsquo;s the kernel decide how to handle failures and critical errors. 0 is silent. Default is 1 (printk). Super secured environment should be using 2 (panic).</p></li></ul><h3 id=pre-packaged-audit-rules>Pre-packaged audit rules<a hidden class=anchor aria-hidden=true href=#pre-packaged-audit-rules>#</a></h3><p>Most of the times, we don&rsquo;t really need to write our own audit rules, we can just use what other people have already worked upon. You can always find them with the help of your favorite search engine&mldr;but there are few already pre-packaged with <code>audit</code> and are already on your system (if you have installed the package)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>$</span> <span class=n>rpm</span> <span class=o>-</span><span class=n>ql</span> <span class=n>audit</span> <span class=o>|</span> <span class=n>grep</span> <span class=s1>&#39;/usr/share/.*\.rules$&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>10</span><span class=o>-</span><span class=n>base</span><span class=o>-</span><span class=n>config</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>10</span><span class=o>-</span><span class=n>no</span><span class=o>-</span><span class=n>audit</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>11</span><span class=o>-</span><span class=n>loginuid</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>12</span><span class=o>-</span><span class=n>cont</span><span class=o>-</span><span class=n>fail</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>12</span><span class=o>-</span><span class=n>ignore</span><span class=o>-</span><span class=n>error</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>20</span><span class=o>-</span><span class=n>dont</span><span class=o>-</span><span class=n>audit</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>21</span><span class=o>-</span><span class=n>no32bit</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>22</span><span class=o>-</span><span class=n>ignore</span><span class=o>-</span><span class=n>chrony</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>23</span><span class=o>-</span><span class=n>ignore</span><span class=o>-</span><span class=n>filesystems</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>30</span><span class=o>-</span><span class=n>nispom</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>30</span><span class=o>-</span><span class=n>ospp</span><span class=o>-</span><span class=n>v42</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>30</span><span class=o>-</span><span class=n>pci</span><span class=o>-</span><span class=n>dss</span><span class=o>-</span><span class=n>v31</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>30</span><span class=o>-</span><span class=n>stig</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>31</span><span class=o>-</span><span class=n>privileged</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>32</span><span class=o>-</span><span class=n>power</span><span class=o>-</span><span class=n>abuse</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>40</span><span class=o>-</span><span class=n>local</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>41</span><span class=o>-</span><span class=n>containers</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>42</span><span class=o>-</span><span class=n>injection</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>43</span><span class=o>-</span><span class=n>module</span><span class=o>-</span><span class=nb>load</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>70</span><span class=o>-</span><span class=n>einval</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>71</span><span class=o>-</span><span class=n>networking</span><span class=o>.</span><span class=n>rules</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>audit</span><span class=o>-</span><span class=mf>2.8</span><span class=o>.</span><span class=mi>5</span><span class=o>/</span><span class=n>rules</span><span class=o>/</span><span class=mi>99</span><span class=o>-</span><span class=n>finalize</span><span class=o>.</span><span class=n>rules</span>
</span></span></code></pre></div><p><em>( <strong>NOTE:</strong> The numbers in the filenames play a very important role. For auditd, the first rule found wins. So if there are 2 contradictory rules, the first one found will be applied and the second one will have no effect.)</em></p><p>You can copy these rules, or just the ones you want to monitor, to <code>/etc/audit/rules.d/</code> folder and restart the service to pick up the new rules. Or you can use <code>augenrules --load</code> to load them without restarting the service.</p><h3 id=hardening-the-audit>Hardening the audit<a hidden class=anchor aria-hidden=true href=#hardening-the-audit>#</a></h3><p>First step to harden the audit will be to ensude auditd&rsquo;s configuration is immutable. This can be done with <code>-e 2</code> control rule. Enabling this will prevent further changes in auditd&rsquo;s configurations. This being said, it is very obvious that this should be the last rule in the list.</p><p>Next step would be to store the logs into a centralized secure location. <code>Auditd</code> comes with a dispatcher program (<code>auditspd</code>) that can work with <code>auditsp-remote</code> plugin. This program too comes with it&rsquo;s own configuration file, which can be found at <code>/etc/audisp/audisp-remote.conf</code>.</p><p><em>This package was not already installed on my system so I installed it with <code>sudo yum install -y audispd-plugins</code>. Once this is installed, <code>auditsp-remote.conf</code> will be there witing for you to edit.</em></p><p>There are a few configuration changes you&rsquo;ll need to make to ensure that logs are sent to the remote server. The overall concept is to collect logs using auditd, then use a plugin to send logs to a central server while also disabling local logging of the same logs. This way, we won&rsquo;t have logs on the local system (saving disk space), and we can aggregate logs from multiple servers for analysis.</p><p>Let&rsquo;s start it with one change at a time. First one will be to enable the remote logging plugin. To do that, we can make changes to <code>/etc/audisp/plugins.d/au-remote.conf</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>## CHANGE active status to yes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>active=yes
</span></span></code></pre></div><p>Then let our audit dispatcher know about the remote server where we want to dispatch the logs. This change will be made to <code>/etc/audisp/audisp-remote.conf</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>## Remote server name/IP and the port
</span></span><span class=line><span class=cl>remote_server = 192.168.56.10
</span></span><span class=line><span class=cl>port = 60
</span></span></code></pre></div><p><em>As a dirty trick, I&rsquo;ve started netcat on port 60 to listen to the incoming data from the host.</em></p><p>Last thing is to disable the local logging for <code>auditd</code>. For that, make changes to <code>/etc/audit/auditd.conf</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>## CHANGE write logs to no
</span></span><span class=line><span class=cl>write_logs = no
</span></span></code></pre></div><p>With this done, you have everything configured and ready to test. Now restart the <strong>auditd</strong> service and you&rsquo;ll start getting logs in netcat screen on remote system.</p><h2 id=wrap-up>Wrap-up<a hidden class=anchor aria-hidden=true href=#wrap-up>#</a></h2><p>In this article, you learnt about how to do better auditing of your linux environment, with the help of <code>auditd</code>. You also learnt about how to write your own rules or get pre-packaged rules to generate specific audit logs&mldr; and ways to get required reports with the help of <code>ausearch</code> and <code>aureport</code> programs.</p><p>This article is not intended to be a complete guide for auditing. It&rsquo;s whole purpose is to get you started with the idea of auditing and using the <code>audit</code> package utilities.</p><p>If you want to learn more about it, I suggest you to play around and read <a href=https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/chap-system_auditing>RedHat&rsquo;s documentation on system auditing</a> <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>. And if you are stuck, use your favorite search engine or&mldr; RTFM.</p><p><img loading=lazy src=https://media.giphy.com/media/8dYmJ6Buo3lYY/giphy.gif#center alt></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://elixir.bootlin.com/linux/latest/source/kernel/audit.c>https://elixir.bootlin.com/linux/latest/source/kernel/audit.c</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://www.man7.org/linux/man-pages/man5/auditd.conf.5.html>https://www.man7.org/linux/man-pages/man5/auditd.conf.5.html</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/chap-system_auditing>https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/chap-system_auditing</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://ayedaemon.github.io/tags/linux/>Linux</a></li><li><a href=https://ayedaemon.github.io/tags/security/>Security</a></li><li><a href=https://ayedaemon.github.io/tags/audit/>audit</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://ayedaemon.github.io/>Connected</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>