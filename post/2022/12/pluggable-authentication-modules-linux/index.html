<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Pluggable Authentication Modules - Linux | Connected</title>
<meta name=keywords content="linux,security"><meta name=description content="Linux-PAM is a system of libraries that handle the authentication tasks of applications (services) on the system."><meta name=author content="ayedaemon"><link rel=canonical href=https://ayedaemon.github.io/post/2022/12/pluggable-authentication-modules-linux/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://ayedaemon.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ayedaemon.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ayedaemon.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ayedaemon.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ayedaemon.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Pluggable Authentication Modules - Linux"><meta property="og:description" content="Linux-PAM is a system of libraries that handle the authentication tasks of applications (services) on the system."><meta property="og:type" content="article"><meta property="og:url" content="https://ayedaemon.github.io/post/2022/12/pluggable-authentication-modules-linux/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-12-27T23:25:23+05:30"><meta property="article:modified_time" content="2023-11-07T00:10:13+05:30"><meta property="og:site_name" content="Connected"><meta name=twitter:card content="summary"><meta name=twitter:title content="Pluggable Authentication Modules - Linux"><meta name=twitter:description content="Linux-PAM is a system of libraries that handle the authentication tasks of applications (services) on the system."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ayedaemon.github.io/post/"},{"@type":"ListItem","position":2,"name":"Pluggable Authentication Modules - Linux","item":"https://ayedaemon.github.io/post/2022/12/pluggable-authentication-modules-linux/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Pluggable Authentication Modules - Linux","name":"Pluggable Authentication Modules - Linux","description":"Linux-PAM is a system of libraries that handle the authentication tasks of applications (services) on the system.","keywords":["linux","security"],"articleBody":"PAM - What and Why Authenticating a user to a service used to be a time-consuming process. The application had to be aware of all possible authentication mechanisms and had to be rebuilt every time a new authentication method was introduced… As a result, there was a significant amount of code repetition. Naturally, it was disliked by everyone!!\nAs a result, the concept of a middle-ware application responsible for user authentication to a service arose. And, Pluggable Authentication Modules (PAM), a collection of modules that act as a barrier between a service on your system and the service’s user, were created.\nModules can include a variety of functions, such as disabling login for specific users/groups, limiting resources, audting, and so on. PAM is now supported by the vast majority of major unix flavours, including AIX, HP-US, FreeBSD, and nearly all Linux distributions.\nThe big advantage here is that security is no longer a concern for the application: if PAM says “it’s OK”, it’s OK. That simplifies things for both the application developer and the system administrator.\nUnderstanding PAM According to man (8) pam,\nLinux-PAM is a system of libraries that handle the authentication tasks of applications (services) on the system. The library provides a stable general interface (Application Programming Interface - API) that privilege granting programs (such as login(1) and su(1)) defer to to perform standard authentication tasks.\nThese libraries are typically configurable via defined arguments or dedicated configuration files. Internal behavior of the Linux-pam library is trivial from the standpoint of a sysadmin. The key point is to define the relationship between applications and the PAM.\nThe below diagram gives an idea of how PAM works.\n┌ │ │ │ │ ├ │ └ ─ ─ ─ ┌ │ │ │ │ └ ─ ─ p ─ ─ ─ ─ ─ a ─ ─ / / ─ ─ ─ m ─ ─ e e ─ ─ ─ _ ─ ─ t t ─ ─ ─ u ┬ │ │ │ ▼ ─ c c ─ ─ ─ n ─ ─ / / ─ ┌ │ │ │ └ ─ ─ i ─ ─ p s ─ ─ ─ ─ ─ x ─ ─ a h ─ ─ ┬ │ │ │ │ │ │ ▼ ─ ─ . ─ ─ s a ─ ─ ─ ─ ─ s ─ ─ s d ─ ─ A ─ ─ ─ o ─ ─ w o ─ ─ P ─ ─ ─ ─ ─ d w ─ ─ P ─ ─ ┬ │ ┴ ─ ─ ─ ─ ▲ │ │ │ │ │ │ ┴ ─ ─ ┐ │ │ │ │ ┘ ─ 1 ─ ─ ─ ─ ─ ─ ─ ─ p ─ ─ ─ ─ ─ a ─ ┌ │ │ │ │ └ ─ ─ ─ ─ m ─ ─ ─ ┐ │ │ │ ┘ ─ ─ _ ─ ─ ─ ─ ─ l ─ ─ ─ ─ ─ d ┬ │ │ │ ▼ ─ ─ ─ ─ a ─ ─ L ─ ─ ─ p ─ ─ D ─ ─ ─ . ─ ─ A ─ ─ ─ s ─ ─ P ─ ─ ─ o ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┬ │ ┴ ─ ─ ─ ─ ─ ─ ─ ─ ─ p ─ ┐ │ │ │ │ ┘ ─ ─ a ─ ─ ─ m ─ ─ ─ _ ─ ┌ │ │ │ └ ─ ─ t ─ ─ ─ ─ P ─ t ─ ─ ┬ │ │ │ │ │ │ │ ▼ ─ A ─ y ─ ─ ─ ─ M ─ _ ─ ─ A ─ ─ ─ a ─ ─ P ─ ─ ─ u ─ ─ P ─ ─ ─ d ─ ─ ─ ▲ │ │ │ │ │ │ │ ┴ ─ i ─ ─ 2 ─ ─ ─ t ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┬ │ ┴ ─ ─ ─ ─ ─ ┐ │ │ │ ┘ ─ ─ ( ─ ─ ─ a ─ ─ ─ n ─ ─ ─ d ─ ─ ─ ─ ─ ─ o ─ ─ ─ t ─ ─ ─ h ─ ─ ─ e ─ ─ ─ r ─ ─ ─ ─ ─ ─ l ─ ─ ─ i ─ ─ ─ b ─ ─ ─ r ─ ┌ │ │ │ └ ─ ─ a ─ ─ ┬ │ │ │ │ │ │ │ ▼ ─ ─ r ─ ─ ─ ─ ─ i ─ ─ A ─ ─ ─ e ─ ─ P ─ ─ ─ s ─ ─ P ─ ▲ │ │ │ │ │ │ │ ┴ ─ ) ─ ─ ─ ─ ─ ─ ─ 3 ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐ │ │ │ ┘ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐ │ │ │ │ ┤ │ ┘ Assume the user attempts to log into APP 1, which checks the PAM to see if the user is authenticated and authorised. If the query is successful, PAM returns the status code PAM_SUCCESS; otherwise, it returns one of the other relevant codes. The complete list of return codes and their meanings can be found in their github repository, which can be found here. 1\nConfiguring PAM PAM’s main feature is the module configuration it offers. PAM looks at these text configuration files to determine what security actions to take for an application, and the administrator can add or remove new rules at any time. PAM is also extensible, which means that if we want to add new features (such as 2FA/MFA), we only need to change a few files and login can now use them.\nIn RedHat based systems, all of the pam config files can be easily located with the below command.\n$ rpm -ql pam | grep /etc /etc/pam.d /etc/pam.d/config-util /etc/pam.d/fingerprint-auth /etc/pam.d/other /etc/pam.d/password-auth /etc/pam.d/postlogin /etc/pam.d/smartcard-auth /etc/pam.d/system-auth /etc/security /etc/security/access.conf /etc/security/chroot.conf /etc/security/console.apps /etc/security/console.handlers /etc/security/console.perms /etc/security/console.perms.d /etc/security/group.conf /etc/security/limits.conf /etc/security/limits.d /etc/security/limits.d/20-nproc.conf /etc/security/namespace.conf /etc/security/namespace.d /etc/security/namespace.init /etc/security/opasswd /etc/security/pam_env.conf /etc/security/sepermit.conf /etc/security/time.conf There are two main directories here: /etc/pam.d and /etc/security. Both of these directories play important roles in configuring PAM behaviour.\nEach file in the /etc/pam.d folder contains rules that are read by PAM at runtime. If the user attempts to login via ssh, he must be authenticated. PAM checks rules from the sshd file in the /etc/pam.d/ folder after sshd sends an authentication request to PAM. If the file is present, the file’s rules are read and a proper response is returned to the application. If the file is missing, the default behaviour is to read the rules from other file in same directory and act on them.\nLet’s take a look at /etc/pam.d/ folder to get better picture of what’s in it.\n$ ls -l /etc/pam.d -rw-r--r--. 1 root root 192 Feb 2 2021 chfn -rw-r--r--. 1 root root 192 Feb 2 2021 chsh -rw-r--r--. 1 root root 232 Apr 1 2020 config-util -rw-r--r--. 1 root root 287 Jan 13 2022 crond lrwxrwxrwx. 1 root root 19 Nov 18 13:01 fingerprint-auth -\u003e fingerprint-auth-ac -rw-r--r--. 1 root root 702 Nov 18 13:01 fingerprint-auth-ac -rw-r--r--. 1 root root 796 Feb 2 2021 login -rw-r--r--. 1 root root 154 Apr 1 2020 other -rw-r--r--. 1 root root 188 Apr 1 2020 passwd lrwxrwxrwx. 1 root root 16 Nov 18 13:01 password-auth -\u003e password-auth-ac -rw-r--r--. 1 root root 1033 Nov 18 13:01 password-auth-ac -rw-r--r--. 1 root root 155 Jan 25 2022 polkit-1 lrwxrwxrwx. 1 root root 12 Nov 18 13:01 postlogin -\u003e postlogin-ac -rw-r--r--. 1 root root 330 Nov 18 13:01 postlogin-ac -rw-r--r--. 1 root root 681 Feb 2 2021 remote -rw-r--r--. 1 root root 143 Feb 2 2021 runuser -rw-r--r--. 1 root root 138 Feb 2 2021 runuser-l lrwxrwxrwx. 1 root root 17 Nov 18 13:01 smartcard-auth -\u003e smartcard-auth-ac -rw-r--r--. 1 root root 752 Nov 18 13:01 smartcard-auth-ac lrwxrwxrwx. 1 root root 25 Nov 18 12:57 smtp -\u003e /etc/alternatives/mta-pam -rw-r--r--. 1 root root 76 Apr 1 2020 smtp.postfix -rw-r--r--. 1 root root 904 Nov 24 2021 sshd -rw-r--r--. 1 root root 540 Feb 2 2021 su -rw-r--r--. 1 root root 200 Oct 14 2021 sudo -rw-r--r--. 1 root root 178 Oct 14 2021 sudo-i -rw-r--r--. 1 root root 137 Feb 2 2021 su-l lrwxrwxrwx. 1 root root 14 Nov 18 13:01 system-auth -\u003e system-auth-ac -rw-r--r--. 1 root root 1031 Nov 18 13:01 system-auth-ac -rw-r--r--. 1 root root 129 Sep 1 14:57 systemd-user -rw-r--r--. 1 root root 84 Nov 24 2021 vlock There are more files than what the rpm command above revealed. The reason for this is straightforward: we examined files installed by the pam package itself. Other files are installed by the packages that they belong to. The openssh-server package, for example, installed the sshd file.\n$ rpm -qf /etc/pam.d/sshd openssh-server-7.4p1-22.el7_9.x86_64 We now know that pam has rule files for each application as well as a default other file for all applications that do not have dedicated rule files. We won’t always need this, but it’s a good idea to keep it in the back of our minds.\nLet’s take a closer look at these rules from the sshd file.\n$ cat /etc/pam.d/sshd #%PAM-1.0 auth\trequired\tpam_sepermit.so auth substack password-auth auth include postlogin # Used with polkit to reauthorize users in remote sessions -auth optional pam_reauthorize.so prepare account required pam_nologin.so account include password-auth password include password-auth # pam_selinux.so close should be the first session rule session required pam_selinux.so close session required pam_loginuid.so # pam_selinux.so open should only be followed by sessions to be executed in the user context session required pam_selinux.so open env_params session required pam_namespace.so session optional pam_keyinit.so force revoke session include password-auth session include postlogin # Used with polkit to reauthorize users in remote sessions -session optional pam_reauthorize.so prepare Lines beginning with # are clearly identified as comments, while the rest of the lines contain a single rule in a line.\nEach rule follows a similar structure but uses different keywords. The generic rule syntax looks like this:\ntype control module [modules arguments] There are 4 types of type in the PAM rules file.\nauth : rules for authentication. account : rules for account management, like expired passwords and allowed time of login. password : rules for password management, like checking password quality. These rules are only used when applications are changing the password used for auth. session : rules for session management. They typically run at the start or end of the session. And there are 6 common types of control:\nrequired : if it fails, everything fails; if it passes, go to next. sufficient : if it passes, everything passes; if it fails, go to next. requisite : same as required- but stops on error. optional : pam ignores it (pass or fail); if this is the only module in stack then it decides if fail or pass. include : include rules from other pam files. if stack fails, return control to application. substack : works like include. but if the substack fails, return to the parent stack instead of giving control back to application. The module (and any parameters, if any) follows. By default, PAM will look for modules in the /usr/lib64/security directory, but you can prevent this behaviour by specifying the absolute path of the module. Some modules rely on external configuration files, which can be found in the /etc/security directory.\nFew common modules Before delving into the actual PAM rules files, we should first understand how a few of the most common modules behave. This will make interpreting the rules from the rules file much easier.\npam_succeed_if.so This module is designed to succeed or fail auth based on the characterstics of the user trying to log in and the arguments passed to the module. If all the arguments passed to the module matches the characterstics of the user trying to log in, then and only then, this module returns success.\npam_selinux.so This command sets the apropriate selinux security context. This can be used to set context when a session starts and restore it back.\npam_permit.so This is the simplest of all. It just permits acess and does nothing else. With that said, you should consider this module very dangerous in wrong hands.\npam_limits.so As its name suggests, this module sets the limits on the system resources for a user-session. Root user(uid=0) are also affected with this module.\nThere are many limits that can be configured, so there is a dedicated folder to host configuration files for it - /etc/security/limits.d. Alternatively, there is a /etc/security/limits.conf file. But its a good practice to have separate config files if possible.\npam_pwquality.so This module was developed by RedHat. The only action of this module is to prompt the user for the password and check its strength. To check its strenght, the modules uses a dictionary (of weak password) to see it the entered password is part of it. If the password is not in the list, then that password is checked against a set of rules defined by admin.\nThese rules are configurable either by the use of module arguments or /etc/security/pwquality.conf config file.\npam_rootok.so This rule authenticates the user if the real uid is 0. No questions asked!\nIf you don’t know about what is a real and effective UID, read this 2.\npam_faildelay.so This module sets the delay on failure. Like when a user types wron password, it fails and the next prompt is delayed by this module. If the delay is not given, then it will use FAIL_DELAY from /etc/login.defs.\npam_unix.so This is the standard unix authnetication module. Usually it uses /etc/passwd and /etc/shadow (if shadow is enabled) to authenticate the user. There are many tasks that can be performed by this module like checking the expire or last change of the password.\nThe session component of this module logs when user logins or logs out of the system.\npam_deny.so Just like pam_permit.so, this module is very simple and straightforward. This denies the access to everybody.\npam_warn.so This module logs the service, terminal, user, or anything to syslog. This module always return PAM_IGNORE, so it just log events and have no participation in authentication process apart from that.\nWe’re almost there now. Before we go any further, there are a few more things we should consider:\nPAM rules are parsed from top to bottom. If a sufficient rule is passed, then none of the below rules will be checked.\nSome of the rules start with - character, indicating that PAM should ignore them silently if the module is missing.\nIf you want to know anything about a module, there is usually a man page available. The majority of the manpages for these modules provide examples of usage and return types.\nMaking changes to PAM files has immediate effect. You do not need to restart. As a result, it’s a good idea to keep a backup of the files before making any changes.\nAny error in the PAM files has the potential to log you out of your system permanently. Keeping a live root shell while testing is therefore beneficial. If you made a mistake, you can undo your changes using this shell.\nUsecases enforcing strong passwords Let’s apply everything we’ve learned so far to observe how PAM responds to password changes made with the passwd utility.\nWe now know that the /etc/pam.d/passwd file will be used by passwd (if it exists; else, /etc/pam.d/other will be read). This file will provide the procedures to be followed when sshd is used for any type of authentication and authorization.\nThis makes it obvious for us to go and checkout the /etc/pam.d/passwd file…\n$ cat /etc/pam.d/passwd #%PAM-1.0 auth include\tsystem-auth account include\tsystem-auth password substack\tsystem-auth -password optional\tpam_gnome_keyring.so use_authtok password substack\tpostlogin Analysing this file let us know that this module includes system-auth rules file. So we’ll now inspect the rules mentioned in /etc/pam.d/system-auth file.\n$ cat /etc/pam.d/system-auth #%PAM-1.0 # This file is auto-generated. # User changes will be destroyed the next time authconfig is run. auth required pam_env.so auth required pam_faildelay.so delay=2000000 auth sufficient pam_unix.so nullok try_first_pass auth requisite pam_succeed_if.so uid \u003e= 1000 quiet_success auth required pam_deny.so account required pam_unix.so account sufficient pam_localuser.so account sufficient pam_succeed_if.so uid \u003c 1000 quiet account required pam_permit.so password requisite pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type= password sufficient pam_unix.so sha512 shadow nullok try_first_pass use_authtok password required pam_deny.so session optional pam_keyinit.so revoke session required pam_limits.so -session optional pam_systemd.so session [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid session required pam_unix.so Only the password type is relevant for our intended task out of all of these rules.\npassword requisite pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type= password sufficient pam_unix.so sha512 shadow nullok try_first_pass use_authtok password required pam_deny.so requisite\tpam_pwquality.so try_first_pass local_users_only retry=3 authtok_type= This rule checks the quality of password using some predefined configuration that are mentioned in /etc/security/pwquality.conf or can be explicitely dictated via module arguments. The try_first_pass option tells to load the password from previous rule (if any), else this module will make prompt user for password. local_users_only option will tell pam_pwquality.so module to ignore the users that are not in the /etc/passwd file. retry option is the number of tries a user gets to pick an acceptable password before the module returns an error. By default, the prompt the user gets when entering their password is “New password:”. If the administrator sets authtok_type=FOO, the prompt becomes “New FOO password:”. Here the default behaviour will be expected.\nsufficient pam_unix.so sha512 shadow nullok try_first_pass use_authtok For pam_unix, the sha512 option means use a password hashing routine based on the SHA512 algorithm. blowfish is also supported along with several other, less secure, choices. The shadow option means maintain password hashes in a separate /etc/shadow file that is only readable by the root user. This option should always be set. nullok means allow user accounts that have null password entries. Personally, I would recommend removing this option.\nrequired pam_deny.so If the above modules failed, this should return with a deny message.\nNow, say you want to enforce the following policy…\n- prompt 2 times for password in case of an error (retry option) - 12 characters minimum length - at least 6 characters should be different from old password when entering a new one (difok option) - at least 1 digit (dcredit option) - at least 1 uppercase (ucredit option) - at least 1 lowercase (lcredit option) - at least 1 other character (ocredit option) - cannot contain the words \"qwerty\" and \"password\" - enforce the policy for root as well. … necessary changes that are needed to make are as below\npassword requisite pam_pwquality.so try_first_pass local_users_only retry=2 minlen=12 difok=6 dcredit=-1 ucredit=-1 ocredit=-1 lcredit=-1 [badwords=qwerty password] enforce_for_root password sufficient pam_unix.so sha512 shadow nullok try_first_pass use_authtok password required pam_deny.so The changes to the system-auth file described above will affect all applications that rely on that rule file. If changes are made to the passwd file, they will only affect the passwd utility.\nWe can also use the authconfig utility to make nearly all of these changes without having to interact directly with the associated files. More information can be found here . 3\nlock out at multiple failed attempts We can also use PAM to configure the system so that if a single user makes multiple failed attempts, the PAM will lock out that user for a set period of time. Similarly to how your mobile device locks out the user for the next few hours if multiple login attempts fail.\nThis is possible with the pam faillock module. Because there is no dedicated config file for this module, all configuration will be done through module arguments. You can either manually edit the rule files with your favourite text editor or use the authconfig utility to make changes.\nBefore you begin, you must determine whether or not pam_faillock is enabled. This can be verified using\nauthconfig --test | grep pam_faillock For me the default output was\npam_faillock is disabled (deny=4 unlock_time=1200) So I had to enable it via authconfig --enablefaillock and along with that you can pass module arguments via authconfig --faillockargs= flag.\nOr, one can combine both of the actions in a single command like\nauthconfig --enablefaillock --faillockargs=\"fail_interval=30 deny=3 unlock_time=3600\" --update The above command will add pam_faillock rule in all of the relevant rules file (located in /etc/pam.d/ directory). And the rest of the commands will configure the behaviour of the pam_faillock module. All of the module options can be checked with man pam_faillock.\nNow the output of below command is slight different.\nauthconfig --test | grep pam_faillock Output:\npam_faillock is enabled (fail_interval=30 deny=3 unlock_time=3600) You can list the failed login attempts with the faillock command.\nTTy auditing ( *cough* keylogging *cough*) Audit system (In Redhat or similar linux distros) uses pam_tty_audit PAM module for auditing of TTY input. When user logins, this module logs all keystrokes that user makes to /var/log/audit/audit.log file.\nSince this depends on auditd service and requires that to be configured and running properly.\nThere is no authconfig flag that can enable this (atleast, there is none in centos 7.5), so we’ll have to follow the traditional way of editing files manually to configure it.\nThis module only provides support for session type. That means we can only add session rules to our required files and it’ll take effect immidiately for that service.\nMy idea is to add this rule in /etc/pam.d/system-auth and /etc/pam.d/password-auth.\nsession required pam_tty_audit.so enable=* The above rule will capture all of the tty inputs as it is and store them in /var/log/audit/audit.log file (by default). You can easily grep stuff from that or use a proper tool to query the logs… like aureport.\naureport --tty command filters all TYPE=tty logs events from the file and display them in very human readable format.\nbackdooring Till this point, we have learnt a lot about PAM and it is time to rethink on the basics once again. PAM has 3 components: user, password and service. It’s role is to authenticate a user to a service with provided password.\nIt works elegantly with the help of some service files of same name as of the service itself. These files are located in /etc/pam.d/ directory. Each file has one or more rules that helps PAM to take proper decisions.\nThere are a lot of methods with which we can backdoor the PAM system. One of the many ways is to use pam_exec.so module to run an arbitrary command at each PAM based event. Another way could be to add rule using pam_permit.so module, that will skip the required checks to authenticate user for that service.\nThe above techniques are very noisy and are easily detected. More sophesticated attacks would include replacing the original module with custom compiled infected module on target system… or function hooking via LD_PRELOAD technique.\nI’ll leave the practical part upto you. Please don’t do anything stupid or unethical on production server or any other system without the owner’s consent.\nKeep it healthy and stay safe!!\nResources: https://likegeeks.com/linux-pam-easy-guide/ https://aplawrence.com/Basics/understandingpam.html https://www.linux.com/news/understanding-pam/ https://developer.ibm.com/tutorials/l-pam/ https://github.com/linux-pam/linux-pam (Source code) https://wiki.archlinux.org/title/PAM#Examples https://lwn.net/Articles/470764/ (A look at PAM face-recognition authentication) https://lwn.net/Articles/523199/ (Google Authenticator for multi-factor authentication) https://github.com/linux-pam/linux-pam/blob/b872b6e68a60ae351ca4c7eea6dfe95cd8f8d130/libpam/include/security/_pam_types.h#L29 ↩︎\n(https://stackoverflow.com/questions/32455684/difference-between-real-user-id-effective-user-id-and-saved-user-id) ↩︎\nhttps://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system-level_authentication_guide/authconfig-pwd#authconfig-pwd-cmd ↩︎\n","wordCount":"3879","inLanguage":"en","datePublished":"2022-12-27T23:25:23+05:30","dateModified":"2023-11-07T00:10:13+05:30","author":[{"@type":"Person","name":"ayedaemon"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://ayedaemon.github.io/post/2022/12/pluggable-authentication-modules-linux/"},"publisher":{"@type":"Organization","name":"Connected","logo":{"@type":"ImageObject","url":"https://ayedaemon.github.io/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://ayedaemon.github.io/ accesskey=h title="Connected (Alt + H)">Connected</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://ayedaemon.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://ayedaemon.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://ayedaemon.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://ayedaemon.github.io/series/ title=Series><span>Series</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ayedaemon.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://ayedaemon.github.io/post/>Posts</a></div><h1 class=post-title>Pluggable Authentication Modules - Linux</h1><div class=post-description>Linux-PAM is a system of libraries that handle the authentication tasks of applications (services) on the system.</div><div class=post-meta><span title='2022-12-27 23:25:23 +0530 +0530'>December 27, 2022</span>&nbsp;·&nbsp;19 min&nbsp;·&nbsp;3879 words&nbsp;·&nbsp;ayedaemon&nbsp;|&nbsp;<a href=https://github.com/ayedaemon/ayedaemon.github.io/tree/main/content/post/2022/12/pluggable-authentication-modules-linux.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#pam---what-and-why>PAM - What and Why</a></li><li><a href=#understanding-pam>Understanding PAM</a></li><li><a href=#configuring-pam>Configuring PAM</a><ul><li><a href=#few-common-modules>Few common modules</a></li></ul></li><li><a href=#usecases>Usecases</a><ul><li><a href=#enforcing-strong-passwords>enforcing strong passwords</a></li><li><a href=#lock-out-at-multiple-failed-attempts>lock out at multiple failed attempts</a></li><li><a href=#tty-auditing--cough--keylogging--cough>TTy auditing ( *cough* keylogging *cough*)</a></li><li><a href=#backdooring>backdooring</a></li></ul></li><li><a href=#resources>Resources:</a></li></ul></nav></div></details></div><div class=post-content><h2 id=pam---what-and-why>PAM - What and Why<a hidden class=anchor aria-hidden=true href=#pam---what-and-why>#</a></h2><p>Authenticating a user to a service used to be a time-consuming process. The application had to be aware of all possible authentication mechanisms and had to be rebuilt every time a new authentication method was introduced&mldr; As a result, there was a significant amount of code repetition. Naturally, it was disliked by everyone!!</p><p>As a result, the concept of a middle-ware application responsible for user authentication to a service arose. And, Pluggable Authentication Modules (PAM), a collection of modules that act as a barrier between a service on your system and the service&rsquo;s user, were created.</p><p>Modules can include a variety of functions, such as disabling login for specific users/groups, limiting resources, audting, and so on. PAM is now supported by the vast majority of major unix flavours, including AIX, HP-US, FreeBSD, and nearly all Linux distributions.</p><p>The big advantage here is that security is no longer a concern for the application: if PAM says &ldquo;it&rsquo;s OK&rdquo;, it&rsquo;s OK. That simplifies things for both the application developer and the system administrator.</p><h2 id=understanding-pam>Understanding PAM<a hidden class=anchor aria-hidden=true href=#understanding-pam>#</a></h2><p>According to <code>man (8) pam</code>,</p><blockquote><p>Linux-PAM is a system of libraries that handle the authentication tasks of applications (services) on the system. The library provides a stable general interface (Application Programming Interface - API) that privilege granting programs (such as login(1) and su(1)) defer to to perform standard authentication tasks.</p></blockquote><p>These libraries are typically configurable via defined arguments or dedicated configuration files. Internal behavior of the Linux-pam library is trivial from the standpoint of a sysadmin. The key point is to define the relationship between applications and the PAM.</p><p>The below diagram gives an idea of how PAM works.</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 760 553"><g transform="translate(8,16)"><text text-anchor="middle" x="104" y="260" fill="currentcolor" style="font-size:1em">┌</text><text text-anchor="middle" x="104" y="276" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="104" y="292" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="104" y="308" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="104" y="324" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="104" y="340" fill="currentcolor" style="font-size:1em">├</text><text text-anchor="middle" x="104" y="356" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="104" y="372" fill="currentcolor" style="font-size:1em">└</text><text text-anchor="middle" x="112" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="112" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="112" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="112" y="452" fill="currentcolor" style="font-size:1em">┌</text><text text-anchor="middle" x="112" y="468" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="112" y="484" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="112" y="500" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="112" y="516" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="112" y="532" fill="currentcolor" style="font-size:1em">└</text><text text-anchor="middle" x="120" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="120" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="120" y="356" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="120" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="120" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="120" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="128" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="128" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="128" y="356" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="128" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="128" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="128" y="484" fill="currentcolor" style="font-size:1em">/</text><text text-anchor="middle" x="128" y="516" fill="currentcolor" style="font-size:1em">/</text><text text-anchor="middle" x="128" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="136" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="136" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="136" y="356" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="136" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="136" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="136" y="484" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="136" y="516" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="136" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="144" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="144" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="144" y="356" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="144" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="144" y="388" fill="currentcolor" style="font-size:1em"/><text text-anchor="middle" x="144" y="404" fill="currentcolor" style="font-size:1em"/><text text-anchor="middle" x="144" y="420" fill="currentcolor" style="font-size:1em"/><text text-anchor="middle" x="144" y="436" fill="currentcolor" style="font-size:1em"/><text text-anchor="middle" x="144" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="144" y="484" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="144" y="516" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="144" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="152" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="152" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="152" y="356" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="152" y="372" fill="currentcolor" style="font-size:1em">┬</text><text text-anchor="middle" x="152" y="388" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="152" y="404" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="152" y="420" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="152" y="436" fill="currentcolor" style="font-size:1em">▼</text><text text-anchor="middle" x="152" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="152" y="484" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="152" y="516" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="152" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="160" y="68" fill="currentcolor" style="font-size:1em"/><text text-anchor="middle" x="160" y="84" fill="currentcolor" style="font-size:1em"/><text text-anchor="middle" x="160" y="100" fill="currentcolor" style="font-size:1em"/><text text-anchor="middle" x="160" y="116" fill="currentcolor" style="font-size:1em"/><text text-anchor="middle" x="160" y="132" fill="currentcolor" style="font-size:1em"/><text text-anchor="middle" x="160" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="160" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="160" y="356" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="160" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="160" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="160" y="484" fill="currentcolor" style="font-size:1em">/</text><text text-anchor="middle" x="160" y="516" fill="currentcolor" style="font-size:1em">/</text><text text-anchor="middle" x="160" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="168" y="68" fill="currentcolor" style="font-size:1em">┌</text><text text-anchor="middle" x="168" y="84" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="168" y="100" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="168" y="116" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="168" y="132" fill="currentcolor" style="font-size:1em">└</text><text text-anchor="middle" x="168" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="168" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="168" y="356" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="168" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="168" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="168" y="484" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="168" y="516" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="168" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="176" y="68" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="176" y="132" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="176" y="148" fill="currentcolor" style="font-size:1em"/><text text-anchor="middle" x="176" y="164" fill="currentcolor" style="font-size:1em"/><text text-anchor="middle" x="176" y="180" fill="currentcolor" style="font-size:1em"/><text text-anchor="middle" x="176" y="196" fill="currentcolor" style="font-size:1em"/><text text-anchor="middle" x="176" y="212" fill="currentcolor" style="font-size:1em"/><text text-anchor="middle" x="176" y="228" fill="currentcolor" style="font-size:1em"/><text text-anchor="middle" x="176" y="244" fill="currentcolor" style="font-size:1em"/><text text-anchor="middle" x="176" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="176" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="176" y="356" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="176" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="176" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="176" y="484" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="176" y="516" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="176" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="184" y="68" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="184" y="132" fill="currentcolor" style="font-size:1em">┬</text><text text-anchor="middle" x="184" y="148" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="184" y="164" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="184" y="180" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="184" y="196" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="184" y="212" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="184" y="228" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="184" y="244" fill="currentcolor" style="font-size:1em">▼</text><text text-anchor="middle" x="184" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="184" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="184" y="356" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="184" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="184" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="184" y="484" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="184" y="516" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="184" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="192" y="68" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="192" y="132" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="192" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="192" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="192" y="356" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="192" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="192" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="192" y="484" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="192" y="516" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="192" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="200" y="68" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="200" y="100" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="200" y="132" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="200" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="200" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="200" y="356" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="200" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="200" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="200" y="484" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="200" y="516" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="200" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="208" y="68" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="208" y="100" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="208" y="132" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="208" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="208" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="208" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="208" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="208" y="484" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="208" y="516" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="208" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="216" y="68" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="216" y="100" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="216" y="132" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="216" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="216" y="340" fill="currentcolor" style="font-size:1em">┬</text><text text-anchor="middle" x="216" y="356" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="216" y="372" fill="currentcolor" style="font-size:1em">┴</text><text text-anchor="middle" x="216" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="216" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="224" y="68" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="224" y="132" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="224" y="148" fill="currentcolor" style="font-size:1em">▲</text><text text-anchor="middle" x="224" y="164" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="224" y="180" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="224" y="196" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="224" y="212" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="224" y="228" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="224" y="244" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="224" y="260" fill="currentcolor" style="font-size:1em">┴</text><text text-anchor="middle" x="224" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="224" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="224" y="452" fill="currentcolor" style="font-size:1em">┐</text><text text-anchor="middle" x="224" y="468" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="224" y="484" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="224" y="500" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="224" y="516" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="224" y="532" fill="currentcolor" style="font-size:1em">┘</text><text text-anchor="middle" x="232" y="68" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="232" y="100" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="232" y="132" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="232" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="232" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="232" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="240" y="68" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="240" y="132" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="240" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="240" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="240" y="356" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="240" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="248" y="68" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="248" y="132" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="248" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="248" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="248" y="356" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="248" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="248" y="452" fill="currentcolor" style="font-size:1em">┌</text><text text-anchor="middle" x="248" y="468" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="248" y="484" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="248" y="500" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="248" y="516" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="248" y="532" fill="currentcolor" style="font-size:1em">└</text><text text-anchor="middle" x="256" y="68" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="256" y="132" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="256" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="256" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="256" y="356" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="256" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="256" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="256" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="264" y="68" fill="currentcolor" style="font-size:1em">┐</text><text text-anchor="middle" x="264" y="84" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="264" y="100" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="264" y="116" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="264" y="132" fill="currentcolor" style="font-size:1em">┘</text><text text-anchor="middle" x="264" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="264" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="264" y="356" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="264" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="264" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="264" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="272" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="272" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="272" y="356" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="272" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="272" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="272" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="280" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="280" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="280" y="356" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="280" y="372" fill="currentcolor" style="font-size:1em">┬</text><text text-anchor="middle" x="280" y="388" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="280" y="404" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="280" y="420" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="280" y="436" fill="currentcolor" style="font-size:1em">▼</text><text text-anchor="middle" x="280" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="280" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="288" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="288" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="288" y="356" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="288" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="288" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="288" y="500" fill="currentcolor" style="font-size:1em">L</text><text text-anchor="middle" x="288" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="296" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="296" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="296" y="356" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="296" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="296" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="296" y="500" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="296" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="304" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="304" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="304" y="356" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="304" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="304" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="304" y="500" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="304" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="312" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="312" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="312" y="356" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="312" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="312" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="312" y="500" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="312" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="320" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="320" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="320" y="356" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="320" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="320" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="320" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="328" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="328" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="328" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="328" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="328" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="336" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="336" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="336" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="336" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="336" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="344" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="344" y="340" fill="currentcolor" style="font-size:1em">┬</text><text text-anchor="middle" x="344" y="356" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="344" y="372" fill="currentcolor" style="font-size:1em">┴</text><text text-anchor="middle" x="344" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="344" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="352" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="352" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="352" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="352" y="452" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="352" y="532" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="360" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="360" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="360" y="356" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="360" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="360" y="452" fill="currentcolor" style="font-size:1em">┐</text><text text-anchor="middle" x="360" y="468" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="360" y="484" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="360" y="500" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="360" y="516" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="360" y="532" fill="currentcolor" style="font-size:1em">┘</text><text text-anchor="middle" x="368" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="368" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="368" y="356" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="368" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="376" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="376" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="376" y="356" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="376" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="384" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="384" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="384" y="356" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="384" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="392" y="52" fill="currentcolor" style="font-size:1em">┌</text><text text-anchor="middle" x="392" y="68" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="392" y="84" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="392" y="100" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="392" y="116" fill="currentcolor" style="font-size:1em">└</text><text text-anchor="middle" x="392" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="392" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="392" y="356" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="392" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="400" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="400" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="400" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="400" y="308" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="400" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="400" y="356" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="400" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="408" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="408" y="116" fill="currentcolor" style="font-size:1em">┬</text><text text-anchor="middle" x="408" y="132" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="408" y="148" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="408" y="164" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="408" y="180" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="408" y="196" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="408" y="212" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="408" y="228" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="408" y="244" fill="currentcolor" style="font-size:1em">▼</text><text text-anchor="middle" x="408" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="408" y="308" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="408" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="408" y="356" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="408" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="416" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="416" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="416" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="416" y="308" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="416" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="416" y="356" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="416" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="424" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="424" y="84" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="424" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="424" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="424" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="424" y="356" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="424" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="432" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="432" y="84" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="432" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="432" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="432" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="432" y="356" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="432" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="440" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="440" y="84" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="440" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="440" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="440" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="440" y="356" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="440" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="448" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="448" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="448" y="132" fill="currentcolor" style="font-size:1em">▲</text><text text-anchor="middle" x="448" y="148" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="448" y="164" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="448" y="180" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="448" y="196" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="448" y="212" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="448" y="228" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="448" y="244" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="448" y="260" fill="currentcolor" style="font-size:1em">┴</text><text text-anchor="middle" x="448" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="448" y="356" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="448" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="456" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="456" y="84" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="456" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="456" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="456" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="456" y="356" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="456" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="464" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="464" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="464" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="464" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="464" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="472" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="472" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="472" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="472" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="472" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="480" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="480" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="480" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="480" y="340" fill="currentcolor" style="font-size:1em">┬</text><text text-anchor="middle" x="480" y="356" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="480" y="372" fill="currentcolor" style="font-size:1em">┴</text><text text-anchor="middle" x="488" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="488" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="488" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="488" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="488" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="496" y="52" fill="currentcolor" style="font-size:1em">┐</text><text text-anchor="middle" x="496" y="68" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="496" y="84" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="496" y="100" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="496" y="116" fill="currentcolor" style="font-size:1em">┘</text><text text-anchor="middle" x="496" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="496" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="496" y="356" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="496" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="504" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="504" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="504" y="356" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="504" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="512" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="512" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="512" y="356" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="512" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="520" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="520" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="520" y="356" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="520" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="528" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="528" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="528" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="536" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="536" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="536" y="356" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="536" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="544" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="544" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="544" y="356" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="544" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="552" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="552" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="552" y="356" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="552" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="560" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="560" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="560" y="356" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="560" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="568" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="568" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="568" y="356" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="568" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="576" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="576" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="576" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="584" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="584" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="584" y="356" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="584" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="592" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="592" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="592" y="356" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="592" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="600" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="600" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="600" y="356" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="600" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="608" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="608" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="608" y="356" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="608" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="616" y="52" fill="currentcolor" style="font-size:1em">┌</text><text text-anchor="middle" x="616" y="68" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="616" y="84" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="616" y="100" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="616" y="116" fill="currentcolor" style="font-size:1em">└</text><text text-anchor="middle" x="616" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="616" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="616" y="356" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="616" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="624" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="624" y="116" fill="currentcolor" style="font-size:1em">┬</text><text text-anchor="middle" x="624" y="132" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="624" y="148" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="624" y="164" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="624" y="180" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="624" y="196" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="624" y="212" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="624" y="228" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="624" y="244" fill="currentcolor" style="font-size:1em">▼</text><text text-anchor="middle" x="624" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="624" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="624" y="356" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="624" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="632" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="632" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="632" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="632" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="632" y="356" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="632" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="640" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="640" y="84" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="640" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="640" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="640" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="640" y="356" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="640" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="648" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="648" y="84" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="648" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="648" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="648" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="648" y="356" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="648" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="656" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="656" y="84" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="656" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="656" y="132" fill="currentcolor" style="font-size:1em">▲</text><text text-anchor="middle" x="656" y="148" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="656" y="164" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="656" y="180" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="656" y="196" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="656" y="212" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="656" y="228" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="656" y="244" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="656" y="260" fill="currentcolor" style="font-size:1em">┴</text><text text-anchor="middle" x="656" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="656" y="356" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="656" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="664" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="664" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="664" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="664" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="664" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="672" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="672" y="84" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="672" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="672" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="672" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="672" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="680" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="680" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="680" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="680" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="680" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="688" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="688" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="688" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="688" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="688" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="696" y="52" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="696" y="116" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="696" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="696" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="696" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="704" y="52" fill="currentcolor" style="font-size:1em">┐</text><text text-anchor="middle" x="704" y="68" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="704" y="84" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="704" y="100" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="704" y="116" fill="currentcolor" style="font-size:1em">┘</text><text text-anchor="middle" x="704" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="704" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="704" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="712" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="712" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="712" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="720" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="720" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="720" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="728" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="728" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="728" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="736" y="260" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="736" y="340" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="736" y="372" fill="currentcolor" style="font-size:1em">─</text><text text-anchor="middle" x="744" y="260" fill="currentcolor" style="font-size:1em">┐</text><text text-anchor="middle" x="744" y="276" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="744" y="292" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="744" y="308" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="744" y="324" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="744" y="340" fill="currentcolor" style="font-size:1em">┤</text><text text-anchor="middle" x="744" y="356" fill="currentcolor" style="font-size:1em">│</text><text text-anchor="middle" x="744" y="372" fill="currentcolor" style="font-size:1em">┘</text></g></svg></div><p>Assume the user attempts to log into <code>APP 1</code>, which checks the PAM to see if the user is authenticated and authorised. If the query is successful, PAM returns the status code <code>PAM_SUCCESS</code>; otherwise, it returns one of the other relevant codes.
The complete list of return codes and their meanings can be found in their github repository, which can be found <a href=https://github.com/linux-pam/linux-pam/blob/b872b6e68a60ae351ca4c7eea6dfe95cd8f8d130/libpam/include/security/_pam_types.h#L29>here</a>. <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><h2 id=configuring-pam>Configuring PAM<a hidden class=anchor aria-hidden=true href=#configuring-pam>#</a></h2><p>PAM&rsquo;s main feature is the module configuration it offers. PAM looks at these text configuration files to determine what security actions to take for an application, and the administrator can add or remove new rules at any time. PAM is also extensible, which means that if we want to add new features (such as 2FA/MFA), we only need to change a few files and <code>login</code> can now use them.</p><p>In RedHat based systems, all of the pam config files can be easily located with the below command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ rpm -ql pam | grep /etc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/etc/pam.d
</span></span><span class=line><span class=cl>/etc/pam.d/config-util
</span></span><span class=line><span class=cl>/etc/pam.d/fingerprint-auth
</span></span><span class=line><span class=cl>/etc/pam.d/other
</span></span><span class=line><span class=cl>/etc/pam.d/password-auth
</span></span><span class=line><span class=cl>/etc/pam.d/postlogin
</span></span><span class=line><span class=cl>/etc/pam.d/smartcard-auth
</span></span><span class=line><span class=cl>/etc/pam.d/system-auth
</span></span><span class=line><span class=cl>/etc/security
</span></span><span class=line><span class=cl>/etc/security/access.conf
</span></span><span class=line><span class=cl>/etc/security/chroot.conf
</span></span><span class=line><span class=cl>/etc/security/console.apps
</span></span><span class=line><span class=cl>/etc/security/console.handlers
</span></span><span class=line><span class=cl>/etc/security/console.perms
</span></span><span class=line><span class=cl>/etc/security/console.perms.d
</span></span><span class=line><span class=cl>/etc/security/group.conf
</span></span><span class=line><span class=cl>/etc/security/limits.conf
</span></span><span class=line><span class=cl>/etc/security/limits.d
</span></span><span class=line><span class=cl>/etc/security/limits.d/20-nproc.conf
</span></span><span class=line><span class=cl>/etc/security/namespace.conf
</span></span><span class=line><span class=cl>/etc/security/namespace.d
</span></span><span class=line><span class=cl>/etc/security/namespace.init
</span></span><span class=line><span class=cl>/etc/security/opasswd
</span></span><span class=line><span class=cl>/etc/security/pam_env.conf
</span></span><span class=line><span class=cl>/etc/security/sepermit.conf
</span></span><span class=line><span class=cl>/etc/security/time.conf
</span></span></code></pre></div><p>There are two main directories here: <code>/etc/pam.d</code> and <code>/etc/security</code>. Both of these directories play important roles in configuring PAM behaviour.</p><p>Each file in the <code>/etc/pam.d</code> folder contains rules that are read by PAM at runtime. If the user attempts to login via <code>ssh</code>, he must be authenticated. PAM checks rules from the <code>sshd</code> file in the <code>/etc/pam.d/</code> folder after <strong>sshd</strong> sends an authentication request to PAM. If the file is present, the file&rsquo;s rules are read and a proper response is returned to the application. If the file is missing, the default behaviour is to read the rules from <code>other</code> file in same directory and act on them.</p><p>Let&rsquo;s take a look at <code>/etc/pam.d/</code> folder to get better picture of what&rsquo;s in it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ls -l /etc/pam.d
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  192 Feb  2  2021 chfn
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  192 Feb  2  2021 chsh
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  232 Apr  1  2020 config-util
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  287 Jan 13  2022 crond
</span></span><span class=line><span class=cl>lrwxrwxrwx. 1 root root   19 Nov 18 13:01 fingerprint-auth -&gt; fingerprint-auth-ac
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  702 Nov 18 13:01 fingerprint-auth-ac
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  796 Feb  2  2021 login
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  154 Apr  1  2020 other
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  188 Apr  1  2020 passwd
</span></span><span class=line><span class=cl>lrwxrwxrwx. 1 root root   16 Nov 18 13:01 password-auth -&gt; password-auth-ac
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root 1033 Nov 18 13:01 password-auth-ac
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  155 Jan 25  2022 polkit-1
</span></span><span class=line><span class=cl>lrwxrwxrwx. 1 root root   12 Nov 18 13:01 postlogin -&gt; postlogin-ac
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  330 Nov 18 13:01 postlogin-ac
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  681 Feb  2  2021 remote
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  143 Feb  2  2021 runuser
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  138 Feb  2  2021 runuser-l
</span></span><span class=line><span class=cl>lrwxrwxrwx. 1 root root   17 Nov 18 13:01 smartcard-auth -&gt; smartcard-auth-ac
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  752 Nov 18 13:01 smartcard-auth-ac
</span></span><span class=line><span class=cl>lrwxrwxrwx. 1 root root   25 Nov 18 12:57 smtp -&gt; /etc/alternatives/mta-pam
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root   76 Apr  1  2020 smtp.postfix
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  904 Nov 24  2021 sshd
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  540 Feb  2  2021 su
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  200 Oct 14  2021 sudo
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  178 Oct 14  2021 sudo-i
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  137 Feb  2  2021 su-l
</span></span><span class=line><span class=cl>lrwxrwxrwx. 1 root root   14 Nov 18 13:01 system-auth -&gt; system-auth-ac
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root 1031 Nov 18 13:01 system-auth-ac
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root  129 Sep  1 14:57 systemd-user
</span></span><span class=line><span class=cl>-rw-r--r--. 1 root root   84 Nov 24  2021 vlock
</span></span></code></pre></div><p>There are more files than what the rpm command above revealed. The reason for this is straightforward: we examined files installed by the <code>pam</code> package itself. Other files are installed by the packages that they belong to. The <code>openssh-server</code> package, for example, installed the <code>sshd</code> file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ rpm -qf /etc/pam.d/sshd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>openssh-server-7.4p1-22.el7_9.x86_64
</span></span></code></pre></div><p>We now know that pam has rule files for each application as well as a default <code>other</code> file for all applications that do not have dedicated rule files. We won&rsquo;t always need this, but it&rsquo;s a good idea to keep it in the back of our minds.</p><p>Let&rsquo;s take a closer look at these rules from the <code>sshd</code> file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ cat /etc/pam.d/sshd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#%PAM-1.0
</span></span><span class=line><span class=cl>auth	   required	pam_sepermit.so
</span></span><span class=line><span class=cl>auth       substack     password-auth
</span></span><span class=line><span class=cl>auth       include      postlogin
</span></span><span class=line><span class=cl># Used with polkit to reauthorize users in remote sessions
</span></span><span class=line><span class=cl>-auth      optional     pam_reauthorize.so prepare
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>account    required     pam_nologin.so
</span></span><span class=line><span class=cl>account    include      password-auth
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>password   include      password-auth
</span></span><span class=line><span class=cl># pam_selinux.so close should be the first session rule
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>session    required     pam_selinux.so close
</span></span><span class=line><span class=cl>session    required     pam_loginuid.so
</span></span><span class=line><span class=cl># pam_selinux.so open should only be followed by sessions to be executed in the user context
</span></span><span class=line><span class=cl>session    required     pam_selinux.so open env_params
</span></span><span class=line><span class=cl>session    required     pam_namespace.so
</span></span><span class=line><span class=cl>session    optional     pam_keyinit.so force revoke
</span></span><span class=line><span class=cl>session    include      password-auth
</span></span><span class=line><span class=cl>session    include      postlogin
</span></span><span class=line><span class=cl># Used with polkit to reauthorize users in remote sessions
</span></span><span class=line><span class=cl>-session   optional     pam_reauthorize.so prepare
</span></span></code></pre></div><p>Lines beginning with <code>#</code> are clearly identified as comments, while the rest of the lines contain a single rule in a line.</p><p>Each rule follows a similar structure but uses different keywords. The generic rule syntax looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>type    control    module [modules arguments]
</span></span></code></pre></div><p>There are 4 types of <code>type</code> in the PAM rules file.</p><ul><li><strong>auth</strong> : rules for authentication.</li><li><strong>account</strong> : rules for account management, like expired passwords and allowed time of login.</li><li><strong>password</strong> : rules for password management, like checking password quality. These rules are only used when applications are changing the password used for auth.</li><li><strong>session</strong> : rules for session management. They typically run at the start or end of the session.</li></ul><p>And there are 6 common types of <code>control</code>:</p><ul><li><strong>required</strong> : if it fails, everything fails; if it passes, go to next.</li><li><strong>sufficient</strong> : if it passes, everything passes; if it fails, go to next.</li><li><strong>requisite</strong> : same as required- but stops on error.</li><li><strong>optional</strong> : pam ignores it (pass or fail); if this is the only module in stack then it decides if fail or pass.</li><li><strong>include</strong> : include rules from other pam files. if stack fails, return control to application.</li><li><strong>substack</strong> : works like include. but if the substack fails, return to the parent stack instead of giving control back to application.</li></ul><p>The <code>module</code> (and any parameters, if any) follows. By default, PAM will look for modules in the <code>/usr/lib64/security</code> directory, but you can prevent this behaviour by specifying the absolute path of the module. Some modules rely on external configuration files, which can be found in the <code>/etc/security</code> directory.</p><h3 id=few-common-modules>Few common modules<a hidden class=anchor aria-hidden=true href=#few-common-modules>#</a></h3><p>Before delving into the actual PAM rules files, we should first understand how a few of the most common modules behave. This will make interpreting the rules from the rules file much easier.</p><ul><li><code>pam_succeed_if.so</code></li></ul><p>This module is designed to succeed or fail auth based on the characterstics of the user trying to log in and the arguments passed to the module. If all the arguments passed to the module matches the characterstics of the user trying to log in, then and only then, this module returns success.</p><ul><li><code>pam_selinux.so</code></li></ul><p>This command sets the apropriate selinux security context. This can be used to set context when a session starts and restore it back.</p><ul><li><code>pam_permit.so</code></li></ul><p>This is the simplest of all. It just permits acess and does nothing else. With that said, you should consider this module very dangerous in wrong hands.</p><ul><li><code>pam_limits.so</code></li></ul><p>As its name suggests, this module sets the limits on the system resources for a user-session. Root user(uid=0) are also affected with this module.</p><p>There are many limits that can be configured, so there is a dedicated folder to host configuration files for it - <code>/etc/security/limits.d</code>. Alternatively, there is a <code>/etc/security/limits.conf</code> file. But its a good practice to have separate config files if possible.</p><ul><li><code>pam_pwquality.so</code></li></ul><p>This module was developed by RedHat. The only action of this module is to prompt the user for the password and check its strength. To check its strenght, the modules uses a dictionary (of weak password) to see it the entered password is part of it. If the password is not in the list, then that password is checked against a set of rules defined by admin.</p><p>These rules are configurable either by the use of module arguments or <code>/etc/security/pwquality.conf</code> config file.</p><ul><li><code>pam_rootok.so</code></li></ul><p>This rule authenticates the user if the real uid is 0. No questions asked!</p><p>If you don&rsquo;t know about what is a real and effective UID, read this <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p><ul><li><code>pam_faildelay.so</code></li></ul><p>This module sets the delay on failure. Like when a user types wron password, it fails and the next prompt is delayed by this module. If the delay is not given, then it will use <code>FAIL_DELAY</code> from <code>/etc/login.defs</code>.</p><ul><li><code>pam_unix.so</code></li></ul><p>This is the standard unix authnetication module. Usually it uses <code>/etc/passwd</code> and <code>/etc/shadow</code> (if shadow is enabled) to authenticate the user. There are many tasks that can be performed by this module like checking the expire or last change of the password.</p><p>The session component of this module logs when user logins or logs out of the system.</p><ul><li><code>pam_deny.so</code></li></ul><p>Just like <code>pam_permit.so</code>, this module is very simple and straightforward. This denies the access to everybody.</p><ul><li><code>pam_warn.so</code></li></ul><p>This module logs the service, terminal, user, or anything to syslog. This module always return <code>PAM_IGNORE</code>, so it just log events and have no participation in authentication process apart from that.</p><p>We&rsquo;re almost there now. Before we go any further, there are a few more things we should consider:</p><ul><li><p>PAM rules are parsed from top to bottom. If a <em>sufficient</em> rule is passed, then none of the below rules will be checked.</p></li><li><p>Some of the rules start with <code>-</code> character, indicating that PAM should ignore them silently if the module is missing.</p></li><li><p>If you want to know anything about a module, there is usually a man page available. The majority of the manpages for these modules provide examples of usage and return types.</p></li><li><p>Making changes to PAM files has immediate effect. You do not need to restart. As a result, it&rsquo;s a good idea to keep a backup of the files before making any changes.</p></li><li><p>Any error in the PAM files has the potential to log you out of your system permanently. Keeping a live root shell while testing is therefore beneficial. If you made a mistake, you can undo your changes using this shell.</p></li></ul><h2 id=usecases>Usecases<a hidden class=anchor aria-hidden=true href=#usecases>#</a></h2><h3 id=enforcing-strong-passwords>enforcing strong passwords<a hidden class=anchor aria-hidden=true href=#enforcing-strong-passwords>#</a></h3><p>Let&rsquo;s apply everything we&rsquo;ve learned so far to observe how PAM responds to password changes made with the <code>passwd</code> utility.</p><p>We now know that the <code>/etc/pam.d/passwd</code> file will be used by passwd (if it exists; else, <code>/etc/pam.d/other</code> will be read). This file will provide the procedures to be followed when sshd is used for any type of <a href=https://www.cloudflare.com/learning/access-management/authn-vs-authz/>authentication and authorization</a>.</p><p>This makes it obvious for us to go and checkout the <code>/etc/pam.d/passwd</code> file&mldr;</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ cat /etc/pam.d/passwd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#%PAM-1.0
</span></span><span class=line><span class=cl>auth       include	system-auth
</span></span><span class=line><span class=cl>account    include	system-auth
</span></span><span class=line><span class=cl>password   substack	system-auth
</span></span><span class=line><span class=cl>-password   optional	pam_gnome_keyring.so use_authtok
</span></span><span class=line><span class=cl>password   substack	postlogin
</span></span></code></pre></div><p>Analysing this file let us know that this module <strong>includes</strong> <code>system-auth</code> rules file. So we&rsquo;ll now inspect the rules mentioned in <code>/etc/pam.d/system-auth</code> file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ cat /etc/pam.d/system-auth
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#%PAM-1.0
</span></span><span class=line><span class=cl># This file is auto-generated.
</span></span><span class=line><span class=cl># User changes will be destroyed the next time authconfig is run.
</span></span><span class=line><span class=cl>auth        required      pam_env.so
</span></span><span class=line><span class=cl>auth        required      pam_faildelay.so delay=2000000
</span></span><span class=line><span class=cl>auth        sufficient    pam_unix.so nullok try_first_pass
</span></span><span class=line><span class=cl>auth        requisite     pam_succeed_if.so uid &gt;= 1000 quiet_success
</span></span><span class=line><span class=cl>auth        required      pam_deny.so
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>account     required      pam_unix.so
</span></span><span class=line><span class=cl>account     sufficient    pam_localuser.so
</span></span><span class=line><span class=cl>account     sufficient    pam_succeed_if.so uid &lt; 1000 quiet
</span></span><span class=line><span class=cl>account     required      pam_permit.so
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=
</span></span><span class=line><span class=cl>password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok
</span></span><span class=line><span class=cl>password    required      pam_deny.so
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>session     optional      pam_keyinit.so revoke
</span></span><span class=line><span class=cl>session     required      pam_limits.so
</span></span><span class=line><span class=cl>-session     optional      pam_systemd.so
</span></span><span class=line><span class=cl>session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid
</span></span><span class=line><span class=cl>session     required      pam_unix.so
</span></span></code></pre></div><p>Only the <code>password</code> <strong>type</strong> is relevant for our intended task out of all of these rules.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=
</span></span><span class=line><span class=cl>password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok
</span></span><span class=line><span class=cl>password    required      pam_deny.so
</span></span></code></pre></div><ul><li><code>requisite pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=</code></li></ul><p>This rule checks the quality of password using some predefined configuration that are mentioned in <code>/etc/security/pwquality.conf</code> or can be explicitely dictated via module arguments. The <code>try_first_pass</code> option tells to load the password from previous rule (if any), else this module will make prompt user for password. <code>local_users_only</code> option will tell <code>pam_pwquality.so</code> module to ignore the users that are not in the <code>/etc/passwd</code> file. <code>retry</code> option is the number of tries a user gets to pick an acceptable password before the module returns an error. By default, the prompt the user gets when entering their password is &ldquo;New password:&rdquo;. If the administrator sets <code>authtok_type=FOO</code>, the prompt becomes &ldquo;New FOO password:&rdquo;. Here the default behaviour will be expected.</p><ul><li><code>sufficient pam_unix.so sha512 shadow nullok try_first_pass use_authtok</code></li></ul><p>For pam_unix, the sha512 option means use a password hashing routine based on the SHA512 algorithm. blowfish is also supported along with several other, less secure, choices. The shadow option means maintain password hashes in a separate /etc/shadow file that is only readable by the root user. This option should always be set. nullok means allow user accounts that have null password entries. Personally, I would recommend removing this option.</p><ul><li><code>required pam_deny.so</code></li></ul><p>If the above modules failed, this should return with a deny message.</p><p>Now, say you want to enforce the following policy&mldr;</p><pre><code>- prompt 2 times for password in case of an error (retry option)
- 12 characters minimum length
- at least 6 characters should be different from old password when entering a new one (difok option)
- at least 1 digit (dcredit option)
- at least 1 uppercase (ucredit option)
- at least 1 lowercase (lcredit option)
- at least 1 other character (ocredit option)
- cannot contain the words &quot;qwerty&quot; and &quot;password&quot;
- enforce the policy for root as well.
</code></pre><p>&mldr; necessary changes that are needed to make are as below</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>password    requisite     pam_pwquality.so try_first_pass local_users_only retry=2 minlen=12 difok=6 dcredit=-1 ucredit=-1 ocredit=-1 lcredit=-1 [badwords=qwerty password] enforce_for_root
</span></span><span class=line><span class=cl>password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok
</span></span><span class=line><span class=cl>password    required      pam_deny.so
</span></span></code></pre></div><p>The changes to the <code>system-auth</code> file described above will affect all applications that rely on that rule file. If changes are made to the <code>passwd</code> file, they will only affect the <code>passwd</code> utility.</p><p>We can also use the <code>authconfig</code> utility to make nearly all of these changes without having to interact directly with the associated files.
More information can be found <a href=https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system-level_authentication_guide/authconfig-pwd#authconfig-pwd-cmd>here</a> . <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></p><h3 id=lock-out-at-multiple-failed-attempts>lock out at multiple failed attempts<a hidden class=anchor aria-hidden=true href=#lock-out-at-multiple-failed-attempts>#</a></h3><p>We can also use PAM to configure the system so that if a single user makes multiple failed attempts, the PAM will lock out that user for a set period of time. Similarly to how your mobile device locks out the user for the next few hours if multiple login attempts fail.</p><p>This is possible with the <code>pam faillock</code> module. Because there is no dedicated config file for this module, all configuration will be done through module arguments. You can either manually edit the rule files with your favourite text editor or use the authconfig utility to make changes.</p><p>Before you begin, you must determine whether or not <code>pam_faillock</code> is enabled.
This can be verified using</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>authconfig --test | grep pam_faillock
</span></span></code></pre></div><p>For me the default output was</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pam_faillock is disabled (deny=4 unlock_time=1200)
</span></span></code></pre></div><p>So I had to enable it via <code>authconfig --enablefaillock</code> and along with that you can pass module arguments via <code>authconfig --faillockargs=&lt;module_options></code> flag.</p><p>Or, one can combine both of the actions in a single command like</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>authconfig --enablefaillock --faillockargs=&#34;fail_interval=30 deny=3 unlock_time=3600&#34; --update
</span></span></code></pre></div><p>The above command will add <code>pam_faillock</code> rule in all of the relevant rules file (located in <code>/etc/pam.d/</code> directory). And the rest of the commands will configure the behaviour of the <code>pam_faillock</code> module. All of the module options can be checked with <code>man pam_faillock</code>.</p><p>Now the output of below command is slight different.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>authconfig --test | grep pam_faillock
</span></span></code></pre></div><p>Output:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pam_faillock is enabled (fail_interval=30 deny=3 unlock_time=3600)
</span></span></code></pre></div><p>You can list the failed login attempts with the <code>faillock</code> command.</p><h3 id=tty-auditing--cough--keylogging--cough>TTy auditing ( *cough* keylogging *cough*)<a hidden class=anchor aria-hidden=true href=#tty-auditing--cough--keylogging--cough>#</a></h3><p>Audit system (In Redhat or similar linux distros) uses <code>pam_tty_audit</code> PAM module for auditing of TTY input. When user logins, this module logs all keystrokes that user makes to <code>/var/log/audit/audit.log</code> file.</p><p>Since this depends on <code>auditd</code> service and requires that to be configured and running properly.</p><p>There is no <code>authconfig</code> flag that can enable this (atleast, there is none in centos 7.5), so we&rsquo;ll have to follow the traditional way of editing files manually to configure it.</p><p>This module only provides support for <strong>session</strong> type. That means we can only add <strong>session</strong> rules to our required files and it&rsquo;ll take effect immidiately for that service.</p><p>My idea is to add this rule in <code>/etc/pam.d/system-auth</code> and <code>/etc/pam.d/password-auth</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>session     required    pam_tty_audit.so  enable=*
</span></span></code></pre></div><p>The above rule will capture all of the tty inputs as it is and store them in <code>/var/log/audit/audit.log</code> file (by default). You can easily <code>grep</code> stuff from that or use a proper tool to query the logs&mldr; like <code>aureport</code>.</p><p><code>aureport --tty</code> command filters all <code>TYPE=tty</code> logs events from the file and display them in very human readable format.</p><h3 id=backdooring>backdooring<a hidden class=anchor aria-hidden=true href=#backdooring>#</a></h3><p>Till this point, we have learnt a lot about PAM and it is time to rethink on the basics once again. PAM has 3 components: <strong>user</strong>, <strong>password</strong> and <strong>service</strong>. It&rsquo;s role is to authenticate a <em>user</em> to a <em>service</em> with provided <em>password</em>.</p><p>It works elegantly with the help of some service files of same name as of the service itself. These files are located in <code>/etc/pam.d/</code> directory. Each file has one or more rules that helps PAM to take proper decisions.</p><p>There are a lot of methods with which we can backdoor the PAM system. One of the many ways is to use <code>pam_exec.so</code> module to run an arbitrary command at each PAM based event. Another way could be to add rule using <code>pam_permit.so</code> module, that will skip the required checks to authenticate user for that service.</p><p>The above techniques are very noisy and are easily detected. More sophesticated attacks would include replacing the original module with custom compiled infected module on target system&mldr; or function hooking via <code>LD_PRELOAD</code> technique.</p><p>I&rsquo;ll leave the practical part upto you. Please don&rsquo;t do anything stupid or unethical on production server or any other system without the owner&rsquo;s consent.</p><p>Keep it healthy and stay safe!!</p><h2 id=resources>Resources:<a hidden class=anchor aria-hidden=true href=#resources>#</a></h2><ul><li><a href=https://likegeeks.com/linux-pam-easy-guide/>https://likegeeks.com/linux-pam-easy-guide/</a></li><li><a href=https://aplawrence.com/Basics/understandingpam.html>https://aplawrence.com/Basics/understandingpam.html</a></li><li><a href=https://www.linux.com/news/understanding-pam/>https://www.linux.com/news/understanding-pam/</a></li><li><a href=https://developer.ibm.com/tutorials/l-pam/>https://developer.ibm.com/tutorials/l-pam/</a></li><li><a href=https://github.com/linux-pam/linux-pam>https://github.com/linux-pam/linux-pam</a> (Source code)</li><li><a href=https://wiki.archlinux.org/title/PAM#Examples>https://wiki.archlinux.org/title/PAM#Examples</a></li><li><a href=https://lwn.net/Articles/470764/>https://lwn.net/Articles/470764/</a> (A look at PAM face-recognition authentication)</li><li><a href=https://lwn.net/Articles/523199/>https://lwn.net/Articles/523199/</a> (Google Authenticator for multi-factor authentication)</li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://github.com/linux-pam/linux-pam/blob/b872b6e68a60ae351ca4c7eea6dfe95cd8f8d130/libpam/include/security/_pam_types.h#L29>https://github.com/linux-pam/linux-pam/blob/b872b6e68a60ae351ca4c7eea6dfe95cd8f8d130/libpam/include/security/_pam_types.h#L29</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>(<a href=https://stackoverflow.com/questions/32455684/difference-between-real-user-id-effective-user-id-and-saved-user-id>https://stackoverflow.com/questions/32455684/difference-between-real-user-id-effective-user-id-and-saved-user-id</a>)&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system-level_authentication_guide/authconfig-pwd#authconfig-pwd-cmd>https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system-level_authentication_guide/authconfig-pwd#authconfig-pwd-cmd</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://ayedaemon.github.io/tags/linux/>Linux</a></li><li><a href=https://ayedaemon.github.io/tags/security/>Security</a></li></ul><nav class=paginav><a class=prev href=https://ayedaemon.github.io/post/2023/03/intro-to-re-part-2/><span class=title>« Next</span><br><span>Intro to Re: C : part-2</span>
</a><a class=next href=https://ayedaemon.github.io/post/2022/12/recording_system_events_with_auditd/><span class=title>Prev »</span><br><span>Recording system events with auditd</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://ayedaemon.github.io/>Connected</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>