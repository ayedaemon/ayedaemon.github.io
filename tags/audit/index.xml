<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>audit on Connected</title>
    <link>https://ayedaemon.github.io/tags/audit/</link>
    <description>Recent content in audit on Connected</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Sun, 11 Dec 2022 21:15:13 +0530</lastBuildDate><atom:link href="https://ayedaemon.github.io/tags/audit/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Recording system events with auditd</title>
      <link>https://ayedaemon.github.io/post/2022/12/recording_system_events_with_auditd/</link>
      <pubDate>Sun, 11 Dec 2022 21:15:13 +0530</pubDate>
      
      <guid>https://ayedaemon.github.io/post/2022/12/recording_system_events_with_auditd/</guid>
      <description>auditing linux systems with auditd</description>
      <content:encoded><![CDATA[<p>Audits are critical for system administrators to detect security violations and track security-relevant information on their systems.
Anyone concerned about the security, stability, and proper operation of their Linux servers should conduct an audit.</p>
<h2 id="how-to-do-auditing-in-linux">How to do auditing in linux</h2>
<p>One simple way is to use the <code>history</code> command to observe the shell&rsquo;s history, but this has many limitations. One of them is that this command is only applicable to the current user. You can still get around this by reading the <code>.bash_history</code> file in each user&rsquo;s home directory (given you have permissions to do so).</p>
<h3 id="audit-framework-in-kernel">Audit framework in kernel.</h3>
<p>The Linux audit framework is a better option.
Because it operates at the kernel level, it has a lot of visibility over almost everything. The Linux kernel sends significant events to user-space (<code>auditd</code>) so that they can be recorded in a file. This file can then be analysed on the host system or sent to a remote location for storage and analysis.</p>
<h2 id="user-space-auditd">User-space auditd</h2>
<p>The majority of Linux distributions come with <code>auditd</code> preinstalled, which begins and stops with the system (as a systemd service file). Using below command, you may determine whether the kernel was built using the audit options.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">grep -i audit /boot/config-`uname -r`
</span></span></code></pre></div><p>On my system, it gives me below output (indicating kernel was built with auditing feature)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">CONFIG_AUDIT_ARCH=y
</span></span><span class="line"><span class="cl">CONFIG_AUDIT=y
</span></span><span class="line"><span class="cl">CONFIG_AUDITSYSCALL=y
</span></span><span class="line"><span class="cl">CONFIG_AUDIT_WATCH=y
</span></span><span class="line"><span class="cl">CONFIG_AUDIT_TREE=y
</span></span><span class="line"><span class="cl">CONFIG_NETFILTER_XT_TARGET_AUDIT=m
</span></span><span class="line"><span class="cl">CONFIG_IMA_AUDIT=y
</span></span><span class="line"><span class="cl">CONFIG_KVM_MMU_AUDIT=y
</span></span></code></pre></div><p>Second thing you would want to check if the kernel thread process responsible for sending data to user-space is running. Check that with the <code>ps</code> command.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sudo ps -aux | grep -i kauditd
</span></span></code></pre></div><p>This gives me below output (indicating that the thread is running)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">root       103  0.0  0.0      0     0 ?        S    11:39   0:00 [kauditd]
</span></span></code></pre></div><p>Final thing is to check the user-space service responsible to get the data from <code>kauditd</code>. To obtain definitive indications on systemd systems, use the commands listed below.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">systemctl is-active auditd          ## Returns: active/inactive
</span></span><span class="line"><span class="cl">systemctl is-enabled auditd         ## Returns: enabled/disabled
</span></span></code></pre></div><p><em>(<strong>Note</strong>: Feel free to check the source code at <a href="https://elixir.bootlin.com/linux/latest/source/kernel/audit.c"><code>kernel/audit.c</code></a>. <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>)</em></p>
<h3 id="configuring-auditd">Configuring auditd</h3>
<p><code>Auditd</code> decides what to log and what not to log using a set of rules. These rules can be found in the <code>/etc/audit/rules.d/</code> folder. Auditd reads files from this folder on startup and generates the <code>/etc/audit/audit.rules</code> file automatically. <strong>(This file should not be edited by hand.)</strong></p>
<p><code>auditd</code> comes with a configuration file too. This file helps in changing the behaviour of the userspace <code>auditd</code> daemon. Default file on my system looks like below.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="c1"># sudo cat -n /etc/audit/auditd.conf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="mi">1</span>	<span class="c1">#</span>
</span></span><span class="line"><span class="cl">     <span class="mi">2</span>	<span class="c1"># This file controls the configuration of the audit daemon</span>
</span></span><span class="line"><span class="cl">     <span class="mi">3</span>	<span class="c1">#</span>
</span></span><span class="line"><span class="cl">     <span class="mi">4</span>	
</span></span><span class="line"><span class="cl">     <span class="mi">5</span>	<span class="n">local_events</span> <span class="o">=</span> <span class="n">yes</span>
</span></span><span class="line"><span class="cl">     <span class="mi">6</span>	<span class="n">write_logs</span> <span class="o">=</span> <span class="n">yes</span>
</span></span><span class="line"><span class="cl">     <span class="mi">7</span>	<span class="n">log_file</span> <span class="o">=</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">audit</span><span class="o">/</span><span class="n">audit</span><span class="o">.</span><span class="n">log</span>
</span></span><span class="line"><span class="cl">     <span class="mi">8</span>	<span class="n">log_group</span> <span class="o">=</span> <span class="n">root</span>
</span></span><span class="line"><span class="cl">     <span class="mi">9</span>	<span class="n">log_format</span> <span class="o">=</span> <span class="n">RAW</span>
</span></span><span class="line"><span class="cl">    <span class="mi">10</span>	<span class="n">flush</span> <span class="o">=</span> <span class="n">INCREMENTAL_ASYNC</span>
</span></span><span class="line"><span class="cl">    <span class="mi">11</span>	<span class="n">freq</span> <span class="o">=</span> <span class="mi">50</span>
</span></span><span class="line"><span class="cl">    <span class="mi">12</span>	<span class="n">max_log_file</span> <span class="o">=</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">    <span class="mi">13</span>	<span class="n">num_logs</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">    <span class="mi">14</span>	<span class="n">priority_boost</span> <span class="o">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="mi">15</span>	<span class="n">disp_qos</span> <span class="o">=</span> <span class="n">lossy</span>
</span></span><span class="line"><span class="cl">    <span class="mi">16</span>	<span class="n">dispatcher</span> <span class="o">=</span> <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">audispd</span>
</span></span><span class="line"><span class="cl">    <span class="mi">17</span>	<span class="n">name_format</span> <span class="o">=</span> <span class="n">NONE</span>
</span></span><span class="line"><span class="cl">    <span class="mi">18</span>	<span class="c1">##name = mydomain</span>
</span></span><span class="line"><span class="cl">    <span class="mi">19</span>	<span class="n">max_log_file_action</span> <span class="o">=</span> <span class="n">ROTATE</span>
</span></span><span class="line"><span class="cl">    <span class="mi">20</span>	<span class="n">space_left</span> <span class="o">=</span> <span class="mi">75</span>
</span></span><span class="line"><span class="cl">    <span class="mi">21</span>	<span class="n">space_left_action</span> <span class="o">=</span> <span class="n">SYSLOG</span>
</span></span><span class="line"><span class="cl">    <span class="mi">22</span>	<span class="n">verify_email</span> <span class="o">=</span> <span class="n">yes</span>
</span></span><span class="line"><span class="cl">    <span class="mi">23</span>	<span class="n">action_mail_acct</span> <span class="o">=</span> <span class="n">root</span>
</span></span><span class="line"><span class="cl">    <span class="mi">24</span>	<span class="n">admin_space_left</span> <span class="o">=</span> <span class="mi">50</span>
</span></span><span class="line"><span class="cl">    <span class="mi">25</span>	<span class="n">admin_space_left_action</span> <span class="o">=</span> <span class="n">SUSPEND</span>
</span></span><span class="line"><span class="cl">    <span class="mi">26</span>	<span class="n">disk_full_action</span> <span class="o">=</span> <span class="n">SUSPEND</span>
</span></span><span class="line"><span class="cl">    <span class="mi">27</span>	<span class="n">disk_error_action</span> <span class="o">=</span> <span class="n">SUSPEND</span>
</span></span><span class="line"><span class="cl">    <span class="mi">28</span>	<span class="n">use_libwrap</span> <span class="o">=</span> <span class="n">yes</span>
</span></span><span class="line"><span class="cl">    <span class="mi">29</span>	<span class="c1">##tcp_listen_port = 60</span>
</span></span><span class="line"><span class="cl">    <span class="mi">30</span>	<span class="n">tcp_listen_queue</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">    <span class="mi">31</span>	<span class="n">tcp_max_per_addr</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="mi">32</span>	<span class="c1">##tcp_client_ports = 1024-65535</span>
</span></span><span class="line"><span class="cl">    <span class="mi">33</span>	<span class="n">tcp_client_max_idle</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="mi">34</span>	<span class="n">enable_krb5</span> <span class="o">=</span> <span class="n">no</span>
</span></span><span class="line"><span class="cl">    <span class="mi">35</span>	<span class="n">krb5_principal</span> <span class="o">=</span> <span class="n">auditd</span>
</span></span><span class="line"><span class="cl">    <span class="mi">36</span>	<span class="c1">##krb5_key_file = /etc/audit/audit.key</span>
</span></span><span class="line"><span class="cl">    <span class="mi">37</span>	<span class="n">distribute_network</span> <span class="o">=</span> <span class="n">no</span>
</span></span></code></pre></div><p>Some of these options are easy to understand, like:</p>
<ul>
<li><strong>log_file</strong> : Tells the location of the audit log file.</li>
<li><strong>max_log_file</strong> : Defines the size of the log file in MB. If the size is reached, <strong>max_log_file_action</strong> is triggered.</li>
<li><strong>space_left</strong> : Triggers the <strong>space_left_action</strong> when the limit is reached.</li>
<li>To include additional information in audit logs you need to change <code>log format</code> from <strong>RAW</strong> to <code>ENRICHED</code>.</li>
<li><code>FLUSH = INCREMENTAL_ASYNC</code> will write the logs async instead of writing them on every write.</li>
</ul>
<p>While some of them needs more detailed explaination. In any case, always refer the man pages &ndash;&gt; <a href="https://www.man7.org/linux/man-pages/man5/auditd.conf.5.html"><code>man (5) auditd.conf</code></a> <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>. There you will find all the possible options and their supporting values to tune auditd as per your requirements.</p>
<p>After making changes to <code>auditd.conf</code>, restart the service to pick up new changes from config. My <code>centos 7</code> machine did not allow me to manually restart the service using <code>systemctl</code> but it worked just fine with <code>service auditd restart</code>. If you figure out why this happens, please let me know!</p>
<h3 id="inspecting-audit-logs">Inspecting audit logs</h3>
<p>We can see where the <code>auditd</code> logs are stored from the config file above. So we can always look through the log files and use the good old <code>grep</code> command to find what we&rsquo;re looking for.</p>
<p>But that is not the intended method. The <code>audit</code> package includes a number of helper commands to assist the sysadmin/analyst in quickly determining information from logs.</p>
<p>Below are all the binary executable files provided by the <code>audit</code> package&hellip;.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## COMMAND:   rpm -ql audit | grep bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/sbin/audispd
</span></span><span class="line"><span class="cl">/sbin/auditctl
</span></span><span class="line"><span class="cl">/sbin/auditd
</span></span><span class="line"><span class="cl">/sbin/augenrules
</span></span><span class="line"><span class="cl">/sbin/aureport
</span></span><span class="line"><span class="cl">/sbin/ausearch
</span></span><span class="line"><span class="cl">/sbin/autrace
</span></span><span class="line"><span class="cl">/usr/bin/aulast
</span></span><span class="line"><span class="cl">/usr/bin/aulastlog
</span></span><span class="line"><span class="cl">/usr/bin/ausyscall
</span></span><span class="line"><span class="cl">/usr/bin/auvirt
</span></span></code></pre></div><p>Let&rsquo;s start with <code>ausearch</code> for now. This program parses the audit log files and gives the information based on passed keywords.</p>
<p>There are a lot of options for this tool.. I&rsquo;ll mention few which I use most often.</p>
<ul>
<li><strong><code>-i</code></strong> &ndash; Interpret the logs. Translates numeric value in names.</li>
<li>If you want to get raw logs, use <strong><code>-r</code></strong>.</li>
<li>use <strong><code>-x</code></strong> to search based on executable name.</li>
<li>If you know the event ID then search with <strong><code>-a</code></strong>.</li>
<li>To search with message type, use <strong><code>-m</code></strong>. You can get the message type list by passing nothing or a wrong message type with the argument/flag.</li>
<li>Use <strong><code>-k</code></strong> to search for specific key in log. You can configure your own key in the logs config. These keys helps to corelate the logs with the rules.</li>
</ul>
<p>If you just want to get a report of everything that was logged, you can use <code>aureport</code> program which gives you a proper summary in a tabular form.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## COMMAND:   sudo aureport
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Summary Report
</span></span><span class="line"><span class="cl">======================
</span></span><span class="line"><span class="cl">Range of time in logs: 01/01/1970 00:00:00.000 - 12/10/2022 16:24:29.088
</span></span><span class="line"><span class="cl">Selected time for report: 01/01/1970 00:00:00 - 12/10/2022 16:24:29.088
</span></span><span class="line"><span class="cl">Number of changes in configuration: 2
</span></span><span class="line"><span class="cl">Number of changes to accounts, groups, or roles: 0
</span></span><span class="line"><span class="cl">Number of logins: 0
</span></span><span class="line"><span class="cl">Number of failed logins: 0
</span></span><span class="line"><span class="cl">Number of authentications: 0
</span></span><span class="line"><span class="cl">Number of failed authentications: 0
</span></span><span class="line"><span class="cl">Number of users: 3
</span></span><span class="line"><span class="cl">Number of terminals: 4
</span></span><span class="line"><span class="cl">Number of host names: 1
</span></span><span class="line"><span class="cl">Number of executables: 3
</span></span><span class="line"><span class="cl">Number of commands: 1
</span></span><span class="line"><span class="cl">Number of files: 0
</span></span><span class="line"><span class="cl">Number of AVC&#39;s: 0
</span></span><span class="line"><span class="cl">Number of MAC events: 0
</span></span><span class="line"><span class="cl">Number of failed syscalls: 0
</span></span><span class="line"><span class="cl">Number of anomaly events: 0
</span></span><span class="line"><span class="cl">Number of responses to anomaly events: 0
</span></span><span class="line"><span class="cl">Number of crypto events: 0
</span></span><span class="line"><span class="cl">Number of integrity events: 0
</span></span><span class="line"><span class="cl">Number of virt events: 0
</span></span><span class="line"><span class="cl">Number of keys: 0
</span></span><span class="line"><span class="cl">Number of process IDs: 42
</span></span><span class="line"><span class="cl">Number of events: 240
</span></span></code></pre></div><h3 id="writing-custom-audit-rules">Writing custom audit rules</h3>
<p><code>auditd</code> also allows us to write our own rules. These rules will be read and applied when the service is restarted&hellip; or if you invoke <code>augenrules --load</code>.</p>
<p>For auditing, there are only three types of rules that can be defined:</p>
<ol>
<li>
<p>Watches on the file system (watches the changes related to filesystem or on a particular path)</p>
</li>
<li>
<p>syscalls (checks if a specific syscall was executed and with what context)</p>
</li>
<li>
<p>control rules (these are used to modify the kernel configuration of linux audit)</p>
</li>
</ol>
<p>That&rsquo;s all. This was all we needed to know before we started writing our first simple rule.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-w /etc/
</span></span></code></pre></div><p>The above rule will watch for all kinds of changes in <code>/etc/</code> folder&hellip; that means any (r)ead, (w)rite, (e)xecute or (a)ttribute change operations will be logged.</p>
<p>Let&rsquo;s write the above rule in a new file: <code>/etc/audit/rules.d/myrules.rules</code>&hellip; And check if it is picked up by auditd already. (I know it will not be picked, but it won&rsquo;t hurt to check)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># sudo auditctl -l
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">No rules
</span></span></code></pre></div><p>Now, let&rsquo;s restart the service and try that again.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># service auditd restart
</span></span><span class="line"><span class="cl"># sudo auditctl -l
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-w /etc -p rwxa
</span></span></code></pre></div><p><code>auditd</code> has now loaded the rule, as expected. But there&rsquo;s more to it than just what we put in the file. It makes no difference, however, because it is implicitly adding <code>-p rwxa</code> to indicate that all of these operations should be monitored.</p>
<p>The files still contain what we added&hellip; but the kernel has fully expanded rules.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># sudo cat /etc/audit/rules.d/myrules.rules
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-w /etc/
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># sudo cat /etc/audit/audit.rules
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## This file is automatically generated from /etc/audit/rules.d
</span></span><span class="line"><span class="cl">-D
</span></span><span class="line"><span class="cl">-b 8192
</span></span><span class="line"><span class="cl">-f 1
</span></span><span class="line"><span class="cl">-w /etc/
</span></span></code></pre></div><p>With this rule in the kernel, all the operations made to <code>/etc</code> path will be recorded. To make things easy, think of all the <strong>watch</strong> rules as just fancy wrappers for syscall rules. Above rule can be written as below, and will still work the same.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-a exit,always  -F dir=/etc -F perm=rwxa
</span></span></code></pre></div><p>Remove the previous rule and add the above rule to the same file. Restart the service again for the changes to take effect.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo cat /etc/audit/audit.rules
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## This file is automatically generated from /etc/audit/rules.d</span>
</span></span><span class="line"><span class="cl">-D
</span></span><span class="line"><span class="cl">-b <span class="m">8192</span>
</span></span><span class="line"><span class="cl">-f <span class="m">1</span>
</span></span><span class="line"><span class="cl">-a exit,always  -F <span class="nv">dir</span><span class="o">=</span>/etc -F <span class="nv">perm</span><span class="o">=</span>rwxa
</span></span></code></pre></div><p>Auto-generated event is what we wrote in the file. Let&rsquo;s take a look what it looks like from kernel point of view.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ sudo auditctl -l
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-w /etc -p rwxa
</span></span></code></pre></div><p>Told you, its practically the same. Now let&rsquo;s understand all the options in the new rule we wrote (obviously for better clarity on how it is same).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-a exit,always  -F dir=/etc -F perm=rwxa
</span></span></code></pre></div><ul>
<li><code>-a</code> : append rule to end of the list</li>
<li><code>exit,always</code> : always log when exiting a syscall.</li>
<li><code>-F</code> : build a rule based on (F)ield values</li>
<li><code>dir=/etc</code>: full path of directory to watch; watches recursively to whole subtrees.</li>
<li><code>perm=rwxa</code>: permission changes/access to monitor.</li>
</ul>
<p>According to <code>man 8 auditctl</code>, <strong>if  a field rule is given and no syscall is specified, it will default to all syscalls.</strong> That means the above rule will work for all of the syscalls.</p>
<p>So far so good. Now what about control rules?? ..Or let&rsquo;s say <em>configure</em> rules as they help in configuring the behaviour of auditd itself.</p>
<p>These rules help in configuring/controling the behaviour of auditd. Read the man page for better and complete explanation. But I&rsquo;ll walk you through the ones we have already seen&hellip;. in the <code>/etc/audit/audit.rules</code> file.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-D
</span></span><span class="line"><span class="cl">-b 8192
</span></span><span class="line"><span class="cl">-f 1
</span></span></code></pre></div><ul>
<li>
<p><code>-D</code> deletes all the previous rules from kernel rules list. This should be always on the top If you want to give someone a hard time, just put that in the end.(<strong>please don&rsquo;t do it on production machines, it won&rsquo;t be funny</strong>)</p>
</li>
<li>
<p><code>-b</code> sets the size for audit buffer. If you don&rsquo;t know what you are doing, leave it to the default.</p>
</li>
<li>
<p><code>-f</code> sets the failure mode that let&rsquo;s the kernel decide how to handle failures and critical errors. 0 is silent. Default is 1 (printk). Super secured environment should be using 2 (panic).</p>
</li>
</ul>
<h3 id="pre-packaged-audit-rules">Pre-packaged audit rules</h3>
<p>Most of the times, we don&rsquo;t really need to write our own audit rules, we can just use what other people have already worked upon. You can always find them with the help of your favorite search engine&hellip;but there are few already pre-packaged with <code>audit</code> and are already on your system (if you have installed the package)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">$</span> <span class="n">rpm</span> <span class="o">-</span><span class="n">ql</span> <span class="n">audit</span> <span class="o">|</span> <span class="n">grep</span> <span class="s1">&#39;/usr/share/.*\.rules$&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="n">base</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">audit</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">11</span><span class="o">-</span><span class="n">loginuid</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">12</span><span class="o">-</span><span class="n">cont</span><span class="o">-</span><span class="n">fail</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">12</span><span class="o">-</span><span class="n">ignore</span><span class="o">-</span><span class="n">error</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">20</span><span class="o">-</span><span class="n">dont</span><span class="o">-</span><span class="n">audit</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">21</span><span class="o">-</span><span class="n">no32bit</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">22</span><span class="o">-</span><span class="n">ignore</span><span class="o">-</span><span class="n">chrony</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">23</span><span class="o">-</span><span class="n">ignore</span><span class="o">-</span><span class="n">filesystems</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">30</span><span class="o">-</span><span class="n">nispom</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">30</span><span class="o">-</span><span class="n">ospp</span><span class="o">-</span><span class="n">v42</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">30</span><span class="o">-</span><span class="n">pci</span><span class="o">-</span><span class="n">dss</span><span class="o">-</span><span class="n">v31</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">30</span><span class="o">-</span><span class="n">stig</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">31</span><span class="o">-</span><span class="n">privileged</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">32</span><span class="o">-</span><span class="n">power</span><span class="o">-</span><span class="n">abuse</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">40</span><span class="o">-</span><span class="n">local</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">41</span><span class="o">-</span><span class="n">containers</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">42</span><span class="o">-</span><span class="n">injection</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">43</span><span class="o">-</span><span class="n">module</span><span class="o">-</span><span class="nb">load</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">70</span><span class="o">-</span><span class="n">einval</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">71</span><span class="o">-</span><span class="n">networking</span><span class="o">.</span><span class="n">rules</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">audit</span><span class="o">-</span><span class="mf">2.8</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="mi">99</span><span class="o">-</span><span class="n">finalize</span><span class="o">.</span><span class="n">rules</span>
</span></span></code></pre></div><p><em>( <strong>NOTE:</strong> The numbers in the filenames play a very important role. For auditd, the first rule found wins. So if there are 2 contradictory rules, the first one found will be applied and the second one will have no effect.)</em></p>
<p>You can copy these rules, or just the ones you want to monitor, to <code>/etc/audit/rules.d/</code> folder and restart the service to pick up the new rules. Or you can use <code>augenrules --load</code> to load them without restarting the service.</p>
<h3 id="hardening-the-audit">Hardening the audit</h3>
<p>First step to harden the audit will be to ensude auditd&rsquo;s configuration is immutable. This can be done with <code>-e 2</code> control rule. Enabling this will prevent further changes in auditd&rsquo;s configurations. This being said, it is very obvious that this should be the last rule in the list.</p>
<p>Next step would be to store the logs into a centralized secure location. <code>Auditd</code> comes with a dispatcher program (<code>auditspd</code>) that can work with <code>auditsp-remote</code> plugin. This program too comes with it&rsquo;s own configuration file, which can be found at <code>/etc/audisp/audisp-remote.conf</code>.</p>
<p><em>This package was not already installed on my system so I installed it with <code>sudo yum install -y audispd-plugins</code>. Once this is installed, <code>auditsp-remote.conf</code> will be there witing for you to edit.</em></p>
<p>There are a few configuration changes you&rsquo;ll need to make to ensure that logs are sent to the remote server. The overall concept is to collect logs using auditd, then use a plugin to send logs to a central server while also disabling local logging of the same logs. This way, we won&rsquo;t have logs on the local system (saving disk space), and we can aggregate logs from multiple servers for analysis.</p>
<p>Let&rsquo;s start it with one change at a time. First one will be to enable the remote logging plugin. To do that, we can make changes to <code>/etc/audisp/plugins.d/au-remote.conf</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## CHANGE active status to yes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">active=yes
</span></span></code></pre></div><p>Then let our audit dispatcher know about the remote server where we want to dispatch the logs. This change will be made to <code>/etc/audisp/audisp-remote.conf</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## Remote server name/IP and the port
</span></span><span class="line"><span class="cl">remote_server = 192.168.56.10
</span></span><span class="line"><span class="cl">port = 60
</span></span></code></pre></div><p><em>As a dirty trick, I&rsquo;ve started netcat on port 60 to listen to the incoming data from the host.</em></p>
<p>Last thing is to disable the local logging for <code>auditd</code>. For that, make changes to <code>/etc/audit/auditd.conf</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## CHANGE write logs to no
</span></span><span class="line"><span class="cl">write_logs = no
</span></span></code></pre></div><p>With this done, you have everything configured and ready to test. Now restart the <strong>auditd</strong> service and you&rsquo;ll start getting logs in netcat screen on remote system.</p>
<h2 id="wrap-up">Wrap-up</h2>
<p>In this article, you learnt about how to do better auditing of your linux environment, with the help of <code>auditd</code>. You also learnt about how to write your own rules or get pre-packaged rules to generate specific audit logs&hellip; and ways to get required reports with the help of <code>ausearch</code> and <code>aureport</code> programs.</p>
<p>This article is not intended to be a complete guide for auditing. It&rsquo;s whole purpose is to get you started with the idea of auditing and using the <code>audit</code> package utilities.</p>
<p>If you want to learn more about it, I suggest you to play around and read <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/chap-system_auditing">RedHat&rsquo;s documentation on system auditing</a> <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>. And if you are stuck, use your favorite search engine or&hellip; RTFM.</p>
<p><img loading="lazy" src="https://media.giphy.com/media/8dYmJ6Buo3lYY/giphy.gif#center" alt=""  />
</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://elixir.bootlin.com/linux/latest/source/kernel/audit.c">https://elixir.bootlin.com/linux/latest/source/kernel/audit.c</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://www.man7.org/linux/man-pages/man5/auditd.conf.5.html">https://www.man7.org/linux/man-pages/man5/auditd.conf.5.html</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/chap-system_auditing">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/chap-system_auditing</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
